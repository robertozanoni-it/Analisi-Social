<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Analizza i tuoi post social con AI: metriche reali, heatmap attenzione, palette colori e report DOCX professionale gratuito.">
<meta name="author" content="Roberto Zanoni">
<meta name="robots" content="index, follow">
<title>SocialStrategist AI ‚Ä¢ Analisi Post con Report Professionale</title>
<meta property="og:title" content="SocialStrategist AI - Analisi Post Social">
<meta property="og:description" content="Analizza i tuoi post social con metriche reali e scarica un report DOCX professionale.">
<meta property="og:type" content="website">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@400;700;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--accent:#8b5cf6;--accent-light:#a78bfa;--secondary:#ec4899;--bg:#050505;--glass:rgba(20,20,20,0.8);--border:rgba(255,255,255,0.08);--green:#10b981;--amber:#f59e0b;--red:#ef4444;--blue:#3b82f6}
html{font-size:16px;-webkit-font-smoothing:antialiased;scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--bg);color:#fff;line-height:1.6;min-height:100vh}
h1,h2,h3,.font-outfit{font-family:'Outfit',sans-serif}

/* === LAYOUT === */
.swa-container{max-width:1200px;margin:0 auto;padding:0 24px}
.glass{background:var(--glass);backdrop-filter:blur(15px);border:1px solid var(--border)}
.gradient-text{background:linear-gradient(135deg,#a78bfa,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

/* === HEADER === */
.swa-header{position:sticky;top:0;z-index:50;background:rgba(5,5,5,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:16px 0}
.swa-header-inner{display:flex;justify-content:space-between;align-items:center}
.swa-logo{display:flex;align-items:center;gap:12px}
.swa-logo-icon{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#ec4899);display:flex;align-items:center;justify-content:center;font-size:18px}
.swa-logo-text h1{font-size:1.2rem;font-weight:900;letter-spacing:-0.02em}
.swa-logo-text h1 span{color:var(--accent-light)}
.swa-logo-text p{font-size:0.6rem;font-weight:700;color:rgba(255,255,255,0.35);letter-spacing:0.2em;text-transform:uppercase}
.swa-nav-btn{font-size:0.75rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:rgba(255,255,255,0.4);background:none;border:none;cursor:pointer;padding:8px 16px;border-radius:8px;transition:all 0.2s}
.swa-nav-btn:hover{color:#fff;background:rgba(255,255,255,0.05)}

/* === WELCOME SECTION === */
.swa-welcome{padding:60px 0;text-align:center}
.swa-hero-title{font-size:clamp(2.5rem,6vw,4.5rem);font-weight:900;line-height:1.05;margin-bottom:20px}
.swa-hero-sub{color:rgba(255,255,255,0.5);font-size:1.1rem;max-width:600px;margin:0 auto 48px}
.swa-step-title{font-size:1.4rem;font-weight:700;margin-bottom:20px}
.swa-step-num{display:inline-block;width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;font-size:0.85rem;font-weight:800;line-height:32px;text-align:center;margin-right:8px}

/* === PLATFORM BUTTONS === */
.swa-platforms{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-bottom:48px}
.swa-plat-btn{padding:12px 22px;border:2px solid rgba(255,255,255,0.1);border-radius:16px;background:rgba(30,41,59,0.6);color:#fff;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}
.swa-plat-btn:hover{border-color:rgba(139,92,246,0.4);background:rgba(30,41,59,0.9)}
.swa-plat-btn.active{border-color:var(--accent);background:rgba(139,92,246,0.2);box-shadow:0 8px 24px rgba(139,92,246,0.2);transform:translateY(-2px)}
.swa-plat-btn i{font-size:1.2rem}

/* === GOAL & TARGET === */
.swa-config-grid{max-width:800px;margin:0 auto 48px;display:grid;grid-template-columns:1fr;gap:20px}
@media(min-width:768px){.swa-config-grid{grid-template-columns:1fr 1fr}}
.swa-config-card{padding:24px;border-radius:20px}
.swa-config-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;font-size:1.1rem}
.swa-config-icon.goal{background:rgba(59,130,246,0.15);color:var(--blue)}
.swa-config-icon.target{background:rgba(56,189,248,0.15);color:#38bdf8}
.swa-config-card h3{font-size:1.1rem;font-weight:700;margin-bottom:4px;text-align:left}
.swa-config-card .swa-hint{font-size:0.85rem;color:rgba(255,255,255,0.45);margin-bottom:14px;text-align:left}
.swa-select{appearance:none;background:rgba(30,41,59,0.7) url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2394a3b8' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 12px center/20px;border:1px solid rgba(255,255,255,0.1);color:#fff;padding:12px 40px 12px 16px;border-radius:14px;width:100%;font-family:inherit;font-size:0.95rem;cursor:pointer;transition:all 0.2s}
.swa-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,0.2)}
.swa-textarea{background:rgba(30,41,59,0.7);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:12px 16px;border-radius:14px;width:100%;font-family:inherit;font-size:0.95rem;resize:vertical;min-height:90px;transition:all 0.2s;line-height:1.5}
.swa-textarea::placeholder{color:rgba(255,255,255,0.35)}
.swa-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,0.2)}

/* === DROPZONE === */
.swa-dropzone{max-width:600px;margin:0 auto 40px;border-radius:2rem;padding:48px 24px;border:2px dashed rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s}
.swa-dropzone:hover,.swa-dropzone.dragover{border-color:rgba(139,92,246,0.5);background:rgba(139,92,246,0.03)}
.swa-dropzone-icon{width:64px;height:64px;border-radius:50%;background:rgba(139,92,246,0.1);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.8rem;color:var(--accent-light);transition:transform 0.3s}
.swa-dropzone:hover .swa-dropzone-icon{transform:scale(1.1)}
.swa-preview{max-width:600px;margin:0 auto 32px}
.swa-preview img{max-width:100%;max-height:300px;border-radius:16px;border:1px solid var(--border);display:block;margin:0 auto}

/* === ANALYZE BUTTON === */
.swa-analyze-btn{background:linear-gradient(135deg,var(--accent),var(--secondary));color:#fff;border:none;padding:16px 40px;font-size:1.1rem;font-weight:800;border-radius:24px;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(139,92,246,0.3)}
.swa-analyze-btn:hover{transform:translateY(-3px);box-shadow:0 14px 40px rgba(139,92,246,0.4)}
.swa-analyze-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}

/* === VALIDATION ERROR === */
.swa-error{color:var(--red);background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);border-radius:12px;padding:12px 16px;margin:16px auto;font-size:0.9rem;display:flex;align-items:center;gap:10px;max-width:500px}

/* === LOADER === */
.swa-loader-section{padding:100px 0;text-align:center}
.swa-spinner{width:44px;height:44px;border:3px solid rgba(139,92,246,0.15);border-top-color:var(--accent);border-radius:50%;animation:swa-spin 0.7s linear infinite;margin:0 auto 24px}
@keyframes swa-spin{to{transform:rotate(360deg)}}
.swa-loader-text{font-size:0.75rem;font-weight:800;text-transform:uppercase;letter-spacing:0.3em;color:var(--accent);margin-bottom:8px}
.swa-loader-sub{color:rgba(255,255,255,0.4);font-size:0.85rem}
.swa-loader-steps{max-width:400px;margin:24px auto 0;text-align:left}
.swa-loader-step{display:flex;align-items:center;gap:10px;padding:8px 0;color:rgba(255,255,255,0.3);font-size:0.85rem;transition:all 0.3s}
.swa-loader-step.active{color:var(--accent-light)}
.swa-loader-step.done{color:var(--green)}
.swa-loader-step i{width:20px;text-align:center}

/* === DASHBOARD === */
.swa-dashboard{padding-bottom:60px}
.swa-context-bar{background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.2);border-radius:20px;padding:20px 24px;margin-bottom:32px;display:flex;flex-wrap:wrap;gap:24px;align-items:center}
.swa-context-item label{font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);display:flex;align-items:center;gap:6px;margin-bottom:4px}
.swa-context-item .value{font-size:1rem;font-weight:700}
.swa-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:0.75rem;font-weight:700;letter-spacing:0.03em}
.swa-badge-instagram{background:linear-gradient(45deg,#405de6,#833ab4,#c13584,#e1306c);color:#fff}
.swa-badge-tiktok{background:#000;color:#fff;border:1px solid #fff}
.swa-badge-linkedin{background:#0a66c2;color:#fff}
.swa-badge-facebook{background:#1877f2;color:#fff}
.swa-badge-web{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff}
.swa-badge-sales{background:linear-gradient(45deg,#ef4444,#f97316);color:#fff}
.swa-badge-awareness{background:linear-gradient(45deg,#3b82f6,#8b5cf6);color:#fff}
.swa-badge-engagement{background:linear-gradient(45deg,#10b981,#14b8a6);color:#fff}
.swa-badge-leads{background:linear-gradient(45deg,#a855f7,#d946ef);color:#fff}
.swa-badge-traffic{background:linear-gradient(45deg,#f59e0b,#eab308);color:#fff}

/* === OVERALL SCORE === */
.swa-overall{text-align:center;margin-bottom:40px}
.swa-overall-ring{width:160px;height:160px;margin:0 auto 16px;position:relative}
.swa-overall-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.swa-overall-ring .bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:10}
.swa-overall-ring .fg{fill:none;stroke:url(#scoreGrad);stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease}
.swa-overall-value{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900;font-family:'Outfit',sans-serif}
.swa-overall-label{font-size:0.85rem;color:rgba(255,255,255,0.5);font-weight:600}

/* === SCORE CARDS === */
.swa-scores-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:40px}
@media(max-width:900px){.swa-scores-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:600px){.swa-scores-grid{grid-template-columns:repeat(2,1fr)}}
.swa-score-card{padding:20px;border-radius:20px;transition:all 0.3s;position:relative;overflow:hidden}
.swa-score-card:hover{transform:translateY(-4px);border-color:rgba(139,92,246,0.3)}
.swa-score-label{font-size:0.65rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:rgba(255,255,255,0.4);margin-bottom:8px}
.swa-score-value{font-size:2rem;font-weight:900;font-family:'Outfit',sans-serif;margin-bottom:4px}
.swa-score-method{font-size:0.7rem;color:var(--accent);font-weight:600;display:flex;align-items:center;gap:4px}
.swa-score-bar{height:4px;border-radius:2px;background:rgba(255,255,255,0.06);margin-top:10px;overflow:hidden}
.swa-score-bar-fill{height:100%;border-radius:2px;transition:width 1.2s ease;width:0}
.swa-real-badge{position:absolute;top:10px;right:10px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.4);color:var(--accent);font-size:0.6rem;font-weight:800;padding:2px 7px;border-radius:12px;letter-spacing:0.05em}

/* === VISUAL ANALYSIS === */
.swa-visual-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:40px}
@media(max-width:768px){.swa-visual-grid{grid-template-columns:1fr}}
.swa-visual-card{padding:24px;border-radius:24px}
.swa-visual-card h3{font-size:1.1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.swa-heatmap-container{position:relative;display:inline-block;border-radius:12px;overflow:hidden;max-width:100%}
.swa-heatmap-container canvas{max-width:100%;height:auto;display:block}
.swa-palette{display:flex;gap:8px;flex-wrap:wrap}
.swa-color-swatch{display:flex;flex-direction:column;align-items:center;gap:6px}
.swa-color-circle{width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);cursor:pointer;transition:transform 0.2s}
.swa-color-circle:hover{transform:scale(1.15)}
.swa-color-hex{font-size:0.7rem;font-weight:600;color:rgba(255,255,255,0.6);font-family:monospace}
.swa-color-pct{font-size:0.65rem;color:rgba(255,255,255,0.35)}

/* === RECOMMENDATIONS === */
.swa-recs{margin-bottom:40px}
.swa-recs h3{font-size:1.3rem;font-weight:700;margin-bottom:20px}
.swa-rec-card{padding:20px;border-radius:16px;margin-bottom:12px;border-left:4px solid transparent;transition:all 0.3s}
.swa-rec-card:hover{background:rgba(255,255,255,0.03)}
.swa-rec-card.priority-high{border-left-color:var(--red)}
.swa-rec-card.priority-medium{border-left-color:var(--amber)}
.swa-rec-card.priority-low{border-left-color:var(--green)}
.swa-rec-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.swa-rec-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:800;color:#fff;flex-shrink:0}
.swa-rec-num.high{background:var(--red)}
.swa-rec-num.medium{background:var(--amber)}
.swa-rec-num.low{background:var(--green)}
.swa-rec-title{font-weight:700;font-size:1rem}
.swa-rec-body{font-size:0.9rem;color:rgba(255,255,255,0.7);line-height:1.6}
.swa-rec-impact{display:inline-block;margin-top:8px;padding:3px 10px;border-radius:8px;font-size:0.75rem;font-weight:700;background:rgba(16,185,129,0.1);color:var(--green)}

/* === METRICS TABLE === */
.swa-metrics-table{width:100%;border-collapse:collapse;margin:16px 0}
.swa-metrics-table th,.swa-metrics-table td{padding:12px 16px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06);font-size:0.9rem}
.swa-metrics-table th{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.4)}
.swa-metrics-table .improve{color:var(--green);font-weight:700}

/* === DOWNLOAD SECTION === */
.swa-download-card{padding:32px;border-radius:28px;border-top:4px solid var(--accent);display:flex;flex-wrap:wrap;gap:24px;align-items:center}
.swa-download-icon{width:72px;height:72px;border-radius:50%;background:rgba(139,92,246,0.15);display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--accent-light);flex-shrink:0}
.swa-download-info{flex:1;min-width:200px}
.swa-download-info h4{font-size:1.3rem;font-weight:900;font-family:'Outfit',sans-serif;text-transform:uppercase;margin-bottom:4px}
.swa-download-info p{color:rgba(255,255,255,0.5);font-size:0.9rem}
.swa-download-btn{background:linear-gradient(135deg,var(--accent),var(--secondary));color:#fff;border:none;padding:14px 32px;font-size:1rem;font-weight:800;border-radius:20px;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(139,92,246,0.25)}
.swa-download-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(139,92,246,0.35)}
.swa-download-btn:disabled{opacity:0.5;cursor:wait;transform:none}

/* === PROMPT GENERATOR === */
.swa-prompt-section{margin-top:32px}
.swa-prompt-card{border-radius:28px;border-top:4px solid #06b6d4;padding:32px;position:relative}
.swa-prompt-header{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;margin-bottom:24px}
.swa-prompt-icon{width:72px;height:72px;border-radius:50%;background:rgba(6,182,212,0.15);display:flex;align-items:center;justify-content:center;font-size:2rem;color:#22d3ee;flex-shrink:0}
.swa-prompt-info{flex:1;min-width:200px}
.swa-prompt-info h4{font-size:1.3rem;font-weight:900;font-family:'Outfit',sans-serif;text-transform:uppercase;margin-bottom:4px}
.swa-prompt-info p{color:rgba(255,255,255,0.5);font-size:0.9rem}
.swa-prompt-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.swa-prompt-style-btn{padding:10px 20px;border:2px solid rgba(255,255,255,0.1);border-radius:14px;background:rgba(30,41,59,0.6);color:#fff;font-weight:600;font-size:0.85rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
.swa-prompt-style-btn:hover{border-color:rgba(6,182,212,0.4);background:rgba(30,41,59,0.9)}
.swa-prompt-style-btn.active{border-color:#06b6d4;background:rgba(6,182,212,0.2);box-shadow:0 4px 16px rgba(6,182,212,0.15)}
.swa-prompt-output{background:rgba(6,182,212,0.04);border:1px solid rgba(6,182,212,0.2);border-radius:16px;padding:20px;position:relative;min-height:120px}
.swa-prompt-text{font-size:0.9rem;line-height:1.7;color:rgba(255,255,255,0.85);white-space:pre-wrap;word-break:break-word}
.swa-prompt-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
.swa-prompt-copy-btn{background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;border:none;padding:12px 24px;font-size:0.9rem;font-weight:700;border-radius:14px;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(6,182,212,0.2)}
.swa-prompt-copy-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(6,182,212,0.3)}
.swa-prompt-lang-btn{padding:8px 16px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;background:rgba(30,41,59,0.5);color:rgba(255,255,255,0.6);font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.swa-prompt-lang-btn:hover{border-color:rgba(6,182,212,0.3);color:#fff}
.swa-prompt-lang-btn.active{border-color:#06b6d4;color:#22d3ee;background:rgba(6,182,212,0.1)}
.swa-prompt-tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:0.7rem;font-weight:700;background:rgba(6,182,212,0.12);color:#22d3ee;margin-right:4px;margin-bottom:4px}
.swa-prompt-note{font-size:0.75rem;color:rgba(255,255,255,0.35);margin-top:12px;display:flex;align-items:center;gap:6px}

/* === PROMPT TABS === */
.swa-prompt-tabs{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:20px;overflow-x:auto;scrollbar-width:none}
.swa-prompt-tabs::-webkit-scrollbar{display:none}
.swa-prompt-tab{padding:12px 20px;background:none;border:none;color:rgba(255,255,255,0.4);font-weight:700;font-size:0.85rem;cursor:pointer;position:relative;transition:color 0.2s;white-space:nowrap;display:flex;align-items:center;gap:8px}
.swa-prompt-tab:hover{color:rgba(255,255,255,0.7)}
.swa-prompt-tab.active{color:#22d3ee}
.swa-prompt-tab.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:3px;background:linear-gradient(90deg,#06b6d4,#8b5cf6);border-radius:3px 3px 0 0}
.swa-prompt-tab i{font-size:0.9rem}
.swa-prompt-tab-content{display:none}
.swa-prompt-tab-content.active{display:block;animation:swa-fadeIn 0.4s ease}
.swa-data-textarea{width:100%;min-height:120px;max-height:300px;background:rgba(168,85,247,0.05);border:2px solid rgba(168,85,247,0.2);border-radius:14px;padding:14px 16px;color:#fff;font-size:0.88rem;font-family:inherit;line-height:1.6;resize:vertical;transition:border-color 0.3s;box-sizing:border-box}
.swa-data-textarea:focus{outline:none;border-color:#a855f7;box-shadow:0 0 0 3px rgba(168,85,247,0.15)}
.swa-data-textarea::placeholder{color:rgba(255,255,255,0.25);font-style:italic}

/* === STRUCTURED FIELDS === */
.swa-fields-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.swa-field-group{display:flex;flex-direction:column;gap:4px}
.swa-field-group.full{grid-column:1/-1}
.swa-field-label{font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:6px}
.swa-field-label i{font-size:0.7rem;color:#a855f7}
.swa-field-input{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 14px;color:#fff;font-size:0.85rem;font-family:inherit;transition:border-color 0.3s;width:100%;box-sizing:border-box;resize:vertical}
.swa-field-input:focus{outline:none;border-color:#a855f7;box-shadow:0 0 0 2px rgba(168,85,247,0.1)}
.swa-field-input::placeholder{color:rgba(255,255,255,0.2);font-style:italic}
select.swa-field-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%23888'%3E%3Cpath d='M0 0l6 8 6-8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
select.swa-field-input option{background:#1e293b;color:#fff}
@media(max-width:600px){.swa-fields-grid{grid-template-columns:1fr}}

/* === STRATEGIC ANALYSIS === */
.swa-quick-answers{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.swa-qa-card{padding:16px;border-radius:16px;border:2px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02)}
.swa-qa-q{font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.6);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.04em}
.swa-qa-answer{font-size:0.95rem;font-weight:800;color:#fff;display:flex;align-items:center;gap:8px}
.swa-qa-answer .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.swa-qa-opts{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.swa-qa-opt{display:flex;align-items:center;gap:8px;font-size:0.82rem;color:rgba(255,255,255,0.4)}
.swa-qa-opt.active{color:#fff;font-weight:700}
.swa-qa-opt .box{width:18px;height:18px;border-radius:5px;border:2px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:0.65rem;flex-shrink:0}
.swa-qa-opt.active .box{background:#6366f1;border-color:#6366f1;color:#fff}
.swa-strat-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid rgba(255,255,255,0.06)}
.swa-strat-tab{background:none;border:none;color:rgba(255,255,255,0.4);font-size:0.85rem;font-weight:700;padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.3s;font-family:inherit}
.swa-strat-tab:hover{color:rgba(255,255,255,0.7)}
.swa-strat-tab.active{color:#a78bfa;border-bottom-color:#6366f1}
.swa-strat-panel{display:none}
.swa-strat-panel.active{display:block;animation:swa-fadeIn 0.4s ease}

/* Category headers */
.swa-strat-cat{padding:10px 16px;border-radius:12px;font-size:0.78rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin:20px 0 10px;display:flex;align-items:center;gap:10px}
.swa-strat-cat:first-child{margin-top:0}
.swa-strat-cat.cat-missing{background:rgba(239,68,68,0.08);color:#f87171;border:1px solid rgba(239,68,68,0.15)}
.swa-strat-cat.cat-ok{background:rgba(16,185,129,0.08);color:#34d399;border:1px solid rgba(16,185,129,0.15)}
.swa-strat-cat.cat-warn{background:rgba(251,191,36,0.08);color:#fbbf24;border:1px solid rgba(251,191,36,0.15)}
.swa-strat-cat.cat-auto{background:rgba(99,102,241,0.08);color:#a78bfa;border:1px solid rgba(99,102,241,0.15)}

/* Rows with status */
.swa-strat-row{display:flex;gap:12px;padding:12px 14px;border-radius:10px;margin-bottom:4px;transition:background 0.2s}
.swa-strat-row:hover{background:rgba(255,255,255,0.02)}
.swa-strat-row .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:6px}
.swa-strat-row .status-dot.green{background:#22c55e}
.swa-strat-row .status-dot.orange{background:#f59e0b}
.swa-strat-row .status-dot.red{background:#ef4444}
.swa-strat-row .status-dot.blue{background:#6366f1}
.swa-strat-label{width:190px;flex-shrink:0;font-size:0.82rem;font-weight:700;color:#fff;display:flex;align-items:flex-start;gap:8px;padding-top:2px}
.swa-strat-label i{font-size:0.75rem;color:rgba(255,255,255,0.35);margin-top:2px}
.swa-strat-value{flex:1;font-size:0.88rem;line-height:1.5;color:#fff}
.swa-strat-value .val-main{color:#fff;font-weight:600}
.swa-strat-value .val-tip{display:block;font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:3px;line-height:1.4;font-weight:400}
.swa-strat-value .val-tip.tip-red{color:rgba(239,68,68,0.8)}
.swa-strat-value .val-tip.tip-orange{color:rgba(251,191,36,0.8)}
.swa-strat-value .val-tip.tip-green{color:rgba(34,197,94,0.7)}
.swa-strat-value.nd{color:rgba(255,255,255,0.35);font-style:italic}
.swa-strat-badge{display:inline-block;padding:3px 10px;border-radius:8px;font-size:0.7rem;font-weight:700;margin-left:6px}
.swa-strat-badge.badge-green{background:rgba(34,197,94,0.12);color:#4ade80}
.swa-strat-badge.badge-orange{background:rgba(251,191,36,0.12);color:#fbbf24}
.swa-strat-badge.badge-red{background:rgba(239,68,68,0.12);color:#f87171}
.swa-strat-badge.badge-blue{background:rgba(99,102,241,0.12);color:#a78bfa}

.swa-client-card{padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);margin-bottom:16px}
.swa-client-title{font-size:0.95rem;font-weight:800;color:#fff;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.swa-client-text{font-size:0.88rem;line-height:1.7;color:rgba(255,255,255,0.75)}
@media(max-width:700px){.swa-quick-answers{grid-template-columns:1fr}.swa-strat-row{flex-direction:column;gap:4px}.swa-strat-label{width:auto}}

/* === MEDIA RECOMMENDATION === */
.swa-media-option{display:flex;gap:16px;align-items:flex-start;padding:16px;border-radius:16px;border:2px solid rgba(255,255,255,0.06);margin-bottom:12px;transition:border-color 0.3s}
.swa-media-option.primary{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.05)}
.swa-media-option.alt{border-color:rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)}
.swa-media-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.swa-media-option.primary .swa-media-icon{background:rgba(245,158,11,0.2);color:#fbbf24}
.swa-media-option.alt .swa-media-icon{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.5)}
.swa-media-label{font-weight:800;font-size:0.95rem;margin-bottom:2px}
.swa-media-reason{font-size:0.82rem;color:rgba(255,255,255,0.5);line-height:1.5}
.swa-media-badge{display:inline-block;padding:2px 10px;border-radius:8px;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em}
.swa-media-badge.rec{background:rgba(245,158,11,0.2);color:#fbbf24}
.swa-media-badge.alt-badge{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.4)}

/* === PRIVACY === */
.swa-privacy{max-width:700px;margin:40px auto 0;border-radius:16px;padding:20px 24px;border:1px solid rgba(139,92,246,0.15);display:flex;align-items:flex-start;gap:14px}
.swa-privacy i{color:var(--accent-light);margin-top:2px}
.swa-privacy h4{font-weight:700;margin-bottom:4px}
.swa-privacy p{font-size:0.85rem;color:rgba(255,255,255,0.55)}

/* === FOOTER === */
.swa-footer{text-align:center;padding:32px 24px;color:rgba(255,255,255,0.25);font-size:0.8rem;border-top:1px solid var(--border);margin-top:48px}
.swa-footer a{color:var(--accent-light);text-decoration:none}

/* === UTILITIES === */
.swa-hidden{display:none!important}
@keyframes swa-fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.swa-fade-in{animation:swa-fadeIn 0.5s ease-out}

/* === DASHBOARD FLOATING NAV === */
.swa-dash-nav{position:fixed;right:20px;top:50%;transform:translateY(-50%);z-index:40;display:flex;flex-direction:column;gap:6px}
.swa-dash-nav a{width:36px;height:36px;border-radius:50%;background:rgba(20,20,20,0.85);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:rgba(255,255,255,0.35);text-decoration:none;transition:all 0.3s;position:relative;backdrop-filter:blur(10px)}
.swa-dash-nav a:hover{background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.5);color:#fff;transform:scale(1.15)}
.swa-dash-nav a:hover .swa-nav-tip{opacity:1;transform:translateX(-10px)}
.swa-nav-tip{position:absolute;right:calc(100% + 8px);white-space:nowrap;background:rgba(0,0,0,0.9);border:1px solid rgba(255,255,255,0.1);padding:4px 12px;border-radius:8px;font-size:0.7rem;font-weight:700;color:#fff;opacity:0;transition:all 0.3s;pointer-events:none;transform:translateX(0)}
@media(max-width:900px){.swa-dash-nav{display:none}}

/* === SCORE VERDICT === */
.swa-verdict{margin-top:8px;font-size:0.85rem;font-weight:800;letter-spacing:0.05em;text-transform:uppercase}
.swa-verdict.excellent{color:#10b981}
.swa-verdict.good{color:#22d3ee}
.swa-verdict.fair{color:#f59e0b}
.swa-verdict.poor{color:#ef4444}

/* === COLOR PSYCHOLOGY === */
.swa-psych-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:14px}
.swa-psych-item{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02)}
.swa-psych-swatch{width:24px;height:24px;border-radius:8px;margin-bottom:6px;border:1px solid rgba(255,255,255,0.1)}
.swa-psych-emotion{font-size:0.78rem;font-weight:700;margin-bottom:2px}
.swa-psych-desc{font-size:0.7rem;color:rgba(255,255,255,0.4);line-height:1.4}

/* === ACTION PLAN === */
.swa-action-section{border-radius:24px;padding:28px;margin-bottom:32px}
.swa-action-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.swa-action-grid{grid-template-columns:1fr}}
.swa-action-card{padding:18px;border-radius:16px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02)}
.swa-action-card h4{font-size:0.88rem;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.swa-checklist{list-style:none}
.swa-checklist li{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:0.82rem;line-height:1.5;color:rgba(255,255,255,0.7)}
.swa-checklist li .ck{width:18px;height:18px;border-radius:5px;border:2px solid rgba(255,255,255,0.15);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.6rem;margin-top:1px}
.swa-checklist li.done .ck{background:#10b981;border-color:#10b981;color:#fff}
.swa-checklist li.todo .ck{background:transparent;border-color:rgba(255,255,255,0.2)}
.swa-time-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);font-size:0.88rem;font-weight:700;color:#60a5fa;margin:6px 4px 6px 0}
.swa-hashtag-cloud{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.swa-hashtag{padding:4px 12px;border-radius:20px;font-size:0.78rem;font-weight:600;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);color:#a78bfa;cursor:pointer;transition:all 0.2s}
.swa-hashtag:hover{background:rgba(139,92,246,0.2);transform:translateY(-1px)}
</style>
</head>
<body>

<header class="swa-header">
<div class="swa-container">
<div class="swa-header-inner">
<div class="swa-logo">
<div class="swa-logo-icon"><i class="fas fa-brain"></i></div>
<div class="swa-logo-text">
<h1>Social<span>Strategist</span> AI</h1>
<p>Analisi Post ‚Ä¢ Report Professionale</p>
</div>
</div>
<div id="navActions" class="swa-hidden">
<button class="swa-nav-btn" onclick="location.reload()"><i class="fas fa-redo"></i> Nuovo Test</button>
</div>
</div>
</div>
</header>

<main class="swa-container">

<!-- ==================== WELCOME ==================== -->
<section id="sectionWelcome" class="swa-welcome">
<h2 class="swa-hero-title font-outfit">Analizza il Tuo Post<br><span class="gradient-text">Con Metriche Reali</span></h2>
<p class="swa-hero-sub">Analisi pixel-level reale dell'immagine, heatmap attenzione, palette colori estratta e report DOCX scaricabile. Zero API, tutto nel browser.</p>

<div style="margin-bottom:48px">
<h3 class="swa-step-title"><span class="swa-step-num">1</span> Seleziona Piattaforma</h3>
<div class="swa-platforms" id="platformBtns">
<button class="swa-plat-btn active" data-platform="instagram"><i class="fab fa-instagram"></i> Instagram</button>
<button class="swa-plat-btn" data-platform="tiktok"><i class="fab fa-tiktok"></i> TikTok / Reels</button>
<button class="swa-plat-btn" data-platform="linkedin"><i class="fab fa-linkedin-in"></i> LinkedIn</button>
<button class="swa-plat-btn" data-platform="facebook"><i class="fab fa-facebook-f"></i> Facebook</button>
<button class="swa-plat-btn" data-platform="web"><i class="fas fa-globe"></i> Web / Landing</button>
</div>
</div>

<div class="swa-config-grid">
<div class="swa-config-card glass">
<div class="swa-config-icon goal"><i class="fas fa-bullseye"></i></div>
<h3><span class="swa-step-num">2</span> Obiettivo del Post</h3>
<p class="swa-hint">Seleziona l'obiettivo principale</p>
<select id="goalSelect" class="swa-select">
<option value="awareness" selected>Brand awareness / Visibilit√†</option>
<option value="sales">Vendite dirette / Conversioni</option>
<option value="engagement">Engagement / Interazioni</option>
<option value="leads">Generazione lead / Contatti</option>
<option value="traffic">Traffico sito web</option>
</select>
</div>
<div class="swa-config-card glass">
<div class="swa-config-icon target"><i class="fas fa-user-group"></i></div>
<h3><span class="swa-step-num">3</span> Target <span style="font-weight:400;font-size:0.85rem;color:rgba(255,255,255,0.4)">(opzionale)</span></h3>
<p class="swa-hint">Descrivi il tuo pubblico ideale</p>
<textarea id="targetInput" class="swa-textarea" placeholder="Es: Donne 25-40, wellness&#10;Professionisti tech 30-50&#10;Gen Z, moda e lifestyle"></textarea>
</div>
</div>

<!-- Strategic Fields (pre-analysis) -->
<div style="margin-bottom:40px">
<h3 class="swa-step-title" style="cursor:pointer;display:flex;align-items:center;gap:10px" onclick="this.nextElementSibling.classList.toggle('swa-hidden');this.querySelector('.chev').classList.toggle('rotated')">
<span class="swa-step-num">3</span> Dettagli del Post <span style="font-weight:400;font-size:0.82rem;color:rgba(255,255,255,0.4)">(pi√π compili, pi√π l'analisi √® precisa)</span>
<i class="fas fa-chevron-down chev" style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-left:auto;transition:transform 0.3s"></i>
</h3>
<div class="swa-strat-fields-wrap">
<div class="swa-fields-grid" style="max-width:800px;margin:0 auto">

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-bullseye"></i> Scopo / Argomento</label>
<input type="text" id="fieldScopo" class="swa-field-input" placeholder="Es: Promuovere l'evento, Informare, Lanciare prodotto...">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-industry"></i> Settore</label>
<input type="text" id="fieldSettore" class="swa-field-input" placeholder="Es: Ristorazione, Benessere, Formazione, Tech...">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-heading"></i> Brand / Titolo</label>
<input type="text" id="fieldTitolo1" class="swa-field-input" placeholder="Nome brand o titolo del post / evento">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-tag"></i> Prodotto / Servizio</label>
<input type="text" id="fieldSottotipo" class="swa-field-input" placeholder="Es: Corso yoga, App fitness, Consulenza HR...">
</div>

<div class="swa-field-group full">
<label class="swa-field-label"><i class="fas fa-align-left"></i> Didascalia / Copy del post</label>
<textarea id="fieldDidascalia" class="swa-field-input" rows="3" placeholder="Caption del post, testo esistente o bozza da riscrivere... (necessario per analizzare CTA e hook)"></textarea>
</div>

<div class="swa-field-group full">
<label class="swa-field-label"><i class="fas fa-map-pin"></i> Contesto business</label>
<textarea id="fieldContesto" class="swa-field-input" rows="2" placeholder="Es: Evento dal vivo a Milano, Lancio prodotto online, Campagna stagionale estiva..."></textarea>
</div>

</div>
</div>
</div>

<div style="margin-bottom:40px">
<h3 class="swa-step-title"><span class="swa-step-num">4</span> Carica il Tuo Post</h3>
<div id="dropZone" class="glass swa-dropzone">
<input type="file" id="fileInput" class="swa-hidden" accept="image/*">
<div class="swa-dropzone-icon"><i class="fas fa-cloud-upload-alt"></i></div>
<p style="font-size:1.2rem;font-weight:700;margin-bottom:6px">Trascina l'immagine qui</p>
<p style="font-size:0.85rem;color:rgba(255,255,255,0.4)">JPG, PNG, GIF, WebP ‚Ä¢ max 10MB</p>
</div>
<div id="previewBox" class="swa-preview swa-hidden">
<p style="font-weight:600;margin-bottom:8px;text-align:left;font-size:0.9rem">Anteprima:</p>
<img id="previewImg" src="" alt="Anteprima post">
</div>
</div>

<button id="analyzeBtn" class="swa-analyze-btn" disabled>
<i class="fas fa-chart-line"></i> Analizza e Genera Report
</button>
<div id="errorBox" class="swa-error swa-hidden"><i class="fas fa-exclamation-triangle"></i> <span id="errorMsg"></span></div>

<div class="swa-privacy glass">
<i class="fas fa-shield-alt"></i>
<div>
<h4>Privacy Assoluta</h4>
<p>L'analisi avviene 100% nel browser tramite Canvas API. Nessun dato viene inviato a server esterni. Il report DOCX viene generato localmente.</p>
</div>
</div>
</section>

<!-- ==================== LOADER ==================== -->
<section id="sectionLoader" class="swa-loader-section swa-hidden">
<div class="swa-spinner"></div>
<p class="swa-loader-text">Analisi in corso</p>
<p class="swa-loader-sub" id="loaderCtx"></p>
<div class="swa-loader-steps" id="loaderSteps">
<div class="swa-loader-step" data-step="pixels"><i class="fas fa-circle-notch fa-spin"></i> Analisi pixel e luminosit√†</div>
<div class="swa-loader-step" data-step="colors"><i class="far fa-circle"></i> Estrazione palette colori</div>
<div class="swa-loader-step" data-step="contrast"><i class="far fa-circle"></i> Calcolo contrasto RMS</div>
<div class="swa-loader-step" data-step="entropy"><i class="far fa-circle"></i> Entropia Shannon</div>
<div class="swa-loader-step" data-step="composition"><i class="far fa-circle"></i> Analisi composizione</div>
<div class="swa-loader-step" data-step="heatmap"><i class="far fa-circle"></i> Generazione heatmap</div>
<div class="swa-loader-step" data-step="report"><i class="far fa-circle"></i> Preparazione report</div>
</div>
</section>

<!-- ==================== DASHBOARD ==================== -->
<section id="sectionDashboard" class="swa-dashboard swa-hidden">

<!-- Floating Navigation -->
<nav class="swa-dash-nav" id="dashNav">
<a href="#contextBar"><i class="fas fa-info"></i><span class="swa-nav-tip">Configurazione</span></a>
<a href="#overallScore"><i class="fas fa-gauge-high"></i><span class="swa-nav-tip">Punteggio</span></a>
<a href="#heatmapBox"><i class="fas fa-fire"></i><span class="swa-nav-tip">Heatmap</span></a>
<a href="#recsSection"><i class="fas fa-lightbulb"></i><span class="swa-nav-tip">Raccomandazioni</span></a>
<a href="#strategicSection"><i class="fas fa-microscope"></i><span class="swa-nav-tip">Analisi Strategica</span></a>
<a href="#actionPlanSection"><i class="fas fa-clipboard-check"></i><span class="swa-nav-tip">Piano d'Azione</span></a>
<a href="#promptSection"><i class="fas fa-wand-magic-sparkles"></i><span class="swa-nav-tip">Prompt AI</span></a>
<a href="#downloadBtn"><i class="fas fa-download"></i><span class="swa-nav-tip">Scarica Report</span></a>
</nav>

<div class="swa-context-bar" id="contextBar"></div>

<!-- Overall Score -->
<div class="swa-overall">
<div class="swa-overall-ring">
<svg viewBox="0 0 120 120">
<defs><linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#8b5cf6"/><stop offset="100%" stop-color="#ec4899"/></linearGradient></defs>
<circle class="bg" cx="60" cy="60" r="52"/>
<circle class="fg" id="overallRing" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
</svg>
<div class="swa-overall-value" id="overallScore">--</div>
</div>
<div class="swa-overall-label">Punteggio Visivo</div>
<div class="swa-verdict" id="verdictBadge"></div>
</div>

<!-- Content Strategy Score -->
<div class="swa-strategy-score glass" id="strategyScoreSection" style="border-radius:20px;padding:20px 28px;margin-bottom:32px;display:none">
<div style="display:flex;flex-wrap:wrap;gap:20px;align-items:center">
<div style="display:flex;align-items:center;gap:16px;flex:1;min-width:280px">
<div style="position:relative;width:64px;height:64px;flex-shrink:0">
<svg viewBox="0 0 120 120" width="64" height="64">
<circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="10"/>
<circle id="stratRing" cx="60" cy="60" r="52" fill="none" stroke="url(#stratGrad)" stroke-width="10" stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73" transform="rotate(-90 60 60)" style="transition:stroke-dashoffset 1s ease"/>
<defs><linearGradient id="stratGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#06b6d4"/></linearGradient></defs>
</svg>
<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:900" id="stratScoreNum">‚Äî</div>
</div>
<div>
<div style="font-size:0.95rem;font-weight:800">Punteggio Strategia Contenuto</div>
<div style="font-size:0.78rem;color:rgba(255,255,255,0.4)" id="stratScoreDesc">Compila i campi per un punteggio pi√π accurato</div>
</div>
</div>
<div id="stratCompleteness" style="display:flex;gap:4px;flex-wrap:wrap"></div>
</div>
</div>

<!-- Score Cards -->
<div class="swa-scores-grid" id="scoresGrid"></div>

<!-- Visual Analysis -->
<div class="swa-visual-grid">
<div class="swa-visual-card glass">
<h3>üî• Heatmap Attenzione</h3>
<div class="swa-heatmap-container" id="heatmapBox"></div>
<p style="font-size:0.75rem;color:rgba(255,255,255,0.35);margin-top:10px"><i class="fas fa-info-circle"></i> Rosso = alta attenzione stimata, Blu = bassa. Basata su center-bias + edge saliency.</p>
</div>
<div class="swa-visual-card glass">
<h3>üé® Palette Estratta</h3>
<div class="swa-palette" id="paletteBox"></div>
<div style="margin-top:20px">
<h4 style="font-size:0.9rem;font-weight:700;margin-bottom:10px">üìä Distribuzione Luminosit√†</h4>
<canvas id="histogramCanvas" width="300" height="100" style="width:100%;height:80px;border-radius:8px;background:rgba(255,255,255,0.03)"></canvas>
</div>
<div style="margin-top:16px" id="colorHarmonyBox"></div>
<div style="margin-top:16px" id="colorPsychBox"></div>
</div>
</div>

<!-- Recommendations -->
<div class="swa-recs" id="recsSection"></div>

<!-- Media Type Recommendation -->
<div class="glass swa-media-rec" id="mediaRecSection" style="border-radius:24px;padding:28px;margin-bottom:32px;display:none">
<div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
<div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;font-size:1.4rem"><i class="fas fa-photo-film"></i></div>
<div>
<h3 style="font-size:1.1rem;font-weight:800;font-family:'Outfit',sans-serif">Tipo Media Consigliato</h3>
<p style="font-size:0.8rem;color:rgba(255,255,255,0.4)">Basato su obiettivo, piattaforma e analisi visiva</p>
</div>
</div>
<div id="mediaRecContent"></div>
</div>

<!-- ==================== STRATEGIC ANALYSIS ==================== -->
<div class="glass swa-strategic" id="strategicSection" style="border-radius:24px;padding:28px;margin-bottom:32px;display:none">

<!-- Header -->
<div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">
<div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:1.4rem"><i class="fas fa-microscope"></i></div>
<div>
<h3 style="font-size:1.2rem;font-weight:800;font-family:'Outfit',sans-serif">Analisi Strategica del Post</h3>
<p style="font-size:0.8rem;color:rgba(255,255,255,0.4)">Report basato sull'analisi visiva + dati compilati. Campi vuoti = deduzione o "non determinabile".</p>
</div>
</div>

<!-- 3 Quick Answers -->
<div class="swa-quick-answers" id="quickAnswers"></div>

<!-- Tabs -->
<div class="swa-strat-tabs">
<button class="swa-strat-tab active" onclick="SWA.switchStratTab('tech')"><i class="fas fa-cog"></i> Report Tecnico</button>
<button class="swa-strat-tab" onclick="SWA.switchStratTab('client')"><i class="fas fa-user-tie"></i> Sintesi Cliente</button>
</div>

<!-- Technical Report -->
<div class="swa-strat-panel active" id="stratTech"></div>

<!-- Client Summary -->
<div class="swa-strat-panel" id="stratClient"></div>

</div>

<!-- ==================== ACTION PLAN ==================== -->
<div class="glass swa-action-section" id="actionPlanSection" style="display:none">
<div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">
<div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#10b981,#14b8a6);display:flex;align-items:center;justify-content:center;font-size:1.4rem"><i class="fas fa-clipboard-check"></i></div>
<div>
<h3 style="font-size:1.2rem;font-weight:800;font-family:'Outfit',sans-serif">Piano d'Azione Immediato</h3>
<p style="font-size:0.8rem;color:rgba(255,255,255,0.4)">Cosa fare prima, durante e dopo la pubblicazione</p>
</div>
</div>
<div class="swa-action-grid" id="actionPlanContent"></div>
</div>

<!-- Metrics Comparison -->
<div class="glass" style="border-radius:24px;padding:28px;margin-bottom:32px">
<h3 style="font-size:1.2rem;font-weight:700;margin-bottom:16px">üìà Confronto Attuale vs Ottimizzato</h3>
<div style="overflow-x:auto">
<table class="swa-metrics-table" id="metricsTable"></table>
</div>
</div>

<!-- Download -->
<div class="swa-download-card glass">
<div class="swa-download-icon"><i class="fas fa-file-word"></i></div>
<div class="swa-download-info">
<h4 class="font-outfit">Report DOCX Pronto</h4>
<p>Report Word completo con tutte le metriche, raccomandazioni e heatmap.</p>
</div>
<button id="downloadBtn" class="swa-download-btn" onclick="SWA.downloadDocx()">
<i class="fas fa-download"></i> Scarica Report .docx
</button>
</div>

<!-- AI Prompt Generator -->
<div class="swa-prompt-section" id="promptSection">
<div class="swa-prompt-card glass">
<div class="swa-prompt-header">
<div class="swa-prompt-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
<div class="swa-prompt-info">
<h4 class="font-outfit">Genera Post Completo con AI</h4>
<p>Due prompt ottimizzati dall'analisi: uno per l'immagine, uno per il testo/caption. Copia e incolla nell'AI che preferisci.</p>
</div>
</div>

<!-- Tab navigation -->
<div class="swa-prompt-tabs">
<button class="swa-prompt-tab active" data-tab="image" onclick="SWA.switchPromptTab('image')">
<i class="fas fa-image"></i> Prompt Immagine
</button>
<button class="swa-prompt-tab" data-tab="content" onclick="SWA.switchPromptTab('content')">
<i class="fas fa-pen-fancy"></i> Prompt Testo / Caption
</button>
<button class="swa-prompt-tab" data-tab="combined" onclick="SWA.switchPromptTab('combined')">
<i class="fas fa-layer-group"></i> Prompt Completo
</button>
</div>

<!-- IMAGE PROMPT TAB -->
<div class="swa-prompt-tab-content active" id="tabImage">
<div style="margin-bottom:16px">
<p style="font-size:0.85rem;font-weight:700;margin-bottom:10px">Stile visivo:</p>
<div class="swa-prompt-controls" id="promptStyleBtns">
<button class="swa-prompt-style-btn active" data-style="photo"><i class="fas fa-camera"></i> Fotografico</button>
<button class="swa-prompt-style-btn" data-style="graphic"><i class="fas fa-palette"></i> Grafico</button>
<button class="swa-prompt-style-btn" data-style="illustration"><i class="fas fa-pen-nib"></i> Illustrazione</button>
<button class="swa-prompt-style-btn" data-style="minimal"><i class="fas fa-minimize"></i> Minimal</button>
</div>
</div>
<div class="swa-prompt-output" style="border-color:rgba(6,182,212,0.2)">
<div class="swa-prompt-text" id="promptTextImage">Analisi in corso...</div>
</div>
<div class="swa-prompt-actions">
<button class="swa-prompt-copy-btn" onclick="SWA.copyPrompt('image')"><i class="fas fa-copy"></i> Copia</button>
<button class="swa-prompt-copy-btn" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)" onclick="SWA.copyPromptForChatGPT('image')"><i class="fas fa-robot"></i> Per ChatGPT/DALL-E</button>
<button class="swa-prompt-copy-btn" style="background:linear-gradient(135deg,#1e3a5f,#0f172a)" onclick="SWA.copyPromptForMidjourney()"><i class="fas fa-image"></i> Per Midjourney</button>
</div>
</div>

<!-- CONTENT PROMPT TAB -->
<div class="swa-prompt-tab-content" id="tabContent">

<div style="margin-bottom:16px">
<p style="font-size:0.85rem;font-weight:700;margin-bottom:10px">Tono di voce:</p>
<div class="swa-prompt-controls" id="promptToneBtns">
<button class="swa-prompt-style-btn active" data-tone="professional"><i class="fas fa-briefcase"></i> Professionale</button>
<button class="swa-prompt-style-btn" data-tone="friendly"><i class="fas fa-face-smile"></i> Conversazionale</button>
<button class="swa-prompt-style-btn" data-tone="educational"><i class="fas fa-graduation-cap"></i> Educativo</button>
<button class="swa-prompt-style-btn" data-tone="inspirational"><i class="fas fa-star"></i> Ispirazionale</button>
</div>
</div>

<!-- Structured Fields (remaining) -->
<div class="swa-fields-grid">

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-crosshairs"></i> Obiettivo specifico</label>
<input type="text" id="fieldObiettivo" class="swa-field-input" placeholder="Es: Iscrizioni, Visite al sito, 50 commenti...">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-photo-film"></i> Tipo di media</label>
<select id="fieldTipoMedia" class="swa-field-input">
<option value="">‚Äî Scegli dal suggerimento o manualmente ‚Äî</option>
<option value="Immagine singola">üì∑ Immagine singola</option>
<option value="Carosello">üîÑ Carosello</option>
<option value="Reel / Video breve">üé¨ Reel / Video breve</option>
<option value="Video lungo">üìπ Video lungo</option>
<option value="Solo testo">üìù Solo testo</option>
<option value="Story">üì± Story</option>
<option value="Documento / PDF">üìÑ Documento / PDF</option>
</select>
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-users"></i> Pubblico dettagliato</label>
<input type="text" id="fieldPubblico" class="swa-field-input" placeholder="Es: Donne 30-50 area benessere, Professionisti HR...">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-h"></i> Titolo secondario</label>
<input type="text" id="fieldTitolo2" class="swa-field-input" placeholder="Sottotitolo o slogan (se presente)">
</div>

<div class="swa-field-group">
<label class="swa-field-label"><i class="fas fa-quote-left"></i> Titolo di supporto</label>
<input type="text" id="fieldTitolo3" class="swa-field-input" placeholder="Headline aggiuntiva (se presente)">
</div>

</div>

<!-- Verbatim data -->
<div style="margin:20px 0">
<p style="font-size:0.85rem;font-weight:700;margin-bottom:6px"><i class="fas fa-database" style="margin-right:6px;color:#a855f7"></i>Dati aggiuntivi (VERBATIM)</p>
<p style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:10px">Informazioni extra: link, prezzi, orari, contatti, note. Il prompt user√† SOLO dati presenti ‚Äî nessuna invenzione.</p>
<textarea id="contentDataInput" class="swa-data-textarea" placeholder="Es: www.yogabergamo.it ‚Äî 035 123456&#10;Ingresso ‚Ç¨15 ‚Äî Posti limitati&#10;Sponsor: BioNatura Srl" rows="3"></textarea>
</div>

<div class="swa-prompt-output" style="border-color:rgba(168,85,247,0.2)">
<div class="swa-prompt-text" id="promptTextContent">Compila i campi sopra e il prompt verr√† generato automaticamente...</div>
</div>
<div class="swa-prompt-actions">
<button class="swa-prompt-copy-btn" style="background:linear-gradient(135deg,#a855f7,#7c3aed)" onclick="SWA.copyPrompt('content')"><i class="fas fa-copy"></i> Copia Prompt</button>
<button class="swa-prompt-copy-btn" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9)" onclick="SWA.copyPromptForChatGPT('content')"><i class="fas fa-robot"></i> Per ChatGPT / Claude</button>
</div>
<p class="swa-prompt-note" style="margin-top:12px"><i class="fas fa-shield-halved"></i> Vincoli anti-invenzione attivi: l'AI user√† SOLO i dati inseriti. Campi vuoti = "non determinabile".</p>
</div>

<!-- COMBINED PROMPT TAB -->
<div class="swa-prompt-tab-content" id="tabCombined">
<p style="font-size:0.85rem;color:rgba(255,255,255,0.5);margin-bottom:16px"><i class="fas fa-info-circle"></i> Prompt unico che include sia le istruzioni per l'immagine che per il testo ‚Äî ideale per ChatGPT o Claude che possono fare entrambe le cose.</p>
<div class="swa-prompt-output" style="border-color:rgba(236,72,153,0.2)">
<div class="swa-prompt-text" id="promptTextCombined">Analisi in corso...</div>
</div>
<div class="swa-prompt-actions">
<button class="swa-prompt-copy-btn" style="background:linear-gradient(135deg,#ec4899,#8b5cf6)" onclick="SWA.copyPrompt('combined')"><i class="fas fa-copy"></i> Copia Prompt Completo</button>
</div>
</div>

<!-- Shared controls -->
<div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
<div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px">
<div style="display:flex;gap:8px;align-items:center">
<span style="font-size:0.8rem;font-weight:600;color:rgba(255,255,255,0.4)">Lingua:</span>
<button class="swa-prompt-lang-btn active" data-lang="it" onclick="SWA.setPromptLang('it')">üáÆüáπ IT</button>
<button class="swa-prompt-lang-btn" data-lang="en" onclick="SWA.setPromptLang('en')">üá¨üáß EN</button>
</div>
<p class="swa-prompt-note" style="margin:0"><i class="fas fa-lightbulb"></i> Prompts basati su palette, composizione, metriche e raccomandazioni reali dell'analisi.</p>
</div>
</div>
</div>
</div>

</section>
</main>

<footer class="swa-footer">
<p>&copy; 2025 <a href="https://robertozanoni.it" target="_blank">Roberto Zanoni</a> ‚Äî Web Designer & SEO Specialist</p>
</footer>

<!-- Hidden canvas for analysis -->
<canvas id="analysisCanvas" class="swa-hidden"></canvas>

<script>
(function(){
'use strict';

// ==================== APP STATE ====================
const state = {
    platform:'instagram',
    goal:'awareness',
    target:'',
    imageData:null,
    imageSrc:null,
    analysis:null
};

// ==================== DOM REFS ====================
const $ = id => document.getElementById(id);
const secWelcome = $('sectionWelcome');
const secLoader = $('sectionLoader');
const secDashboard = $('sectionDashboard');

// ==================== PLATFORM ====================
document.querySelectorAll('.swa-plat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.swa-plat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.platform = btn.dataset.platform;
        checkReady();
    });
});

// ==================== GOAL ====================
$('goalSelect').addEventListener('change', e => {
    state.goal = e.target.value;
});

// ==================== TARGET ====================
$('targetInput').addEventListener('input', e => {
    state.target = e.target.value.trim();
});

// ==================== FILE UPLOAD ====================
$('dropZone').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', e => handleFile(e.target.files[0]));
$('dropZone').addEventListener('dragover', e => { e.preventDefault(); $('dropZone').classList.add('dragover'); });
$('dropZone').addEventListener('dragleave', () => $('dropZone').classList.remove('dragover'));
$('dropZone').addEventListener('drop', e => { e.preventDefault(); $('dropZone').classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

function handleFile(file) {
    if (!file) return;
    if (!file.type.match('image.*')) return showError('Formato non valido. Usa JPG, PNG, GIF o WebP.');
    if (file.size > 10*1024*1024) return showError('Immagine troppo grande (max 10MB).');
    const reader = new FileReader();
    reader.onload = e => {
        state.imageSrc = e.target.result;
        $('previewImg').src = e.target.result;
        $('previewBox').classList.remove('swa-hidden');
        $('errorBox').classList.add('swa-hidden');
        checkReady();
    };
    reader.readAsDataURL(file);
}

function showError(msg) {
    $('errorMsg').textContent = msg;
    $('errorBox').classList.remove('swa-hidden');
    setTimeout(() => $('errorBox').classList.add('swa-hidden'), 5000);
}

function checkReady() {
    $('analyzeBtn').disabled = !state.imageSrc;
}

// ==================== ANALYZE ====================
$('analyzeBtn').addEventListener('click', () => {
    if (!state.imageSrc) return showError('Carica un\'immagine prima.');
    startAnalysis();
});

function startAnalysis() {
    secWelcome.classList.add('swa-hidden');
    secLoader.classList.remove('swa-hidden');
    
    const pName = {instagram:'Instagram',tiktok:'TikTok',linkedin:'LinkedIn',facebook:'Facebook',web:'Web'}[state.platform];
    const gName = {sales:'Vendite',awareness:'Brand Awareness',engagement:'Engagement',leads:'Lead Generation',traffic:'Traffico'}[state.goal];
    $('loaderCtx').textContent = `${pName} ‚Ä¢ ${gName}`;

    const steps = ['pixels','colors','contrast','entropy','composition','heatmap','report'];
    let idx = 0;

    function advanceStep() {
        if (idx > 0) {
            const prev = document.querySelector(`.swa-loader-step[data-step="${steps[idx-1]}"]`);
            prev.classList.remove('active');
            prev.classList.add('done');
            prev.querySelector('i').className = 'fas fa-check-circle';
        }
        if (idx < steps.length) {
            const cur = document.querySelector(`.swa-loader-step[data-step="${steps[idx]}"]`);
            cur.classList.add('active');
            cur.querySelector('i').className = 'fas fa-circle-notch fa-spin';
            idx++;
            setTimeout(advanceStep, 350 + Math.random()*250);
        } else {
            runAnalysis();
        }
    }
    setTimeout(advanceStep, 200);
}

// ==================== CANVAS ANALYSIS ENGINE ====================
function runAnalysis() {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
        const canvas = $('analysisCanvas');
        // Scale down for performance but keep enough detail
        const maxDim = 400;
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
            const ratio = Math.min(maxDim/w, maxDim/h);
            w = Math.round(w*ratio);
            h = Math.round(h*ratio);
        }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d', {willReadFrequently:true});
        ctx.drawImage(img, 0, 0, w, h);
        const imageData = ctx.getImageData(0, 0, w, h);
        
        const analysis = analyzePixels(imageData, w, h, img);
        state.analysis = analysis;
        state.analysis.imgWidth = img.width;
        state.analysis.imgHeight = img.height;
        state.analysis.canvasW = w;
        state.analysis.canvasH = h;
        
        renderDashboard(analysis, img);
    };
    img.src = state.imageSrc;
}

function analyzePixels(imageData, w, h, img) {
    const d = imageData.data;
    const totalPixels = w * h;
    
    // === LUMINANCE ARRAY ===
    const lum = new Float32Array(totalPixels);
    const rArr = new Uint8Array(totalPixels);
    const gArr = new Uint8Array(totalPixels);
    const bArr = new Uint8Array(totalPixels);
    
    for (let i = 0; i < totalPixels; i++) {
        const off = i * 4;
        rArr[i] = d[off];
        gArr[i] = d[off+1];
        bArr[i] = d[off+2];
        lum[i] = 0.2126*d[off] + 0.7152*d[off+1] + 0.0722*d[off+2];
    }
    
    // === 1. RMS CONTRAST ===
    let lumSum = 0;
    for (let i = 0; i < totalPixels; i++) lumSum += lum[i];
    const lumMean = lumSum / totalPixels;
    let lumVarSum = 0;
    for (let i = 0; i < totalPixels; i++) lumVarSum += (lum[i]-lumMean)**2;
    const rmsContrast = Math.sqrt(lumVarSum / totalPixels) / 255;  // 0-1
    const contrastScore = Math.round(Math.min(100, rmsContrast * 400));  // scale to score
    
    // === 2. SHANNON ENTROPY ===
    const lumHist = new Uint32Array(256);
    for (let i = 0; i < totalPixels; i++) lumHist[Math.round(lum[i])]++;
    let entropy = 0;
    for (let i = 0; i < 256; i++) {
        if (lumHist[i] > 0) {
            const p = lumHist[i] / totalPixels;
            entropy -= p * Math.log2(p);
        }
    }
    // entropy is 0-8, lower = less complex
    
    // === 3. COLOR EXTRACTION (simplified k-means) ===
    const colorBuckets = {};
    const step = Math.max(1, Math.floor(totalPixels / 5000));
    for (let i = 0; i < totalPixels; i += step) {
        // Quantize to reduce colors
        const qr = Math.round(rArr[i]/32)*32;
        const qg = Math.round(gArr[i]/32)*32;
        const qb = Math.round(bArr[i]/32)*32;
        const key = `${qr},${qg},${qb}`;
        colorBuckets[key] = (colorBuckets[key]||0) + 1;
    }
    const sortedColors = Object.entries(colorBuckets)
        .sort((a,b) => b[1]-a[1])
        .slice(0, 8)
        .map(([key, count]) => {
            const [r,g,b] = key.split(',').map(Number);
            return {r,g,b, count, pct: Math.round(count / (totalPixels/step) * 100)};
        });
    
    // Merge similar colors
    const palette = [];
    for (const c of sortedColors) {
        const similar = palette.find(p => Math.abs(p.r-c.r)+Math.abs(p.g-c.g)+Math.abs(p.b-c.b) < 80);
        if (similar) {
            similar.count += c.count;
            similar.pct += c.pct;
        } else if (palette.length < 6) {
            palette.push({...c});
        }
    }
    // Recalculate percentages
    const totalPct = palette.reduce((s,c) => s+c.pct, 0);
    palette.forEach(c => c.pct = Math.round(c.pct/totalPct*100));
    
    // === 4. QUADRANT ANALYSIS (Visual Flow) ===
    const quadrants = [{sum:0,cnt:0,edges:0},{sum:0,cnt:0,edges:0},{sum:0,cnt:0,edges:0},{sum:0,cnt:0,edges:0}];
    const cx = w/2, cy = h/2;
    let centerWeight = 0, totalWeight = 0;
    
    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
            const i = y*w+x;
            const q = (y < h/2 ? 0 : 2) + (x < w/2 ? 0 : 1);
            quadrants[q].sum += lum[i];
            quadrants[q].cnt++;
            
            // Edge detection (simple gradient magnitude)
            if (x > 0 && x < w-1 && y > 0 && y < h-1) {
                const gx = Math.abs(lum[i+1] - lum[i-1]);
                const gy = Math.abs(lum[i+w] - lum[i-w]);
                const edge = Math.sqrt(gx*gx + gy*gy);
                quadrants[q].edges += edge;
                
                // Center-bias weight
                const dx = (x-cx)/cx, dy = (y-cy)/cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const weight = Math.max(0, 1 - dist*0.7);
                centerWeight += edge * weight;
                totalWeight += edge;
            }
        }
    }
    
    quadrants.forEach(q => {
        q.avgLum = q.cnt > 0 ? q.sum/q.cnt : 0;
        q.avgEdge = q.cnt > 0 ? q.edges/q.cnt : 0;
    });
    
    // Flow score: how well attention is guided (center-bias + balanced quadrants)
    const centerBias = totalWeight > 0 ? centerWeight / totalWeight : 0.5;
    const quadLums = quadrants.map(q => q.avgLum);
    const quadRange = Math.max(...quadLums) - Math.min(...quadLums);
    const quadBalance = 1 - Math.min(1, quadRange / 128);
    const flowScore = Math.round(Math.min(100, (centerBias*0.6 + quadBalance*0.4) * 120));
    
    // === 5. NEGATIVE SPACE ===
    // Detect uniform regions (low local variance)
    let uniformPixels = 0;
    const blockSize = 8;
    for (let by = 0; by < h-blockSize; by += blockSize) {
        for (let bx = 0; bx < w-blockSize; bx += blockSize) {
            let bSum = 0, bSum2 = 0, bCnt = 0;
            for (let dy = 0; dy < blockSize; dy++) {
                for (let dx = 0; dx < blockSize; dx++) {
                    const v = lum[(by+dy)*w+(bx+dx)];
                    bSum += v;
                    bSum2 += v*v;
                    bCnt++;
                }
            }
            const bMean = bSum/bCnt;
            const bVar = bSum2/bCnt - bMean*bMean;
            if (bVar < 200) uniformPixels += bCnt;
        }
    }
    const negativeSpace = Math.round(uniformPixels / totalPixels * 100);
    
    // === 6. EDGE DENSITY (complexity) ===
    let totalEdge = 0, edgeCount = 0;
    for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
            const i = y*w+x;
            const gx = Math.abs(lum[i+1]-lum[i-1]);
            const gy = Math.abs(lum[i+w]-lum[i-w]);
            const e = Math.sqrt(gx*gx+gy*gy);
            totalEdge += e;
            if (e > 30) edgeCount++;
        }
    }
    const edgeDensity = edgeCount / totalPixels;
    
    // === 7. ASPECT RATIO ===
    const aspectRatio = img.width / img.height;
    const platformOptimal = {
        instagram: {ratios:[{r:0.8,label:'4:5 Feed'},{r:1,label:'1:1 Quadrato'},{r:0.5625,label:'9:16 Story'}], safeTop:0.05,safeBottom:0.12,safeLeft:0.03,safeRight:0.03},
        tiktok: {ratios:[{r:0.5625,label:'9:16 Verticale'}], safeTop:0.15,safeBottom:0.25,safeLeft:0.05,safeRight:0.05},
        linkedin: {ratios:[{r:1.91,label:'1.91:1 Landscape'},{r:1,label:'1:1 Quadrato'}], safeTop:0.03,safeBottom:0.08,safeLeft:0.03,safeRight:0.03},
        facebook: {ratios:[{r:1.91,label:'1.91:1 Landscape'},{r:1,label:'1:1 Quadrato'}], safeTop:0.03,safeBottom:0.1,safeLeft:0.03,safeRight:0.03},
        web: {ratios:[{r:1.778,label:'16:9 Widescreen'},{r:1.333,label:'4:3'}], safeTop:0.02,safeBottom:0.02,safeLeft:0.02,safeRight:0.02}
    };
    const platInfo = platformOptimal[state.platform];
    let bestRatioMatch = 0;
    let bestRatioLabel = '';
    for (const opt of platInfo.ratios) {
        const match = 1 - Math.min(1, Math.abs(aspectRatio - opt.r) / opt.r);
        if (match > bestRatioMatch) { bestRatioMatch = match; bestRatioLabel = opt.label; }
    }
    
    // === 8. SAFE ZONE ANALYSIS ===
    // Check if high-edge areas fall within safe zones
    const safeT = Math.round(h * platInfo.safeTop);
    const safeB = Math.round(h * (1-platInfo.safeBottom));
    const safeL = Math.round(w * platInfo.safeLeft);
    const safeR = Math.round(w * (1-platInfo.safeRight));
    let safeEdges = 0, unsafeEdges = 0;
    for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
            const i = y*w+x;
            const gx = Math.abs(lum[i+1]-lum[i-1]);
            const gy = Math.abs(lum[i+w]-lum[i-w]);
            const e = Math.sqrt(gx*gx+gy*gy);
            if (e > 40) {
                if (y >= safeT && y <= safeB && x >= safeL && x <= safeR) safeEdges++;
                else unsafeEdges++;
            }
        }
    }
    const safeZoneCompliance = (safeEdges+unsafeEdges) > 0 ? safeEdges/(safeEdges+unsafeEdges) : 1;
    
    // === 9. CONTRAST RATIO ESTIMATE ===
    // Approximate WCAG ratio between lightest and darkest significant areas
    const sortedLum = Array.from(lum).sort((a,b)=>a-b);
    const dark10 = sortedLum[Math.floor(totalPixels*0.1)];
    const light90 = sortedLum[Math.floor(totalPixels*0.9)];
    const L1 = (light90/255 + 0.05);
    const L2 = (dark10/255 + 0.05);
    const wcagRatio = L1 > L2 ? L1/L2 : L2/L1;
    
    // === 10. COLOR HARMONY ===
    let harmonyType = 'N/D';
    if (palette.length >= 2) {
        const hues = palette.slice(0,3).map(c => rgbToHsl(c.r,c.g,c.b)[0]);
        const diffs = [];
        for (let i = 0; i < hues.length-1; i++) {
            let diff = Math.abs(hues[i+1]-hues[i]);
            if (diff > 180) diff = 360-diff;
            diffs.push(diff);
        }
        const avgDiff = diffs.reduce((s,d)=>s+d,0)/diffs.length;
        if (avgDiff < 25) harmonyType = 'Monocromatica';
        else if (avgDiff < 50) harmonyType = 'Analoga';
        else if (avgDiff > 140 && avgDiff < 200) harmonyType = 'Complementare';
        else if (avgDiff > 90 && avgDiff < 140) harmonyType = 'Triadica';
        else harmonyType = 'Mista';
    }
    
    // === COMPOSITE SCORES ===
    const accessScore = Math.round(Math.min(100, (bestRatioMatch*40 + safeZoneCompliance*40 + (wcagRatio > 4.5 ? 20 : wcagRatio/4.5*20))));
    const structureScore = Math.round(Math.min(100, (negativeSpace > 15 ? 30 : negativeSpace*2) + (1-edgeDensity)*40 + (harmonyType !== 'Mista' ? 30 : 15)));
    const frictionScore = Math.round(Math.min(100, (1 - entropy/8) * 100));
    const overallScore = Math.round(flowScore*0.2 + contrastScore*0.2 + accessScore*0.2 + structureScore*0.2 + frictionScore*0.2);
    
    return {
        flowScore, contrastScore, accessScore, structureScore, frictionScore, overallScore,
        rmsContrast: Math.round(rmsContrast*1000)/10,
        entropy: Math.round(entropy*100)/100,
        negativeSpace,
        edgeDensity: Math.round(edgeDensity*1000)/10,
        wcagRatio: Math.round(wcagRatio*10)/10,
        palette,
        lumHist,
        lumMean: Math.round(lumMean),
        quadrants,
        centerBias: Math.round(centerBias*100),
        aspectRatio: Math.round(aspectRatio*100)/100,
        bestRatioMatch: Math.round(bestRatioMatch*100),
        bestRatioLabel,
        safeZoneCompliance: Math.round(safeZoneCompliance*100),
        harmonyType,
        lum, w, h
    };
}

function rgbToHsl(r,g,b) {
    r/=255;g/=255;b/=255;
    const max=Math.max(r,g,b),min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){h=s=0}else{
        const d=max-min;
        s=l>0.5?d/(2-max-min):d/(max+min);
        switch(max){
            case r:h=((g-b)/d+(g<b?6:0))/6;break;
            case g:h=((b-r)/d+2)/6;break;
            case b:h=((r-g)/d+4)/6;break;
        }
    }
    return [Math.round(h*360),Math.round(s*100),Math.round(l*100)];
}

function rgbToHex(r,g,b) {
    return '#'+[r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
}

// ==================== GENERATE HEATMAP ====================
function generateHeatmap(img, analysis, canvas) {
    const w = Math.min(500, img.width);
    const h = Math.round(w / img.width * img.height);
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    
    // Get pixels for saliency
    const idata = ctx.getImageData(0,0,w,h);
    const d = idata.data;
    const total = w*h;
    const saliency = new Float32Array(total);
    
    // Compute saliency: edge strength + center-bias
    const cxH = w/2, cyH = h/2;
    for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
            const i = y*w+x;
            const off = i*4;
            const l = 0.2126*d[off]+0.7152*d[off+1]+0.0722*d[off+2];
            const lR = 0.2126*d[(i+1)*4]+0.7152*d[(i+1)*4+1]+0.0722*d[(i+1)*4+2];
            const lL = 0.2126*d[(i-1)*4]+0.7152*d[(i-1)*4+1]+0.0722*d[(i-1)*4+2];
            const lD = 0.2126*d[(i+w)*4]+0.7152*d[(i+w)*4+1]+0.0722*d[(i+w)*4+2];
            const lU = 0.2126*d[(i-w)*4]+0.7152*d[(i-w)*4+1]+0.0722*d[(i-w)*4+2];
            const edge = Math.sqrt((lR-lL)**2 + (lD-lU)**2) / 360;
            
            // Center-bias gaussian
            const dx = (x-cxH)/cxH, dy = (y-cyH)/cyH;
            const centerG = Math.exp(-(dx*dx+dy*dy)*1.5);
            
            // Color saturation boost
            const r=d[off],g=d[off+1],b=d[off+2];
            const maxC=Math.max(r,g,b),minC=Math.min(r,g,b);
            const sat = maxC>0?(maxC-minC)/maxC:0;
            
            saliency[i] = Math.min(1, edge*0.5 + centerG*0.35 + sat*0.15);
        }
    }
    
    // Gaussian blur the saliency for smoother heatmap
    const blurred = gaussianBlur(saliency, w, h, 12);
    
    // Normalize
    let maxS = 0;
    for (let i = 0; i < total; i++) if (blurred[i]>maxS) maxS = blurred[i];
    if (maxS > 0) for (let i = 0; i < total; i++) blurred[i] /= maxS;
    
    // Draw heatmap overlay
    const overlay = ctx.createImageData(w, h);
    for (let i = 0; i < total; i++) {
        const v = blurred[i];
        const [hr,hg,hb] = heatColor(v);
        const off = i*4;
        // Blend with original
        const alpha = 0.45;
        overlay.data[off]   = Math.round(d[off]*(1-alpha) + hr*alpha);
        overlay.data[off+1] = Math.round(d[off+1]*(1-alpha) + hg*alpha);
        overlay.data[off+2] = Math.round(d[off+2]*(1-alpha) + hb*alpha);
        overlay.data[off+3] = 255;
    }
    ctx.putImageData(overlay, 0, 0);
}

function gaussianBlur(data, w, h, radius) {
    const out = new Float32Array(data.length);
    const rs = Math.ceil(radius*2.57);
    // Horizontal pass
    const temp = new Float32Array(data.length);
    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
            let val = 0, wsum = 0;
            for (let ix = x-rs; ix <= x+rs; ix++) {
                if (ix>=0 && ix<w) {
                    const dsq = (ix-x)*(ix-x);
                    const wt = Math.exp(-dsq/(2*radius*radius));
                    val += data[y*w+ix]*wt;
                    wsum += wt;
                }
            }
            temp[y*w+x] = val/wsum;
        }
    }
    // Vertical pass
    for (let x = 0; x < w; x++) {
        for (let y = 0; y < h; y++) {
            let val = 0, wsum = 0;
            for (let iy = y-rs; iy <= y+rs; iy++) {
                if (iy>=0 && iy<h) {
                    const dsq = (iy-y)*(iy-y);
                    const wt = Math.exp(-dsq/(2*radius*radius));
                    val += temp[iy*w+x]*wt;
                    wsum += wt;
                }
            }
            out[y*w+x] = val/wsum;
        }
    }
    return out;
}

function heatColor(v) {
    // Blue -> Cyan -> Green -> Yellow -> Red
    if (v < 0.25) {
        const t = v/0.25;
        return [0, Math.round(t*180), Math.round(200-t*50)];
    } else if (v < 0.5) {
        const t = (v-0.25)/0.25;
        return [0, Math.round(180+t*75), Math.round(150-t*150)];
    } else if (v < 0.75) {
        const t = (v-0.5)/0.25;
        return [Math.round(t*255), 255, 0];
    } else {
        const t = (v-0.75)/0.25;
        return [255, Math.round(255-t*200), 0];
    }
}

// ==================== GENERATE RECOMMENDATIONS ====================
function generateRecommendations(a) {
    const recs = [];
    const platform = state.platform;
    const goal = state.goal;
    
    // Contrast issues
    if (a.contrastScore < 60) {
        recs.push({
            priority:'high', title:'Aumenta il Contrasto Generale',
            body:`Il contrasto RMS √® ${a.rmsContrast}% ‚Äî sotto la soglia ottimale. Il rapporto WCAG stimato √® ${a.wcagRatio}:1 ${a.wcagRatio<4.5?'(sotto AA 4.5:1)':a.wcagRatio<7?'(AA ok, sotto AAA 7:1)':'(AAA ok)'}. Usa colori pi√π contrastanti tra testo e sfondo, aumentando la differenza di luminosit√†.`,
            impact: `+${Math.round((80-a.contrastScore)*0.5)}% leggibilit√† stimata`
        });
    } else if (a.wcagRatio < 4.5) {
        recs.push({
            priority:'medium', title:'Migliora Rapporto Contrasto WCAG',
            body:`Rapporto stimato ${a.wcagRatio}:1 ‚Äî sotto AA (4.5:1). Aumenta il contrasto tra gli elementi testuali e lo sfondo per garantire accessibilit√†.`,
            impact: 'Compliance WCAG AA'
        });
    }
    
    // Flow issues
    if (a.flowScore < 55) {
        recs.push({
            priority:'high', title:'Ristruttura il Flusso Visivo',
            body:`Il center-bias √® solo ${a.centerBias}%. L'attenzione √® dispersa invece di convergere verso il centro/CTA. Sposta l'elemento principale nella zona centrale o nel punto di intersezione della regola dei terzi. Usa linee guida visive (frecce, contrasto, spazio negativo) per dirigere lo sguardo.`,
            impact: '+20-30% engagement stimato'
        });
    } else if (a.flowScore < 70) {
        recs.push({
            priority:'medium', title:'Ottimizza il Flusso Visivo',
            body:`Il flusso visivo √® ${a.flowScore}%, con un center-bias del ${a.centerBias}%. Puoi migliorare posizionando l'elemento chiave pi√π vicino al centro ottico (leggermente sopra il centro geometrico) e usando contrasto per guidare l'occhio.`,
            impact: '+10-15% tempo di attenzione'
        });
    }
    
    // High entropy (clutter)
    if (a.entropy > 6.5) {
        recs.push({
            priority:'high', title:'Riduci la Complessit√† Visiva',
            body:`L'entropia Shannon √® ${a.entropy}/8 ‚Äî il contenuto √® molto denso e caotico. Il cervello fatica a processare pi√π di 5-7 elementi. Elimina elementi decorativi, riduci i colori a 3-4, unifica i font e aumenta lo spazio negativo (ora al ${a.negativeSpace}%).`,
            impact: `-${Math.round((a.entropy-5)*15)}% attrito cognitivo`
        });
    } else if (a.entropy > 5.5) {
        recs.push({
            priority:'medium', title:'Semplifica la Composizione',
            body:`Entropia ${a.entropy}/8 con ${a.negativeSpace}% di spazio negativo. C'√® margine per semplificare: punta a 25-35% di spazio negativo per dare respiro visivo e far emergere la CTA.`,
            impact: 'Migliore focus sulla CTA'
        });
    }
    
    // Low negative space
    if (a.negativeSpace < 15) {
        recs.push({
            priority:'high', title:'Aumenta lo Spazio Negativo',
            body:`Solo ${a.negativeSpace}% di spazio negativo ‚Äî il contenuto √® troppo affollato. Design premium usano 30-40% di spazio vuoto. Aggiungi padding, riduci il numero di elementi e lascia respirare il layout.`,
            impact: '+25% percezione qualit√†'
        });
    } else if (a.negativeSpace < 25 && goal !== 'engagement') {
        recs.push({
            priority:'low', title:'Migliora Uso Spazio Negativo',
            body:`Spazio negativo al ${a.negativeSpace}%. Per ${goal==='awareness'?'brand awareness':'conversioni'}, aumentare al 30%+ aiuta a comunicare professionalit√† e chiarezza del messaggio.`,
            impact: 'Layout pi√π professionale'
        });
    }
    
    // Aspect ratio mismatch
    if (a.bestRatioMatch < 70) {
        recs.push({
            priority:'high', title:`Correggi le Proporzioni per ${platform.charAt(0).toUpperCase()+platform.slice(1)}`,
            body:`L'immagine √® ${a.aspectRatio}:1 ma il formato ottimale √® ${a.bestRatioLabel} (compatibilit√† ${a.bestRatioMatch}%). Un crop/resize al formato corretto aumenta significativamente la visibilit√† nel feed.`,
            impact: '+15-25% reach nel feed'
        });
    } else if (a.bestRatioMatch < 90) {
        recs.push({
            priority:'low', title:'Affina le Proporzioni',
            body:`Proporzioni quasi ottimali (${a.bestRatioMatch}% match con ${a.bestRatioLabel}). Un piccolo crop potrebbe migliorare la resa nel feed.`,
            impact: 'Resa visiva migliore nel feed'
        });
    }
    
    // Safe zone issues
    if (a.safeZoneCompliance < 70) {
        recs.push({
            priority:'high', title:'Rispetta le Safe Zones della Piattaforma',
            body:`Il ${100-a.safeZoneCompliance}% degli elementi chiave √® fuori dalle zone sicure. Su ${platform}, i pulsanti dell'interfaccia possono coprire questi contenuti. Riposiziona testi e CTA entro le safe zones.`,
            impact: 'Nessun contenuto coperto dalla UI'
        });
    } else if (a.safeZoneCompliance < 85) {
        recs.push({
            priority:'medium', title:'Migliora il Posizionamento nelle Safe Zones',
            body:`Compliance safe zones al ${a.safeZoneCompliance}%. Alcuni elementi importanti potrebbero essere parzialmente coperti da elementi UI della piattaforma.`,
            impact: 'Migliore visibilit√† contenuti chiave'
        });
    }
    
    // Color harmony
    if (a.harmonyType === 'Mista') {
        recs.push({
            priority:'medium', title:'Armonizza la Palette Colori',
            body:`La palette ha una combinazione mista senza schema armonico chiaro. Scegli uno schema definito (complementare, analogo o monocromatico) per rafforzare l'identit√† visiva e ridurre il carico cognitivo.`,
            impact: 'Brand identity pi√π forte'
        });
    }
    
    // Brightness
    if (a.lumMean < 60) {
        recs.push({
            priority:'low', title:'Valuta la Luminosit√† Complessiva',
            body:`L'immagine √® piuttosto scura (luminosit√† media ${a.lumMean}/255). Su mobile con luminosit√† bassa, potrebbe risultare poco leggibile. Valuta di schiarire leggermente o di usare testo chiaro con buon contrasto.`,
            impact: 'Migliore leggibilit√† su mobile'
        });
    } else if (a.lumMean > 210) {
        recs.push({
            priority:'low', title:'Attenzione alla Luminosit√† Elevata',
            body:`Immagine molto chiara (luminosit√† media ${a.lumMean}/255). Potrebbe risultare "lavata" in feed con sfondo bianco. Assicurati che gli elementi chiave abbiano sufficiente contrasto.`,
            impact: 'Maggiore risalto nel feed'
        });
    }
    
    // Goal-specific
    if (goal === 'sales' && a.contrastScore < 75) {
        recs.push({
            priority:'medium', title:'Evidenzia la CTA per le Conversioni',
            body:`Per l'obiettivo vendite, la CTA deve emergere con forza. Con un contrasto del ${a.contrastScore}%, la CTA potrebbe perdersi. Usa un colore ad alto contrasto (complementare allo sfondo) e dimensioni generose per il pulsante/testo di azione.`,
            impact: '+20-35% CTR stimato'
        });
    }
    
    if (goal === 'engagement' && a.flowScore > 70) {
        recs.push({
            priority:'low', title:'Aggiungi un Elemento di Curiosit√†',
            body:`Per massimizzare l'engagement, considera di aggiungere un elemento visivo che stimoli la curiosit√† (domanda nel testo, immagine parzialmente rivelata, pattern interrotto). Questo incentiva commenti e condivisioni.`,
            impact: '+15% engagement rate'
        });
    }
    
    // Sort by priority
    const priorityOrder = {high:0, medium:1, low:2};
    recs.sort((a,b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
    
    // Add fallback if no recs
    if (recs.length === 0) {
        recs.push({
            priority:'low', title:'Ottima Base ‚Äî Affina i Dettagli',
            body:'I punteggi sono buoni! Per migliorare ulteriormente, conduci A/B test con varianti di colore CTA e posizionamento testo.',
            impact:'Ottimizzazione incrementale'
        });
    }
    
    return recs.slice(0, 7); // max 7 recommendations
}

// ==================== RENDER DASHBOARD ====================
function renderDashboard(a, img) {
    secLoader.classList.add('swa-hidden');
    secDashboard.classList.remove('swa-hidden');
    secDashboard.classList.add('swa-fade-in');
    $('navActions').classList.remove('swa-hidden');
    
    const recs = generateRecommendations(a);
    state.analysis.recommendations = recs;
    
    // Context bar
    const pNames = {instagram:'Instagram',tiktok:'TikTok/Reels',linkedin:'LinkedIn',facebook:'Facebook',web:'Web/Landing'};
    const gNames = {sales:'Vendite / Conversioni',awareness:'Brand Awareness',engagement:'Engagement',leads:'Lead Generation',traffic:'Traffico Sito'};
    const pBadge = {instagram:'swa-badge-instagram',tiktok:'swa-badge-tiktok',linkedin:'swa-badge-linkedin',facebook:'swa-badge-facebook',web:'swa-badge-web'};
    const gBadge = {sales:'swa-badge-sales',awareness:'swa-badge-awareness',engagement:'swa-badge-engagement',leads:'swa-badge-leads',traffic:'swa-badge-traffic'};
    
    $('contextBar').innerHTML = `
        <div class="swa-context-item"><label><i class="fas fa-mobile-alt"></i> Piattaforma</label><div class="value"><span class="swa-badge ${pBadge[state.platform]}">${pNames[state.platform]}</span></div></div>
        <div class="swa-context-item"><label><i class="fas fa-bullseye"></i> Obiettivo</label><div class="value"><span class="swa-badge ${gBadge[state.goal]}">${gNames[state.goal]}</span></div></div>
        <div class="swa-context-item"><label><i class="fas fa-user-group"></i> Target</label><div class="value">${state.target||'Non specificato'}</div></div>
        <div class="swa-context-item"><label><i class="fas fa-ruler-combined"></i> Dimensioni</label><div class="value">${a.imgWidth}√ó${a.imgHeight}px (${a.aspectRatio}:1)</div></div>
    `;
    
    // Overall score ring
    const circumference = 2 * Math.PI * 52;
    const offset = circumference - (a.overallScore/100) * circumference;
    $('overallRing').style.strokeDashoffset = offset;
    animateNumber($('overallScore'), a.overallScore, '%');
    
    // Verdict
    renderVerdict(a.overallScore);
    
    // Score cards
    const cards = [
        {key:'flow', label:'Flusso Visivo', value:a.flowScore, method:'Center-bias + quadranti', color:'#8b5cf6', unit:'%'},
        {key:'contrast', label:'Contrasto', value:a.contrastScore, method:`RMS ${a.rmsContrast}% ‚Ä¢ WCAG ~${a.wcagRatio}:1`, color:'#ec4899', unit:'%'},
        {key:'access', label:'Leggibilit√†', value:a.accessScore, method:`Ratio match ${a.bestRatioMatch}% ‚Ä¢ Safe ${a.safeZoneCompliance}%`, color:'#3b82f6', unit:'%'},
        {key:'structure', label:'Struttura', value:a.structureScore, method:`Spazio ${a.negativeSpace}% ‚Ä¢ ${a.harmonyType}`, color:'#f59e0b', unit:'%'},
        {key:'friction', label:'Semplicit√†', value:a.frictionScore, method:`Entropia ${a.entropy}/8 ‚Ä¢ Edge ${a.edgeDensity}%`, color:'#ef4444', unit:'%'}
    ];
    
    $('scoresGrid').innerHTML = cards.map(c => `
        <div class="swa-score-card glass">
            <span class="swa-real-badge">REALE</span>
            <p class="swa-score-label">${c.label}</p>
            <p class="swa-score-value" style="color:${c.color}" data-target="${c.value}" data-unit="${c.unit}">0${c.unit}</p>
            <p class="swa-score-method"><i class="fas fa-microscope"></i> ${c.method}</p>
            <div class="swa-score-bar"><div class="swa-score-bar-fill" style="background:${c.color}" data-width="${c.value}%"></div></div>
        </div>
    `).join('');
    
    // Animate scores
    setTimeout(() => {
        document.querySelectorAll('.swa-score-value[data-target]').forEach(el => {
            animateNumber(el, parseInt(el.dataset.target), el.dataset.unit);
        });
        document.querySelectorAll('.swa-score-bar-fill').forEach(el => {
            el.style.width = el.dataset.width;
        });
    }, 100);
    
    // Heatmap
    const heatCanvas = document.createElement('canvas');
    generateHeatmap(img, a, heatCanvas);
    $('heatmapBox').innerHTML = '';
    $('heatmapBox').appendChild(heatCanvas);
    
    // Palette
    $('paletteBox').innerHTML = a.palette.map(c => {
        const hex = rgbToHex(c.r,c.g,c.b);
        const [h,s,l] = rgbToHsl(c.r,c.g,c.b);
        return `<div class="swa-color-swatch">
            <div class="swa-color-circle" style="background:${hex}" title="${hex} ‚Äî HSL(${h}¬∞,${s}%,${l}%)"></div>
            <span class="swa-color-hex">${hex}</span>
            <span class="swa-color-pct">${c.pct}%</span>
        </div>`;
    }).join('');
    
    // Histogram
    drawHistogram(a.lumHist, $('histogramCanvas'));
    
    // Color harmony
    $('colorHarmonyBox').innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:0.85rem;font-weight:700">Armonia:</span>
            <span style="padding:3px 10px;border-radius:8px;font-size:0.8rem;font-weight:700;background:rgba(139,92,246,0.15);color:var(--accent-light)">${a.harmonyType}</span>
            <span style="font-size:0.8rem;color:rgba(255,255,255,0.4)">‚Ä¢ Luminosit√† media: ${a.lumMean}/255</span>
        </div>
    `;
    
    // Recommendations
    $('recsSection').innerHTML = `
        <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:20px">üéØ Raccomandazioni Strategiche (${recs.length})</h3>
        ${recs.map((r,i) => `
            <div class="swa-rec-card glass priority-${r.priority}">
                <div class="swa-rec-header">
                    <div class="swa-rec-num ${r.priority}">${i+1}</div>
                    <div class="swa-rec-title">${r.title}</div>
                </div>
                <div class="swa-rec-body">${r.body}</div>
                <span class="swa-rec-impact">‚Üó ${r.impact}</span>
            </div>
        `).join('')}
    `;
    
    // Metrics table
    $('metricsTable').innerHTML = `
        <thead><tr><th>Metrica</th><th>Valore Misurato</th><th>Benchmark</th><th>Status</th></tr></thead>
        <tbody>
            <tr><td>Flusso Visivo</td><td>${a.flowScore}%</td><td>‚â• 70%</td><td>${statusIcon(a.flowScore,70)}</td></tr>
            <tr><td>Contrasto RMS</td><td>${a.rmsContrast}%</td><td>15-30%</td><td>${statusIcon(a.rmsContrast >= 15 && a.rmsContrast <= 35 ? 80 : 40, 70)}</td></tr>
            <tr><td>WCAG Ratio (stimato)</td><td>${a.wcagRatio}:1</td><td>‚â• 4.5:1 (AA)</td><td>${statusIcon(a.wcagRatio>=4.5?90:a.wcagRatio>=3?60:30, 70)}</td></tr>
            <tr><td>Entropia Shannon</td><td>${a.entropy}/8</td><td>‚â§ 5.5</td><td>${statusIcon(a.entropy<=5.5?90:a.entropy<=6.5?60:30, 70)}</td></tr>
            <tr><td>Spazio Negativo</td><td>${a.negativeSpace}%</td><td>25-40%</td><td>${statusIcon(a.negativeSpace>=20&&a.negativeSpace<=45?85:50, 70)}</td></tr>
            <tr><td>Densit√† Bordi</td><td>${a.edgeDensity}%</td><td>‚â§ 8%</td><td>${statusIcon(a.edgeDensity<=8?90:a.edgeDensity<=12?60:30, 70)}</td></tr>
            <tr><td>Match Formato</td><td>${a.bestRatioMatch}%</td><td>‚â• 85%</td><td>${statusIcon(a.bestRatioMatch,85)}</td></tr>
            <tr><td>Safe Zones</td><td>${a.safeZoneCompliance}%</td><td>‚â• 85%</td><td>${statusIcon(a.safeZoneCompliance,85)}</td></tr>
            <tr><td>Armonia Colori</td><td>${a.harmonyType}</td><td>Schema definito</td><td>${a.harmonyType!=='Mista'?'<span style="color:var(--green)">‚úì Ok</span>':'<span style="color:var(--amber)">‚ö† Da migliorare</span>'}</td></tr>
        </tbody>
    `;
    
    // Render AI prompts
    renderAllPrompts();
    
    // Render media recommendation
    renderMediaRecommendation(a);
    
    // Render strategic analysis
    renderStrategicAnalysis(a);
    
    // Render strategy score
    renderStrategyScore();
}

// ==================== MEDIA TYPE RECOMMENDATION ====================
function renderMediaRecommendation(a) {
    const section = $('mediaRecSection');
    const content = $('mediaRecContent');
    const platform = state.platform;
    const goal = state.goal;
    
    // Media matrix: primary + alternative based on goal/platform/analysis
    const rec = getMediaRecommendation(platform, goal, a);
    
    let html = '';
    // Primary
    html += `<div class="swa-media-option primary">`;
    html += `<div class="swa-media-icon"><i class="fas ${rec.primary.icon}"></i></div>`;
    html += `<div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span class="swa-media-label">${rec.primary.label}</span><span class="swa-media-badge rec">Consigliato</span></div>`;
    html += `<div class="swa-media-reason">${rec.primary.reason}</div></div></div>`;
    
    // Alternative
    if (rec.alt) {
        html += `<div class="swa-media-option alt">`;
        html += `<div class="swa-media-icon"><i class="fas ${rec.alt.icon}"></i></div>`;
        html += `<div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span class="swa-media-label">${rec.alt.label}</span><span class="swa-media-badge alt-badge">Alternativa</span></div>`;
        html += `<div class="swa-media-reason">${rec.alt.reason}</div></div></div>`;
    }
    
    // Ambiguity warning if applicable
    if (rec.ambiguityRisk) {
        html += `<div style="margin-top:12px;padding:10px 14px;border-radius:10px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);display:flex;align-items:center;gap:8px">`;
        html += `<i class="fas fa-triangle-exclamation" style="color:#fbbf24"></i>`;
        html += `<span style="font-size:0.8rem;color:rgba(255,255,255,0.5)">${rec.ambiguityRisk}</span></div>`;
    }
    
    content.innerHTML = html;
    section.style.display = 'block';
    
    // Auto-fill Tipo Media select if empty
    const tipoSelect = $('fieldTipoMedia');
    if (tipoSelect && !tipoSelect.value) {
        const labelMap = {'Immagine Singola':'Immagine singola','Immagine + Domanda':'Immagine singola','Immagine con Link':'Immagine singola','Carosello':'Carosello','Carosello / Documento':'Carosello','Carosello Teaser':'Carosello','Reel / Video Breve':'Reel / Video breve','Video con CTA':'Reel / Video breve','Video Breve':'Reel / Video breve','Testo con Immagine':'Immagine singola'};
        const match = labelMap[rec.primary.label];
        if (match) { for (const opt of tipoSelect.options) { if (opt.value === match) { tipoSelect.value = match; break; } } }
    }
}

function getMediaRecommendation(platform, goal, a) {
    const entropy = a.entropy;
    const complexity = a.edgeDensity;
    const score = a.overallScore;
    
    // MATRICE VINCOLANTE (from framework)
    // IMMAGINE ‚Üí messaggio singolo / annuncio
    // CAROSELLO ‚Üí spiegazione / lista / guida
    // REEL ‚Üí dimostrazione / processo
    // VIDEO ‚Üí formazione / approfondimento
    // TESTO ‚Üí opinione / insight
    
    let primary, alt, ambiguityRisk;
    
    if (goal === 'sales') {
        primary = {label:'Immagine Singola', icon:'fa-image', reason:'Messaggio singolo e diretto. Per vendita/promozione l\'immagine con CTA chiara √® il formato pi√π efficace: impatto immediato, caricamento veloce, massima compatibilit√†.'};
        if (platform === 'instagram' || platform === 'tiktok') {
            alt = {label:'Reel / Video Breve', icon:'fa-film', reason:'Dimostrazione prodotto in azione. I video brevi aumentano il tempo di permanenza e la conversione, specialmente per prodotti fisici.'};
        } else {
            alt = {label:'Carosello', icon:'fa-images', reason:'Se il contenuto include pi√π punti di forza, prezzi comparati o step di utilizzo, il carosello permette di approfondire senza perdere l\'utente.'};
        }
    } else if (goal === 'awareness') {
        if (platform === 'tiktok') {
            primary = {label:'Reel / Video Breve', icon:'fa-film', reason:'Per awareness su TikTok il formato nativo video √® imprescindibile. Mostra il brand in azione, racconta una storia breve, crea ricordo.'};
            alt = {label:'Immagine Singola', icon:'fa-image', reason:'Alternativa per contenuti pi√π statici o citazioni di brand. Meno performante su questa piattaforma ma utile per coerenza visiva.'};
        } else if (platform === 'linkedin') {
            primary = {label:'Carosello / Documento', icon:'fa-images', reason:'Su LinkedIn i documenti carosello (PDF) generano il pi√π alto tasso di impressioni. Ideali per posizionamento come autorit√† di settore.'};
            alt = {label:'Testo con Immagine', icon:'fa-align-left', reason:'Post di opinione con immagine di supporto. Su LinkedIn i post testuali autentici con insight personali performano molto bene per brand awareness.'};
        } else {
            primary = {label:'Immagine Singola', icon:'fa-image', reason:'Immagine forte e riconoscibile per costruire identit√† visiva. L\'impatto immediato rafforza il ricordo del brand.'};
            alt = {label:'Video Breve', icon:'fa-film', reason:'Il video permette di raccontare la storia del brand con maggiore profondit√† emotiva e aumenta il tempo di interazione.'};
        }
    } else if (goal === 'engagement') {
        if (platform === 'tiktok' || platform === 'instagram') {
            primary = {label:'Reel / Video Breve', icon:'fa-film', reason:'I reel generano il pi√π alto engagement rate. Domande, behind-the-scenes, contenuti relatable in formato video breve massimizzano like, commenti e condivisioni.'};
            alt = {label:'Carosello', icon:'fa-images', reason:'I caroselli aumentano il tempo di permanenza e i salvataggi. Utili per liste, confronti o contenuti educativi che invitano all\'interazione.'};
        } else {
            primary = {label:'Immagine + Domanda', icon:'fa-image', reason:'Immagine d\'impatto con domanda nel testo. Su questa piattaforma le domande dirette nel post generano il massimo engagement nei commenti.'};
            alt = {label:'Carosello', icon:'fa-images', reason:'Alternativa per contenuti che richiedono pi√π slide (sondaggi visivi, confronti, guide). Aumentano tempo di fruizione e salvataggi.'};
        }
    } else if (goal === 'leads') {
        primary = {label:'Immagine Singola', icon:'fa-image', reason:'Lead generation richiede chiarezza immediata. Immagine con proposta di valore + CTA verso form/DM/link. Meno frizione = pi√π conversioni.'};
        if (platform === 'linkedin') {
            alt = {label:'Carosello / Documento', icon:'fa-images', reason:'Su LinkedIn un carosello che anticipa il valore della risorsa (es. "5 insight dal nostro report") √® molto efficace per generare lead qualificati.'};
        } else {
            alt = {label:'Video con CTA', icon:'fa-film', reason:'Breve video che mostra il problema + teaser della soluzione. La dimostrazione visiva del valore aumenta la qualit√† del lead.'};
        }
    } else if (goal === 'traffic') {
        primary = {label:'Immagine con Link', icon:'fa-image', reason:'Per generare traffico serve semplicit√†: immagine che crea curiosit√† + link chiaro. Formato pi√π diretto per il click-through.'};
        alt = {label:'Carosello Teaser', icon:'fa-images', reason:'Carosello che anticipa i punti chiave dell\'articolo/pagina senza rivelarli tutti. Crea curiosity gap che spinge al click.'};
    }
    
    // Ambiguity check based on visual analysis
    if (entropy > 6 && complexity > 12) {
        ambiguityRisk = 'Rischio ambiguit√† visiva: alta complessit√† nell\'immagine. Un osservatore potrebbe non identificare immediatamente il settore/messaggio. Considerare una versione pi√π pulita.';
    } else if (a.harmonyType === 'Mista' && score < 60) {
        ambiguityRisk = 'Attenzione: la composizione attuale potrebbe risultare ambigua. Verificare che il contenuto visivo sia coerente con il settore e l\'obiettivo dichiarato.';
    }
    
    return {primary, alt, ambiguityRisk};
}

function statusIcon(value, threshold) {
    if (value >= threshold) return `<span style="color:var(--green);font-weight:700">‚úì Buono</span>`;
    if (value >= threshold*0.7) return `<span style="color:var(--amber);font-weight:700">‚ö† Migliorabile</span>`;
    return `<span style="color:var(--red);font-weight:700">‚úó Critico</span>`;
}

// ==================== STRATEGIC ANALYSIS ====================
function getFieldVal(id) { const el = $(id); return el ? el.value.trim() : ''; }

function calculateStrategyScore() {
    const fields = [
        {id:'fieldScopo', weight:12, label:'Scopo'},
        {id:'fieldObiettivo', weight:12, label:'Obiettivo'},
        {id:'fieldTipoMedia', weight:8, label:'Media'},
        {id:'fieldSottotipo', weight:6, label:'Sottotipo'},
        {id:'fieldSettore', weight:10, label:'Settore'},
        {id:'fieldPubblico', weight:12, label:'Pubblico'},
        {id:'fieldTitolo1', weight:10, label:'Titolo'},
        {id:'fieldTitolo2', weight:4, label:'Titolo 2'},
        {id:'fieldTitolo3', weight:3, label:'Titolo 3'},
        {id:'fieldDidascalia', weight:10, label:'Didascalia'},
        {id:'fieldContesto', weight:8, label:'Contesto'},
        {id:'contentDataInput', weight:5, label:'Dati'}
    ];
    let score = 0, filled = 0, total = fields.length;
    const details = [];
    for (const f of fields) {
        const v = getFieldVal(f.id);
        const ok = v.length > 0;
        if (ok) { score += f.weight; filled++; }
        details.push({label:f.label, ok});
    }
    // Bonus for platform+goal selection (always filled from step 1-2)
    score += 10;
    return {score: Math.min(100, score), filled, total, details};
}

function renderStrategyScore() {
    const sec = $('strategyScoreSection');
    const ss = calculateStrategyScore();
    const circ = 2 * Math.PI * 52;
    const offset = circ - (ss.score/100) * circ;
    
    sec.style.display = 'block';
    setTimeout(() => {
        $('stratRing').style.strokeDashoffset = offset;
        $('stratScoreNum').textContent = ss.score + '%';
    }, 200);
    
    const v = ss.score >= 80 ? 'Strategia solida' : ss.score >= 55 ? 'Buona base ‚Äî completa i campi mancanti' : ss.score >= 30 ? 'Dati parziali ‚Äî compila per analisi completa' : 'Compila i campi per attivare l\'analisi strategica';
    $('stratScoreDesc').textContent = v;
    
    $('stratCompleteness').innerHTML = ss.details.map(d => 
        `<span style="padding:3px 8px;border-radius:6px;font-size:0.65rem;font-weight:700;${d.ok?'background:rgba(16,185,129,0.15);color:#34d399':'background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.2)'}">${d.ok?'‚úì':'‚óã'} ${d.label}</span>`
    ).join('');
}

function renderVerdict(score) {
    const v = getScoreVerdict(score);
    $('verdictBadge').className = 'swa-verdict ' + v.cls;
    $('verdictBadge').innerHTML = `${v.emoji} ${v.label}`;
}

function generateStrategicData(a) {
    const nd = 'Non determinabile';
    const F = {
        scopo: getFieldVal('fieldScopo'),
        obiettivo: getFieldVal('fieldObiettivo'),
        tipoMedia: getFieldVal('fieldTipoMedia'),
        sottotipo: getFieldVal('fieldSottotipo'),
        settore: getFieldVal('fieldSettore'),
        pubblico: getFieldVal('fieldPubblico'),
        titolo1: getFieldVal('fieldTitolo1'),
        titolo2: getFieldVal('fieldTitolo2'),
        titolo3: getFieldVal('fieldTitolo3'),
        didascalia: getFieldVal('fieldDidascalia'),
        contesto: getFieldVal('fieldContesto'),
        datiExtra: getFieldVal('contentDataInput')
    };
    const platform = state.platform;
    const goal = state.goal;
    const target = state.target;
    
    const goalMap = {sales:'Vendita / Conversione', awareness:'Brand Awareness', engagement:'Engagement', leads:'Lead Generation', traffic:'Traffico al sito'};
    const allText = [F.titolo1, F.titolo2, F.titolo3, F.didascalia, F.contesto, F.datiExtra].filter(Boolean).join(' ').toLowerCase();
    
    // ‚îÄ‚îÄ FUNNEL ‚îÄ‚îÄ
    let funnel = nd;
    if (goal === 'awareness') funnel = 'TOFU ‚Äî Top of Funnel (consapevolezza)';
    else if (goal === 'engagement' || goal === 'traffic') funnel = 'MOFU ‚Äî Middle of Funnel (considerazione)';
    else if (goal === 'sales' || goal === 'leads') funnel = 'BOFU ‚Äî Bottom of Funnel (decisione)';
    if (allText.match(/scopri|conosci|novit√†|presentiamo|annuncio|benvenuto/)) funnel = 'TOFU ‚Äî Top of Funnel (consapevolezza)';
    if (allText.match(/iscriviti|prenota|acquista|sconto|offerta|promo|gratis|‚Ç¨|prezzo/)) funnel = 'BOFU ‚Äî Bottom of Funnel (decisione)';
    
    // ‚îÄ‚îÄ TONE ‚îÄ‚îÄ
    let tono = nd;
    const brightness = a.avgBrightness;
    const contrast = a.rmsContrast;
    if (brightness > 170 && contrast < 50) tono = 'Soft, accogliente, rassicurante';
    else if (contrast > 80) tono = 'Bold, diretto, d\'impatto';
    else if (brightness > 130 && brightness < 170) tono = 'Professionale, equilibrato';
    else if (brightness < 100) tono = 'Elegante, sofisticato, premium';
    else tono = 'Neutro, informativo';
    
    // ‚îÄ‚îÄ ORGANIC VS SPONSORED ‚îÄ‚îÄ
    let organicOrSponsored = 'Organico (probabile)';
    let organicReason = 'Nessun elemento promozionale diretto rilevato.';
    if (allText.match(/sconto|offerta|promo|‚Ç¨|prezzo|acquista|compra|shop|spedizione|gratis/)) {
        organicOrSponsored = 'Sponsorizzato (probabile)';
        organicReason = 'Presenza di elementi promozionali (prezzo, sconto, offerta) che beneficiano di reach a pagamento.';
    }
    if (allText.match(/scopri di pi√π|link in bio|clicca|visita/)) {
        organicOrSponsored = 'Sponsorizzato (probabile)';
        organicReason = 'CTA con rimando esterno ‚Äî la sponsorizzazione aumenta il CTR del 2-5x.';
    }
    if (goal === 'sales' || goal === 'leads') {
        organicOrSponsored = 'Sponsorizzato (consigliato)';
        organicReason = `Per l'obiettivo "${goalMap[goal]}", la sponsorizzazione √® quasi sempre necessaria per raggiungere un pubblico mirato.`;
    }
    
    // ‚îÄ‚îÄ UNIQUE OBJECTIVE ‚îÄ‚îÄ
    let uniqueObj = 'Commenti';
    let uniqueObjReason = '';
    if (goal === 'leads') { uniqueObj = 'DM / Contatto'; uniqueObjReason = 'Lead generation richiede un\'azione di contatto diretto.'; }
    else if (goal === 'traffic') { uniqueObj = 'Click / Link'; uniqueObjReason = 'Obiettivo traffico = priorit√† al click-through.'; }
    else if (goal === 'sales') { uniqueObj = 'Acquisto / Download'; uniqueObjReason = 'Conversione diretta ‚Äî CTA deve essere inequivocabile.'; }
    else if (goal === 'engagement') { uniqueObj = 'Commenti / Salvataggi'; uniqueObjReason = 'L\'engagement premia commenti e salvataggi (boost algoritmico).'; }
    else if (goal === 'awareness') { uniqueObj = 'Impressioni / Reach'; uniqueObjReason = 'Brand awareness = massimizzare le impressioni.'; }
    if (allText.match(/download|scarica|pdf|ebook|guida/)) { uniqueObj = 'Download'; uniqueObjReason = 'Risorsa scaricabile presente ‚Üí obiettivo download.'; }
    if (allText.match(/commenta|tag|condividi|dimmi|racconta/)) { uniqueObj = 'Commenti'; uniqueObjReason = 'CTA engagement esplicita nel testo.'; }
    if (allText.match(/scrivici|dm|messaggio|whatsapp|contatt/)) { uniqueObj = 'DM / Contatto'; uniqueObjReason = 'CTA contatto diretto nel testo.'; }
    
    // ‚îÄ‚îÄ DIRECTNESS ‚îÄ‚îÄ
    let directness = 'Chiaro ma gentile';
    let directnessReason = '';
    if (funnel.includes('TOFU')) { directness = 'Molto soft'; directnessReason = 'Fase iniziale del funnel: il pubblico non √® ancora pronto per proposte dirette. Meglio informare e incuriosire.'; }
    if (funnel.includes('BOFU')) { directness = 'Pi√π deciso'; directnessReason = 'Fase decisionale: il pubblico √® pronto. Essere chiari su cosa fare e perch√© agisce ora.'; }
    if (goal === 'engagement') { directness = 'Chiaro ma gentile'; directnessReason = 'Per engagement, un tono troppo commerciale scoraggia i commenti. Proponi, non spingere.'; }
    
    // ‚îÄ‚îÄ VALUE PROMISE ‚îÄ‚îÄ
    let promessa = nd;
    if (allText.match(/impara|scopri come|ti insegn|corso|formazione|lezione|master/)) promessa = 'Formazione / apprendimento';
    if (allText.match(/risparm|sconto|offerta|gratis|omaggio|convenien/)) promessa = 'Vantaggio economico / risparmio';
    if (allText.match(/trasform|cambia|migliora|risultat|prima.*dopo/)) promessa = 'Trasformazione / miglioramento';
    if (allText.match(/esclusiv|limit|solo per|riservato|ultimo/)) promessa = 'Esclusivit√† / accesso privilegiato';
    if (allText.match(/facil|semplice|veloce|immediat|subito/)) promessa = 'Semplicit√† / velocit√†';
    if (allText.match(/garanzi|sicur|certific|qualit√†|professional/)) promessa = 'Affidabilit√† / garanzia di qualit√†';
    
    // ‚îÄ‚îÄ COMMERCIAL MESSAGE ‚îÄ‚îÄ
    let messaggio = nd;
    if (goal === 'sales') messaggio = 'Messaggio commerciale diretto';
    if (goal === 'awareness') messaggio = 'Posizionamento / educativo';
    if (goal === 'engagement') messaggio = 'Relazionale / community building';
    if (goal === 'leads') messaggio = 'Generazione contatti / lead magnet';
    if (goal === 'traffic') messaggio = 'Contenuto di valore + rimando';
    
    // ‚îÄ‚îÄ CTA ANALYSIS ‚îÄ‚îÄ
    let ctaDetected = nd;
    let ctaType = nd;
    const ctaPatterns = [
        {rx:/scopri di pi√π|leggi|approfondisci/i, type:'Informativa', label:'Scopri di pi√π'},
        {rx:/iscriviti|registrati|partecipa/i, type:'Lead', label:'Iscrizione / Registrazione'},
        {rx:/acquista|compra|ordina|shop/i, type:'Vendita diretta', label:'Acquisto'},
        {rx:/scarica|download|ottieni/i, type:'Lead magnet', label:'Download'},
        {rx:/prenota|riserva|fissa/i, type:'Booking', label:'Prenotazione'},
        {rx:/commenta|dimmi|raccontaci|tag/i, type:'Engagement', label:'Commenta / Tagga'},
        {rx:/scrivici|dm|messaggio|contatt|chiama|whatsapp/i, type:'Contatto diretto', label:'Contatto DM/Telefono'},
        {rx:/link in bio|swipe up|clicca/i, type:'Traffic', label:'Click / Link in bio'},
        {rx:/condividi|invia|passa parola/i, type:'Virale', label:'Condivisione'},
        {rx:/salva|metti like|segui/i, type:'Follow/Save', label:'Salva / Segui'}
    ];
    for (const p of ctaPatterns) {
        if (p.rx.test(allText)) { ctaDetected = p.label; ctaType = p.type; break; }
    }
    
    // ‚îÄ‚îÄ HOOK ANALYSIS ‚îÄ‚îÄ
    let hookType = nd;
    if (F.didascalia) {
        const firstLine = F.didascalia.split('\n')[0].toLowerCase();
        if (firstLine.match(/\?/)) hookType = 'Domanda (ottimo per engagement)';
        else if (firstLine.match(/^\d|numeri|step|modi|consigli|trucchi|errori/)) hookType = 'Lista numerata (pattern interrupt)';
        else if (firstLine.match(/sai che|lo sapevi|attenzione|incredibile|assurdo/)) hookType = 'Curiosit√† / Shock (scroll-stopper)';
        else if (firstLine.match(/^io |^noi |^quando |storia|racconto/)) hookType = 'Storytelling (connessione emotiva)';
        else if (firstLine.match(/novit√†|nuovo|lancio|finalmente|annuncio/)) hookType = 'Annuncio / News (FOMO)';
        else if (firstLine.match(/gratis|sconto|offerta|risparmia/)) hookType = 'Offerta diretta (BOFU)';
        else hookType = 'Dichiarativo (neutro ‚Äî considera un hook pi√π forte)';
    }
    
    // ‚îÄ‚îÄ CONTENT-AUDIENCE ALIGNMENT ‚îÄ‚îÄ
    let alignment = nd;
    if (F.pubblico && (F.scopo || F.didascalia)) {
        const pub = F.pubblico.toLowerCase();
        const cont = (F.scopo + ' ' + (F.didascalia||'')).toLowerCase();
        let alignScore = 0;
        // Age-content match
        if (pub.match(/giovan|gen z|teen/) && cont.match(/trend|viral|reel|challenge/)) alignScore += 2;
        if (pub.match(/professionis|manager|hr|b2b/) && cont.match(/business|strateg|roi|kpi|risultat/)) alignScore += 2;
        if (pub.match(/donn|mamm|femminil/) && cont.match(/benesser|cura|natura|famiglia|equilibrio/)) alignScore += 2;
        // Generic alignment bonus
        if (F.settore && cont.includes(F.settore.toLowerCase().split('/')[0].trim())) alignScore += 1;
        if (alignScore >= 2) alignment = 'Buon allineamento contenuto-pubblico ‚úì';
        else if (alignScore >= 1) alignment = 'Allineamento parziale ‚Äî verifica la coerenza';
        else alignment = 'Verifica che il messaggio parli al tuo target specifico';
    }
    
    return {
        argomento: F.scopo || F.titolo1 || nd,
        promessa, prodotto: F.sottotipo || nd, messaggio,
        copyOriginale: F.didascalia || nd,
        contestoBusiness: F.contesto || nd,
        brand: F.titolo1 || nd,
        tema: F.scopo || goalMap[goal] || nd,
        obiettivo: F.obiettivo || goalMap[goal],
        targetAnalisi: F.pubblico || target || nd,
        funnel, tono, settore: F.settore || nd,
        tipoMedia: F.tipoMedia || nd,
        organicOrSponsored, organicReason,
        uniqueObj, uniqueObjReason,
        directness, directnessReason,
        ctaDetected, ctaType, hookType, alignment,
        F
    };
}

function renderStrategicAnalysis(a) {
    const section = $('strategicSection');
    const d = generateStrategicData(a);
    const nd = 'Non determinabile';
    const ss = calculateStrategyScore();
    
    // ‚îÄ‚îÄ 3 QUICK ANSWERS with reasons ‚îÄ‚îÄ
    const qaHtml = `
    <div class="swa-qa-card">
        <div class="swa-qa-q">1. Post organico o sponsorizzato?</div>
        <div class="swa-qa-answer"><span class="dot" style="background:${d.organicOrSponsored.includes('Organico')?'#22c55e':'#f59e0b'}"></span>${d.organicOrSponsored}</div>
        <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:8px;line-height:1.5">${d.organicReason}</div>
    </div>
    <div class="swa-qa-card">
        <div class="swa-qa-q">2. Obiettivo unico</div>
        <div class="swa-qa-opts">
            <div class="swa-qa-opt ${d.uniqueObj.includes('Download')?'active':''}"><span class="box">${d.uniqueObj.includes('Download')?'‚úì':''}</span>Download</div>
            <div class="swa-qa-opt ${d.uniqueObj.includes('Commenti')||d.uniqueObj.includes('Salvataggi')?'active':''}"><span class="box">${d.uniqueObj.includes('Commenti')||d.uniqueObj.includes('Salvataggi')?'‚úì':''}</span>Commenti / Salvataggi</div>
            <div class="swa-qa-opt ${d.uniqueObj.includes('DM')||d.uniqueObj.includes('Contatto')?'active':''}"><span class="box">${d.uniqueObj.includes('DM')||d.uniqueObj.includes('Contatto')?'‚úì':''}</span>DM / Contatto</div>
            <div class="swa-qa-opt ${d.uniqueObj.includes('Click')||d.uniqueObj.includes('Acquisto')||d.uniqueObj.includes('Impressioni')?'active':''}"><span class="box">${d.uniqueObj.includes('Click')||d.uniqueObj.includes('Acquisto')||d.uniqueObj.includes('Impressioni')?'‚úì':''}</span>${d.uniqueObj.includes('Acquisto')?'Acquisto':d.uniqueObj.includes('Impressioni')?'Reach / Impressioni':'Click / Link'}</div>
        </div>
        <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:8px;line-height:1.5">${d.uniqueObjReason}</div>
    </div>
    <div class="swa-qa-card">
        <div class="swa-qa-q">3. Quanto diretto posso essere?</div>
        <div class="swa-qa-opts">
            <div class="swa-qa-opt ${d.directness==='Molto soft'?'active':''}"><span class="box">${d.directness==='Molto soft'?'‚úì':''}</span>Molto soft</div>
            <div class="swa-qa-opt ${d.directness==='Chiaro ma gentile'?'active':''}"><span class="box">${d.directness==='Chiaro ma gentile'?'‚úì':''}</span>Chiaro ma gentile</div>
            <div class="swa-qa-opt ${d.directness==='Pi√π deciso'?'active':''}"><span class="box">${d.directness==='Pi√π deciso'?'‚úì':''}</span>Pi√π deciso</div>
        </div>
        <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:8px;line-height:1.5">${d.directnessReason}</div>
    </div>`;
    $('quickAnswers').innerHTML = qaHtml;
    
    // ‚îÄ‚îÄ Helper: build a row ‚îÄ‚îÄ
    function row(icon, label, value, status, tip) {
        // status: 'green'|'orange'|'red'|'blue'
        const isNd = value === nd;
        const dotCls = status;
        const badgeMap = {green:'badge-green',orange:'badge-orange',red:'badge-red',blue:'badge-blue'};
        const badgeText = {green:'OK',orange:'Avviso',red:'Mancante',blue:'Auto'};
        const badge = `<span class="swa-strat-badge ${badgeMap[status]}">${badgeText[status]}</span>`;
        const tipCls = status === 'red' ? 'tip-red' : status === 'orange' ? 'tip-orange' : status === 'green' ? 'tip-green' : '';
        const tipHtml = tip ? `<span class="val-tip ${tipCls}">${tip}</span>` : '';
        return `<div class="swa-strat-row">
            <div class="status-dot ${dotCls}"></div>
            <div class="swa-strat-label"><i class="fas ${icon}"></i>${label}</div>
            <div class="swa-strat-value${isNd?' nd':''}"><span class="val-main">${isNd ? '‚Äî Da compilare ‚Äî' : value}</span>${badge}${tipHtml}</div>
        </div>`;
    }
    
    // ‚îÄ‚îÄ Classify all fields ‚îÄ‚îÄ
    const allRows = [
        // ‚îÄ‚îÄ CAMPI DA COMPILARE (in ordine di priorit√†) ‚îÄ‚îÄ
        {icon:'fa-crosshairs', label:'Obiettivo', value:d.obiettivo, field:'obiettivo', critical:true,
         tipOk:'Obiettivo chiaro: guida tutta la strategia.', tipMiss:'Fondamentale: senza obiettivo il post non ha direzione.'},
        {icon:'fa-users', label:'Target', value:d.targetAnalisi, field:'pubblico', critical:true,
         tipOk:'Target definito: puoi personalizzare tono e messaggio.', tipMiss:'Chi vuoi raggiungere? Definisci et√†, interessi, ruolo.'},
        {icon:'fa-tag', label:'Argomento', value:d.argomento, field:'scopo', critical:true,
         tipOk:'Argomento definito.', tipMiss:'Di cosa parla il post? Compila "Scopo del post".'},
        {icon:'fa-quote-left', label:'Didascalia / Copy', value:d.copyOriginale, field:'didascalia', critical:true,
         tipOk:'Copy presente: analisi CTA e hook attivate.', tipMiss:'Inserisci il testo del post per analizzare CTA e hook.'},
        {icon:'fa-industry', label:'Settore', value:d.settore, field:'settore', critical:true,
         tipOk:'Settore specificato: aiuta a scegliere tono e hashtag.', tipMiss:'Indica il settore per suggerimenti pi√π mirati.'},
        {icon:'fa-gem', label:'Promessa di valore', value:d.promessa, field:null, critical:true,
         tipOk:'Promessa chiara: il pubblico sa cosa otterr√†.', tipWarn:'Dedotta automaticamente ‚Äî verifica che sia corretta.', tipMiss:'Nessuna promessa rilevata. Cosa ci guadagna chi legge?'},
        {icon:'fa-box-open', label:'Prodotto / Servizio', value:d.prodotto, field:'sottotipo', critical:true,
         tipOk:'Prodotto identificato.', tipMiss:'Specifica cosa promuovi nel campo "Sottotipo".'},
        {icon:'fa-building', label:'Contesto business', value:d.contestoBusiness, field:'contesto', critical:true,
         tipOk:'Contesto specificato.', tipMiss:'Aggiungi contesto per suggerimenti pi√π personalizzati.'},
        {icon:'fa-trademark', label:'Brand / Titolo', value:d.brand, field:'titolo1', critical:true,
         tipOk:'Brand identificato.', tipMiss:'Inserisci il titolo/nome brand.'},
        {icon:'fa-bolt', label:'Tipo di hook', value:d.hookType, field:null, critical:true,
         tipOk:'Hook rilevato nella prima riga.', tipMiss:'Inserisci la didascalia per analizzare l\'apertura.'},
        {icon:'fa-link', label:'Allineamento pubblico', value:d.alignment, field:null, critical:true,
         tipOk:'Contenuto e target sono coerenti.', tipWarn:'Verifica che il messaggio parli davvero al tuo target.', tipMiss:'Servono target + didascalia per verificare.'},
        // ‚îÄ‚îÄ CAMPI AUTO-DEDOTTI ‚îÄ‚îÄ
        {icon:'fa-bullhorn', label:'Messaggio commerciale', value:d.messaggio, field:null, critical:false,
         tipOk:'Messaggio coerente con obiettivo.', tipWarn:'Dedotto dall\'obiettivo ‚Äî verifica.'},
        {icon:'fa-palette', label:'Tema contenuto', value:d.tema, field:null, critical:false,
         tipOk:'Tema coerente.'},
        {icon:'fa-filter', label:'Fase funnel', value:d.funnel, field:null, critical:false,
         tipOk:'Fase identificata: guida il livello di pressione.', tipWarn:'Dedotta automaticamente dal testo e obiettivo.'},
        {icon:'fa-comments', label:'Tono comunicativo', value:d.tono, field:null, critical:false,
         tipOk:'Tono rilevato dall\'analisi visiva.', tipWarn:'Basato su luminosit√† e contrasto dell\'immagine.'},
        {icon:'fa-photo-film', label:'Tipo media', value:d.tipoMedia, field:'tipoMedia', critical:false,
         tipOk:'Formato definito.', tipMiss:'Seleziona il tipo di media.'},
        {icon:'fa-hand-pointer', label:'CTA rilevata', value:d.ctaDetected !== nd ? d.ctaDetected + ' (' + d.ctaType + ')' : nd, field:null, critical:false,
         tipOk:'CTA trovata e coerente.', tipMiss:'Nessuna CTA nel testo. Aggiungi un invito all\'azione chiaro.'},
    ];
    
    // ‚îÄ‚îÄ Assign status to each row ‚îÄ‚îÄ
    for (const r of allRows) {
        const v = r.value;
        const isNd = v === nd;
        if (isNd) {
            r.status = 'red';
            r.tip = r.tipMiss || 'Compila questo campo per un\'analisi completa.';
        } else if (!r.field && v !== nd) {
            // Auto-deduced field
            const hasWarning = r.tipWarn;
            if (hasWarning) {
                r.status = 'orange';
                r.tip = r.tipWarn;
            } else {
                r.status = 'green';
                r.tip = r.tipOk || '';
            }
        } else {
            r.status = 'green';
            r.tip = r.tipOk || '';
        }
        // Special: alignment with "Verifica" = orange
        if (r.label === 'Allineamento pubblico' && v.includes('Verifica')) {
            r.status = 'orange';
            r.tip = r.tipWarn;
        }
    }
    
    // ‚îÄ‚îÄ Sort into categories ‚îÄ‚îÄ
    const missing = allRows.filter(r => r.status === 'red');
    const warnings = allRows.filter(r => r.status === 'orange');
    const autoOk = allRows.filter(r => r.status === 'blue');
    const passed = allRows.filter(r => r.status === 'green');
    
    // ‚îÄ‚îÄ Build tech HTML ‚îÄ‚îÄ
    let techHtml = '';
    
    // Missing fields (RED) at top ‚Äî most important
    if (missing.length > 0) {
        const missCritical = missing.filter(r => r.critical);
        const missOther = missing.filter(r => !r.critical);
        techHtml += `<div class="swa-strat-cat cat-missing"><i class="fas fa-circle-xmark"></i> Da compilare ‚Äî ${missing.length} camp${missing.length===1?'o':'i'} mancant${missing.length===1?'e':'i'}</div>`;
        for (const r of [...missCritical, ...missOther]) {
            techHtml += row(r.icon, r.label, r.value, r.status, r.tip);
        }
    }
    
    // Warnings (ORANGE)
    if (warnings.length > 0) {
        techHtml += `<div class="swa-strat-cat cat-warn"><i class="fas fa-triangle-exclamation"></i> Avvisi ‚Äî ${warnings.length} camp${warnings.length===1?'o':'i'} da verificare</div>`;
        for (const r of warnings) {
            techHtml += row(r.icon, r.label, r.value, r.status, r.tip);
        }
    }
    
    // Passed (GREEN)
    if (passed.length > 0) {
        techHtml += `<div class="swa-strat-cat cat-ok"><i class="fas fa-circle-check"></i> Superati ‚Äî ${passed.length} camp${passed.length===1?'o':'i'} OK</div>`;
        for (const r of passed) {
            techHtml += row(r.icon, r.label, r.value, r.status, r.tip);
        }
    }
    
    // Summary bar
    const totalR = allRows.length;
    const pctGreen = Math.round(passed.length / totalR * 100);
    const pctOrange = Math.round(warnings.length / totalR * 100);
    const pctRed = Math.round(missing.length / totalR * 100);
    techHtml += `<div style="margin-top:20px;display:flex;height:6px;border-radius:3px;overflow:hidden;background:rgba(255,255,255,0.06)">
        <div style="width:${pctGreen}%;background:#22c55e;transition:width 0.5s"></div>
        <div style="width:${pctOrange}%;background:#f59e0b;transition:width 0.5s"></div>
        <div style="width:${pctRed}%;background:#ef4444;transition:width 0.5s"></div>
    </div>
    <div style="display:flex;gap:16px;margin-top:8px;font-size:0.72rem;color:rgba(255,255,255,0.5)">
        <span><span style="color:#22c55e;font-weight:800">${passed.length}</span> OK</span>
        <span><span style="color:#f59e0b;font-weight:800">${warnings.length}</span> Avvisi</span>
        <span><span style="color:#ef4444;font-weight:800">${missing.length}</span> Mancanti</span>
    </div>`;
    
    $('stratTech').innerHTML = techHtml;
    
    // ‚îÄ‚îÄ CLIENT SUMMARY ‚îÄ‚îÄ
    let clientHtml = '';
    
    if (missing.length > 3) {
        clientHtml += `<div style="padding:14px 18px;border-radius:14px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);margin-bottom:20px;display:flex;align-items:center;gap:12px">
            <i class="fas fa-pen-to-square" style="color:#f87171;flex-shrink:0;font-size:1rem"></i>
            <div>
                <div style="font-size:0.85rem;font-weight:700;color:#fff">Compila i campi per una strategia completa</div>
                <div style="font-size:0.78rem;color:rgba(255,255,255,0.5);margin-top:2px">Vai nella tab "Prompt Testo / Caption", sezione campi strutturati. Pi√π compili, pi√π il report diventa utile.</div>
            </div>
        </div>`;
    }
    
    clientHtml += `<div class="swa-client-card">
        <div class="swa-client-title">üìã Di cosa parla questo post?</div>
        <div class="swa-client-text">${d.argomento !== nd 
            ? `Questo post parla di <strong>${d.argomento}</strong>${d.settore !== nd ? ` nel settore <strong>${d.settore}</strong>` : ''}. ${d.contestoBusiness !== nd ? d.contestoBusiness+'.' : ''}`
            : 'Non √® stato possibile determinare l\'argomento. Compila il campo "Scopo" nella sezione Prompt per un\'analisi accurata.'
        }</div>
    </div>`;
    
    clientHtml += `<div class="swa-client-card">
        <div class="swa-client-title">üéØ Cosa vuole ottenere?</div>
        <div class="swa-client-text">L'obiettivo principale √® <strong>${d.obiettivo}</strong>. 
        Il post si trova nella fase <strong>${d.funnel.includes('TOFU') ? 'iniziale del percorso (farsi conoscere)' : d.funnel.includes('MOFU') ? 'intermedia (creare interesse e fiducia)' : d.funnel.includes('BOFU') ? 'finale (spingere all\'azione concreta)' : 'non determinata'}</strong>.
        ${d.promessa !== nd ? '<br>La promessa implicita al pubblico √®: <strong>'+d.promessa+'</strong>.' : ''}</div>
    </div>`;
    
    clientHtml += `<div class="swa-client-card">
        <div class="swa-client-title">üë• A chi si rivolge e come?</div>
        <div class="swa-client-text">${d.targetAnalisi !== nd 
            ? `Il target √® <strong>${d.targetAnalisi}</strong>. Il tono comunicativo √® <strong>${d.tono.toLowerCase()}</strong>.`
            : 'Il pubblico target non √® stato specificato. Il tono comunicativo rilevato √® <strong>'+d.tono.toLowerCase()+'</strong>.'
        }${d.alignment !== nd ? '<br><em>'+d.alignment+'</em>' : ''}</div>
    </div>`;
    
    clientHtml += `<div class="swa-client-card">
        <div class="swa-client-title">üí° Le 3 risposte chiave</div>
        <div class="swa-client-text">
            <strong>1.</strong> Questo post √® pensato come <strong>${d.organicOrSponsored.toLowerCase()}</strong>. <span style="color:rgba(255,255,255,0.45)">${d.organicReason}</span><br>
            <strong>2.</strong> L'azione che deve generare: <strong>${d.uniqueObj.toLowerCase()}</strong>. <span style="color:rgba(255,255,255,0.45)">${d.uniqueObjReason}</span><br>
            <strong>3.</strong> Livello di pressione: <strong>${d.directness.toLowerCase()}</strong> ‚Äî ${d.directness === 'Molto soft' ? 'niente vendita diretta, solo valore e relazione.' : d.directness === 'Chiaro ma gentile' ? 'si pu√≤ proporre qualcosa ma senza forzare.' : '√® il momento di essere chiari su cosa fare e perch√©.'}
        </div>
    </div>`;
    
    // CTA & Hook ‚Äî always show, with status
    clientHtml += `<div class="swa-client-card" style="border-color:${d.ctaDetected !== nd ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};background:${d.ctaDetected !== nd ? 'rgba(34,197,94,0.03)' : 'rgba(239,68,68,0.03)'}">
        <div class="swa-client-title">üîç Analisi CTA e Hook</div>
        <div class="swa-client-text">
            ${d.ctaDetected !== nd 
                ? `<span style="color:#4ade80;font-weight:700">‚úì CTA rilevata:</span> "${d.ctaDetected}" (tipo: ${d.ctaType}).` 
                : '<span style="color:#f87171;font-weight:700">‚úó Nessuna CTA rilevata.</span> Ogni post dovrebbe avere un\'unica azione chiara per il lettore.'}
            ${d.hookType !== nd 
                ? `<br><span style="color:${d.hookType.includes('neutro') ? '#fbbf24' : '#4ade80'};font-weight:700">${d.hookType.includes('neutro') ? '‚ö†' : '‚úì'} Hook:</span> ${d.hookType}.`
                : '<br><span style="color:#f87171;font-weight:700">‚úó Hook non analizzabile.</span> Inserisci la didascalia per valutare la riga di apertura.'}
        </div>
    </div>`;
    
    if (d.copyOriginale !== nd) {
        clientHtml += `<div class="swa-client-card" style="border-color:rgba(99,102,241,0.2);background:rgba(99,102,241,0.03)">
            <div class="swa-client-title">üìù Copy originale</div>
            <div class="swa-client-text" style="white-space:pre-wrap;font-style:italic;color:rgba(255,255,255,0.55)">${d.copyOriginale}</div>
        </div>`;
    }
    
    $('stratClient').innerHTML = clientHtml;
    section.style.display = 'block';
    
    // Store for DOCX ‚Äî include categorized data
    d._categories = {passed, warnings, missing, totalR};
    state.strategicData = d;
}

function switchStratTab(tab) {
    document.querySelectorAll('.swa-strat-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.swa-strat-panel').forEach(p => p.classList.remove('active'));
    if (tab === 'tech') {
        document.querySelectorAll('.swa-strat-tab')[0].classList.add('active');
        $('stratTech').classList.add('active');
    } else {
        document.querySelectorAll('.swa-strat-tab')[1].classList.add('active');
        $('stratClient').classList.add('active');
    }
}

// ==================== SCORE VERDICT ====================
function getScoreVerdict(score) {
    if (score >= 80) return {label:'Eccellente', cls:'excellent', emoji:'üèÜ', desc:'Il post ha una base visiva forte, pronto per performare.'};
    if (score >= 65) return {label:'Buono', cls:'good', emoji:'‚úÖ', desc:'Buon livello ‚Äî poche ottimizzazioni per risultati migliori.'};
    if (score >= 50) return {label:'Sufficiente', cls:'fair', emoji:'‚ö†Ô∏è', desc:'Funzionale ma con margini importanti di miglioramento.'};
    return {label:'Da Migliorare', cls:'poor', emoji:'üîß', desc:'Servono interventi significativi prima della pubblicazione.'};
}

// ==================== COLOR PSYCHOLOGY ====================
function getColorPsychology(palette) {
    const psychMap = [
        {hRange:[0,15],name:'Rosso',emotion:'Urgenza, Energia, Passione',use:'CTA, offerte flash, food',emoji:'üî¥'},
        {hRange:[15,40],name:'Arancione',emotion:'Ottimismo, Entusiasmo, Calore',use:'E-commerce, creativit√†, community',emoji:'üü†'},
        {hRange:[40,65],name:'Giallo',emotion:'Attenzione, Positivit√†, Chiarezza',use:'Avvisi, highlight, giovani brand',emoji:'üü°'},
        {hRange:[65,160],name:'Verde',emotion:'Fiducia, Crescita, Salute',use:'Benessere, natura, finanza',emoji:'üü¢'},
        {hRange:[160,200],name:'Ciano',emotion:'Freschezza, Tecnologia, Apertura',use:'Tech, digitale, innovazione',emoji:'ü©µ'},
        {hRange:[200,260],name:'Blu',emotion:'Affidabilit√†, Professionalit√†, Calma',use:'Corporate, healthcare, finance',emoji:'üîµ'},
        {hRange:[260,300],name:'Viola',emotion:'Premium, Creativit√†, Mistero',use:'Lusso, formazione, beauty',emoji:'üü£'},
        {hRange:[300,340],name:'Rosa/Magenta',emotion:'Femminilit√†, Dolcezza, Modernit√†',use:'Beauty, moda, lifestyle',emoji:'ü©∑'},
        {hRange:[340,361],name:'Rosso',emotion:'Urgenza, Energia, Passione',use:'CTA, offerte flash, food',emoji:'üî¥'}
    ];
    
    const results = [];
    for (const c of palette.slice(0, 5)) {
        const [h,s,l] = rgbToHsl(c.r, c.g, c.b);
        const hex = rgbToHex(c.r, c.g, c.b);
        
        // Check neutrals
        if (s < 10) {
            if (l < 20) results.push({hex, name:'Nero', emotion:'Eleganza, Autorit√†, Premium', use:'Lusso, moda, tech', emoji:'‚ö´'});
            else if (l > 85) results.push({hex, name:'Bianco', emotion:'Pulizia, Spazio, Semplicit√†', use:'Minimalismo, healthcare, tech', emoji:'‚ö™'});
            else results.push({hex, name:'Grigio', emotion:'Neutralit√†, Equilibrio, Professionalit√†', use:'Corporate, background, testo', emoji:'ü©∂'});
            continue;
        }
        
        for (const p of psychMap) {
            if (h >= p.hRange[0] && h < p.hRange[1]) {
                results.push({hex, ...p});
                break;
            }
        }
    }
    return results;
}

function renderColorPsychology(a) {
    const psych = getColorPsychology(a.palette);
    if (!psych.length) return;
    
    let html = '<h4 style="font-size:0.9rem;font-weight:700;margin-bottom:4px">üß† Psicologia dei Colori</h4>';
    html += '<p style="font-size:0.72rem;color:rgba(255,255,255,0.35);margin-bottom:10px">Cosa comunicano i colori dominanti</p>';
    html += '<div class="swa-psych-grid">';
    
    const seen = new Set();
    for (const p of psych) {
        if (seen.has(p.name)) continue;
        seen.add(p.name);
        html += `<div class="swa-psych-item">
            <div class="swa-psych-swatch" style="background:${p.hex}"></div>
            <div class="swa-psych-emotion">${p.emoji} ${p.name}</div>
            <div class="swa-psych-desc">${p.emotion}</div>
            <div class="swa-psych-desc" style="margin-top:4px;color:rgba(255,255,255,0.3)">‚Üí ${p.use}</div>
        </div>`;
    }
    html += '</div>';
    $('colorPsychBox').innerHTML = html;
    
    // Store for report
    state.colorPsychology = psych;
}

// ==================== POSTING TIME ====================
function getPostingTime(platform, goal) {
    const times = {
        instagram: {
            sales:     {best:['12:00-13:00','18:00-20:00'], days:['Marted√¨','Gioved√¨','Sabato']},
            awareness: {best:['11:00-13:00','19:00-21:00'], days:['Luned√¨','Mercoled√¨','Venerd√¨']},
            engagement:{best:['08:00-09:00','17:00-19:00'], days:['Marted√¨','Gioved√¨','Domenica']},
            leads:     {best:['12:00-14:00','18:00-19:00'], days:['Marted√¨','Mercoled√¨']},
            traffic:   {best:['09:00-11:00','15:00-16:00'], days:['Luned√¨','Gioved√¨']}
        },
        tiktok: {
            sales:     {best:['19:00-21:00','12:00-13:00'], days:['Venerd√¨','Sabato']},
            awareness: {best:['18:00-22:00','07:00-09:00'], days:['Marted√¨','Gioved√¨','Sabato']},
            engagement:{best:['19:00-21:00','12:00-14:00'], days:['Marted√¨','Gioved√¨','Sabato']},
            leads:     {best:['18:00-20:00','10:00-12:00'], days:['Mercoled√¨','Venerd√¨']},
            traffic:   {best:['17:00-19:00','12:00-13:00'], days:['Luned√¨','Mercoled√¨']}
        },
        linkedin: {
            sales:     {best:['10:00-12:00','14:00-16:00'], days:['Marted√¨','Mercoled√¨','Gioved√¨']},
            awareness: {best:['08:00-10:00','17:00-18:00'], days:['Marted√¨','Mercoled√¨','Gioved√¨']},
            engagement:{best:['09:00-11:00','12:00-13:00'], days:['Marted√¨','Gioved√¨']},
            leads:     {best:['10:00-11:00','14:00-15:00'], days:['Marted√¨','Mercoled√¨']},
            traffic:   {best:['08:00-10:00','16:00-17:00'], days:['Luned√¨','Marted√¨','Gioved√¨']}
        },
        facebook: {
            sales:     {best:['13:00-16:00','19:00-21:00'], days:['Gioved√¨','Venerd√¨','Sabato']},
            awareness: {best:['09:00-11:00','18:00-20:00'], days:['Mercoled√¨','Gioved√¨','Venerd√¨']},
            engagement:{best:['09:00-10:00','18:00-19:00'], days:['Mercoled√¨','Venerd√¨','Domenica']},
            leads:     {best:['12:00-14:00','17:00-18:00'], days:['Marted√¨','Mercoled√¨']},
            traffic:   {best:['13:00-15:00','19:00-20:00'], days:['Gioved√¨','Venerd√¨']}
        },
        web: {
            sales:     {best:['10:00-12:00','14:00-16:00'], days:['Marted√¨','Mercoled√¨','Gioved√¨']},
            awareness: {best:['09:00-11:00','14:00-16:00'], days:['Luned√¨','Marted√¨','Mercoled√¨']},
            engagement:{best:['10:00-12:00','15:00-17:00'], days:['Marted√¨','Gioved√¨']},
            leads:     {best:['09:00-11:00','14:00-15:00'], days:['Marted√¨','Mercoled√¨']},
            traffic:   {best:['08:00-10:00','13:00-15:00'], days:['Luned√¨','Marted√¨','Mercoled√¨']}
        }
    };
    return times[platform]?.[goal] || times.instagram.awareness;
}

// ==================== HASHTAG STRATEGY ====================
function getHashtagStrategy(platform, goal, settore) {
    const sector = (settore || '').toLowerCase();
    const base = [];
    
    // Platform-specific
    if (platform === 'instagram') {
        base.push({cat:'Formato', tags:['#reels','#carousel','#instagramtips','#contentcreator']});
        base.push({cat:'Engagement', tags:['#community','#saveforlater','#commentbelow','#followformore']});
    } else if (platform === 'tiktok') {
        base.push({cat:'Discovery', tags:['#fyp','#foryou','#viral','#trending']});
        base.push({cat:'Formato', tags:['#tiktoktips','#tutorial','#storytime']});
    } else if (platform === 'linkedin') {
        base.push({cat:'Visibilit√†', tags:['#leadership','#growth','#innovation','#networking']});
        base.push({cat:'Contenuto', tags:['#tips','#lessons','#insights','#casestudy']});
    } else if (platform === 'facebook') {
        base.push({cat:'Formato', tags:['#facebookreels','#facebooklive','#grouppost']});
        base.push({cat:'Engagement', tags:['#community','#share','#discussion']});
    }
    
    // Goal-specific
    const goalTags = {
        sales: {cat:'Vendita', tags:['#offerta','#promo','#sconto','#shopnow','#limitedoffer']},
        awareness: {cat:'Brand', tags:['#branding','#brandstory','#aboutus','#newbrand']},
        engagement: {cat:'Interazione', tags:['#challenge','#poll','#askme','#contest','#giveaway']},
        leads: {cat:'Lead', tags:['#freeresource','#download','#ebook','#webinar','#signup']},
        traffic: {cat:'Traffico', tags:['#linkinbio','#readmore','#blogarticle','#website']}
    };
    if (goalTags[goal]) base.push(goalTags[goal]);
    
    // Sector-specific
    if (sector.match(/cucin|food|ristora|alimenta|chef/)) base.push({cat:'Settore', tags:['#foodie','#ricette','#cucinaitaliana','#healthyfood','#cooking']});
    else if (sector.match(/benessere|wellness|yoga|fitness/)) base.push({cat:'Settore', tags:['#wellness','#selfcare','#mindfulness','#healthylifestyle']});
    else if (sector.match(/formazione|coach|corso|educaz/)) base.push({cat:'Settore', tags:['#formazione','#crescitapersonale','#learning','#skillup']});
    else if (sector.match(/tech|software|digital|web|app/)) base.push({cat:'Settore', tags:['#tech','#digitalmarketing','#innovation','#startup']});
    else if (sector.match(/moda|fashion|beauty|stile/)) base.push({cat:'Settore', tags:['#fashion','#style','#outfit','#beauty','#ootd']});
    else if (sector.match(/immobil|casa|arredo|interior/)) base.push({cat:'Settore', tags:['#realestate','#interiordesign','#homedecor','#property']});
    
    return base;
}

// ==================== ACTION PLAN RENDERER ====================
function renderActionPlan(a) {
    const section = $('actionPlanSection');
    const content = $('actionPlanContent');
    const sd = state.strategicData || generateStrategicData(a);
    const postTime = getPostingTime(state.platform, state.goal);
    const settore = getFieldVal('fieldSettore');
    const hashtags = getHashtagStrategy(state.platform, state.goal, settore);
    const recs = a.recommendations || [];
    const highPrio = recs.filter(r => r.priority === 'high');
    const verdict = getScoreVerdict(a.overallScore);
    
    let html = '';
    
    // CARD 1: Pre-pubblicazione checklist
    html += `<div class="swa-action-card">
        <h4>üìù Prima di Pubblicare</h4>
        <ul class="swa-checklist">
            <li class="${a.bestRatioMatch >= 85 ? 'done' : 'todo'}"><span class="ck">${a.bestRatioMatch >= 85 ? '‚úì' : ''}</span>Formato immagine corretto per ${state.platform} (${a.bestRatioMatch}% match)</li>
            <li class="${a.wcagRatio >= 4.5 ? 'done' : 'todo'}"><span class="ck">${a.wcagRatio >= 4.5 ? '‚úì' : ''}</span>Contrasto testo leggibile (WCAG ${a.wcagRatio}:1)</li>
            <li class="${a.safeZoneCompliance >= 85 ? 'done' : 'todo'}"><span class="ck">${a.safeZoneCompliance >= 85 ? '‚úì' : ''}</span>Contenuti dentro le safe zones (${a.safeZoneCompliance}%)</li>
            <li class="${a.entropy <= 5.5 ? 'done' : 'todo'}"><span class="ck">${a.entropy <= 5.5 ? '‚úì' : ''}</span>Complessit√† gestibile (entropia ${a.entropy}/8)</li>
            <li class="${a.negativeSpace >= 20 ? 'done' : 'todo'}"><span class="ck">${a.negativeSpace >= 20 ? '‚úì' : ''}</span>Spazio negativo sufficiente (${a.negativeSpace}%)</li>
            <li class="${highPrio.length === 0 ? 'done' : 'todo'}"><span class="ck">${highPrio.length === 0 ? '‚úì' : ''}</span>${highPrio.length > 0 ? highPrio.length + ' problemi alta priorit√† da risolvere' : 'Nessun problema critico rilevato'}</li>
        </ul>
    </div>`;
    
    // CARD 2: Quando pubblicare
    html += `<div class="swa-action-card">
        <h4>üìÖ Quando Pubblicare</h4>
        <p style="font-size:0.78rem;color:rgba(255,255,255,0.5);margin-bottom:10px">Orari ottimali per ${state.platform} con obiettivo ${state.goal}:</p>
        <div style="margin-bottom:10px">
            <span style="font-size:0.72rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase">Fasce orarie</span><br>
            ${postTime.best.map(t => `<span class="swa-time-badge"><i class="fas fa-clock"></i> ${t}</span>`).join('')}
        </div>
        <div>
            <span style="font-size:0.72rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase">Giorni migliori</span><br>
            ${postTime.days.map(d => `<span class="swa-time-badge" style="background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.2);color:#34d399"><i class="fas fa-calendar-check"></i> ${d}</span>`).join('')}
        </div>
    </div>`;
    
    // CARD 3: Strategia hashtag
    if (hashtags.length > 0) {
        html += `<div class="swa-action-card">
            <h4>#Ô∏è‚É£ Strategia Hashtag</h4>
            <p style="font-size:0.78rem;color:rgba(255,255,255,0.5);margin-bottom:10px">${state.platform === 'instagram' ? 'Usa 5-10 hashtag: mix alta popolarit√† + nicchia' : state.platform === 'linkedin' ? 'Max 3-5 hashtag professionali' : state.platform === 'tiktok' ? 'Max 3-4 hashtag + trending' : 'Max 3-5 hashtag rilevanti'}</p>`;
        for (const group of hashtags) {
            html += `<div style="margin-bottom:8px"><span style="font-size:0.7rem;font-weight:700;color:rgba(255,255,255,0.35);text-transform:uppercase">${group.cat}</span>
                <div class="swa-hashtag-cloud">${group.tags.map(t => `<span class="swa-hashtag" onclick="navigator.clipboard.writeText('${t}')">${t}</span>`).join('')}</div>
            </div>`;
        }
        html += `</div>`;
    }
    
    // CARD 4: Post-pubblicazione
    html += `<div class="swa-action-card">
        <h4>üìä Dopo la Pubblicazione</h4>
        <ul class="swa-checklist">
            <li class="todo"><span class="ck"></span>Rispondi ai commenti entro 30 min (boost algoritmico)</li>
            <li class="todo"><span class="ck"></span>Condividi nelle stories/altri canali entro 1h</li>
            <li class="todo"><span class="ck"></span>${sd.organicOrSponsored.includes('Sponsorizzato') ? 'Attiva sponsorizzazione dopo 1-2h di organico' : 'Monitora reach organico per 24h'}</li>
            <li class="todo"><span class="ck"></span>Controlla metriche dopo 24h (CTR, saves, shares)</li>
            <li class="todo"><span class="ck"></span>Se engagement basso ‚Üí testa variante A/B dell'immagine</li>
            <li class="todo"><span class="ck"></span>Documenta i risultati per il prossimo contenuto</li>
        </ul>
    </div>`;
    
    content.innerHTML = html;
    section.style.display = 'block';
    
    // Store for report
    state.postingTime = postTime;
    state.hashtagStrategy = hashtags;
}

function animateNumber(el, target, suffix) {
    let current = 0;
    const step = Math.max(1, Math.floor(target/30));
    const timer = setInterval(() => {
        current += step;
        if (current >= target) { current = target; clearInterval(timer); }
        el.textContent = current + (suffix||'');
    }, 30);
}

function drawHistogram(hist, canvas) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    let maxVal = 0;
    for (let i = 0; i < 256; i++) if (hist[i]>maxVal) maxVal = hist[i];
    if (maxVal === 0) return;
    
    const barW = w/256;
    for (let i = 0; i < 256; i++) {
        const barH = (hist[i]/maxVal)*h*0.9;
        const t = i/255;
        ctx.fillStyle = `rgba(${Math.round(139+t*117)}, ${Math.round(92-t*20)}, ${Math.round(246-t*100)}, 0.7)`;
        ctx.fillRect(i*barW, h-barH, barW+0.5, barH);
    }
}

// ==================== DOCX GENERATION ====================
async function downloadDocx() {
    const btn = $('downloadBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generazione DOCX...';
    
    const a = state.analysis;
    const recs = a.recommendations || [];
    const pNames = {instagram:'Instagram',tiktok:'TikTok/Reels',linkedin:'LinkedIn',facebook:'Facebook',web:'Web/Landing'};
    const gNames = {sales:'Vendite dirette / Conversioni',awareness:'Brand awareness / Visibilit√†',engagement:'Engagement / Interazioni',leads:'Generazione lead / Contatti',traffic:'Traffico sito web'};
    const platformName = pNames[state.platform];
    const goalName = gNames[state.goal];
    const date = new Date().toLocaleDateString('it-IT',{year:'numeric',month:'long',day:'numeric'});
    
    try {
        // Generate heatmap as base64
        const heatCanvas = document.createElement('canvas');
        const tempImg = new Image();
        await new Promise(resolve => { tempImg.onload = resolve; tempImg.src = state.imageSrc; });
        generateHeatmap(tempImg, a, heatCanvas);
        const heatmapBase64 = heatCanvas.toDataURL('image/png').split(',')[1];
        
        // Original image as base64
        const origBase64 = state.imageSrc.split(',')[1];
        const origMime = state.imageSrc.split(';')[0].split(':')[1];
        
        // Build DOCX using JSZip (Office Open XML)
        const zip = new JSZip();
        
        // [Content_Types].xml
        zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Default Extension="png" ContentType="image/png"/>
  <Default Extension="jpeg" ContentType="image/jpeg"/>
  <Default Extension="jpg" ContentType="image/jpeg"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
  <Override PartName="/word/numbering.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml"/>
</Types>`);
        
        // _rels/.rels
        zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
        
        // word/_rels/document.xml.rels
        zip.folder('word').folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering" Target="numbering.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/original.png"/>
  <Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/heatmap.png"/>
</Relationships>`);
        
        // Images
        zip.folder('word').folder('media').file('original.png', origBase64, {base64:true});
        zip.folder('word').folder('media').file('heatmap.png', heatmapBase64, {base64:true});
        
        // Numbering
        zip.folder('word').file('numbering.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:numbering xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:abstractNum w:abstractNumId="0">
    <w:lvl w:ilvl="0"><w:start w:val="1"/><w:numFmt w:val="decimal"/><w:lvlText w:val="%1."/><w:lvlJc w:val="left"/></w:lvl>
  </w:abstractNum>
  <w:num w:numId="1"><w:abstractNumId w:val="0"/></w:num>
</w:numbering>`);
        
        // Styles
        zip.folder('word').file('styles.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:style w:type="paragraph" w:default="1" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:sz w:val="22"/><w:color w:val="333333"/></w:rPr>
    <w:pPr><w:spacing w:after="120" w:line="276" w:lineRule="auto"/></w:pPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading1">
    <w:name w:val="heading 1"/>
    <w:pPr><w:spacing w:before="360" w:after="120"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:b/><w:sz w:val="36"/><w:color w:val="5B21B6"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading2">
    <w:name w:val="heading 2"/>
    <w:pPr><w:spacing w:before="240" w:after="80"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:b/><w:sz w:val="28"/><w:color w:val="7C3AED"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading3">
    <w:name w:val="heading 3"/>
    <w:pPr><w:spacing w:before="200" w:after="60"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:b/><w:sz w:val="24"/><w:color w:val="4338CA"/></w:rPr>
  </w:style>
</w:styles>`);
        
        // Helper functions for XML
        const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        
        function p(text, style, opts={}) {
            let pPr = style ? `<w:pPr><w:pStyle w:val="${style}"/></w:pPr>` : '';
            if (opts.bold || opts.color || opts.size) {
                let rPr = '<w:rPr>';
                if (opts.bold) rPr += '<w:b/>';
                if (opts.color) rPr += `<w:color w:val="${opts.color}"/>`;
                if (opts.size) rPr += `<w:sz w:val="${opts.size}"/>`;
                rPr += '</w:rPr>';
                return `<w:p>${pPr}<w:r>${rPr}<w:t xml:space="preserve">${esc(text)}</w:t></w:r></w:p>`;
            }
            return `<w:p>${pPr}<w:r><w:t xml:space="preserve">${esc(text)}</w:t></w:r></w:p>`;
        }
        
        function boldP(text) {
            return `<w:p><w:r><w:rPr><w:b/></w:rPr><w:t xml:space="preserve">${esc(text)}</w:t></w:r></w:p>`;
        }
        
        function mixedP(parts) {
            let runs = '';
            for (const part of parts) {
                let rPr = '';
                if (part.bold || part.color) {
                    rPr = '<w:rPr>';
                    if (part.bold) rPr += '<w:b/>';
                    if (part.color) rPr += `<w:color w:val="${part.color}"/>`;
                    rPr += '</w:rPr>';
                }
                runs += `<w:r>${rPr}<w:t xml:space="preserve">${esc(part.text)}</w:t></w:r>`;
            }
            return `<w:p>${runs}</w:p>`;
        }
        
        function tableRow(cells, isHeader=false) {
            let xml = '<w:tr>';
            if (isHeader) xml += '<w:trPr><w:tblHeader/></w:trPr>';
            for (const cell of cells) {
                const shading = isHeader ? '<w:shd w:val="clear" w:color="auto" w:fill="F0E6FF"/>' : '';
                xml += `<w:tc><w:tcPr>${shading}<w:tcW w:w="0" w:type="auto"/></w:tcPr>`;
                xml += `<w:p><w:r><w:rPr>${isHeader?'<w:b/>':''}</w:rPr><w:t xml:space="preserve">${esc(cell)}</w:t></w:r></w:p></w:tc>`;
            }
            xml += '</w:tr>';
            return xml;
        }
        
        function imageXml(rId, wEmu, hEmu) {
            return `<w:p><w:r><w:drawing>
<wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing">
  <wp:extent cx="${wEmu}" cy="${hEmu}"/>
  <wp:docPr id="${rId==='rId3'?1:2}" name="Img"/>
  <a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">
    <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
      <pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
        <pic:nvPicPr><pic:cNvPr id="0" name="img"/><pic:cNvPicPr/></pic:nvPicPr>
        <pic:blipFill>
          <a:blip r:embed="${rId}" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>
          <a:stretch><a:fillRect/></a:stretch>
        </pic:blipFill>
        <pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${wEmu}" cy="${hEmu}"/></a:xfrm><a:prstGeom prst="rect"/></pic:spPr>
      </pic:pic>
    </a:graphicData>
  </a:graphic>
</wp:inline>
</w:drawing></w:r></w:p>`;
        }
        
        // Calculate image dimensions for DOCX (EMU = English Metric Units, 914400 EMU = 1 inch)
        const maxWidthEmu = 5500000; // ~6 inches
        const imgAspect = a.imgWidth / a.imgHeight;
        const imgWEmu = Math.min(maxWidthEmu, Math.round(a.imgWidth / 96 * 914400));
        const imgHEmu = Math.round(imgWEmu / imgAspect);
        
        // Palette string
        const paletteStr = a.palette.map(c => `${rgbToHex(c.r,c.g,c.b)} (${c.pct}%)`).join(', ');
        
        // Build document.xml content
        let body = '';
        
        // Title
        body += `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:b/><w:sz w:val="48"/><w:color w:val="5B21B6"/></w:rPr><w:t>Report Analisi Post Social</w:t></w:r></w:p>`;
        body += `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:sz w:val="24"/><w:color w:val="666666"/></w:rPr><w:t>Generato da SocialStrategist AI ‚Äî ${esc(date)}</w:t></w:r></w:p>`;
        body += `<w:p><w:pPr><w:pBdr><w:bottom w:val="single" w:sz="6" w:color="E5E7EB"/></w:pBdr></w:pPr></w:p>`;
        
        // Meta info
        body += p('Informazioni Analisi', 'Heading2');
        body += mixedP([{text:'Piattaforma: ',bold:true},{text:platformName}]);
        body += mixedP([{text:'Obiettivo: ',bold:true},{text:goalName}]);
        body += mixedP([{text:'Target: ',bold:true},{text:state.target||'Non specificato'}]);
        body += mixedP([{text:'Dimensioni immagine: ',bold:true},{text:`${a.imgWidth}√ó${a.imgHeight}px (${a.aspectRatio}:1)`}]);
        body += mixedP([{text:'Palette dominante: ',bold:true},{text:paletteStr}]);
        
        // Executive summary
        body += p('1. Sintesi Esecutiva', 'Heading1');
        body += p(`L'analisi pixel-level del contenuto ha rilevato un punteggio complessivo di ${a.overallScore}/100. L'immagine presenta ${a.overallScore>=70?'buone basi con margini di ottimizzazione':a.overallScore>=50?'diversi aspetti migliorabili':'criticit√† significative che richiedono intervento'}. Sono state identificate ${recs.length} raccomandazioni strategiche prioritarie.`);
        body += p(`I punti di forza principali sono: ${[a.flowScore>=70?'buon flusso visivo':null, a.contrastScore>=70?'contrasto adeguato':null, a.frictionScore>=70?'buona semplicit√†':null, a.accessScore>=70?'buona leggibilit√†':null].filter(Boolean).join(', ')||'nessun punteggio sopra soglia ‚Äî tutte le metriche richiedono attenzione'}.`);
        
        // Images
        body += p('2. Immagine Originale e Heatmap', 'Heading1');
        body += p('Immagine analizzata:', null, {bold:true});
        body += imageXml('rId3', imgWEmu, imgHEmu);
        body += p('');
        body += p('Heatmap attenzione (rosso = alta, blu = bassa):', null, {bold:true});
        body += imageXml('rId4', imgWEmu, imgHEmu);
        body += p('La heatmap √® generata combinando edge-saliency (50%), center-bias gaussiano (35%) e saturazione colore (15%).', null, {color:'666666'});
        
        // Detailed metrics
        body += p('3. Metriche Dettagliate', 'Heading1');
        
        body += p('Flusso Visivo ‚Äî ' + a.flowScore + '%', 'Heading2');
        body += mixedP([{text:'Metodo: ',bold:true},{text:'Algoritmo center-bias + analisi distribuzione bordi per quadrante'}]);
        body += mixedP([{text:'Center-bias: ',bold:true},{text:`${a.centerBias}% ‚Äî ${a.centerBias>=60?'l\'attenzione converge bene verso il centro':'attenzione dispersa verso i bordi'}`}]);
        body += p(`I quattro quadranti hanno luminosit√† media di: TL=${Math.round(a.quadrants[0].avgLum)}, TR=${Math.round(a.quadrants[1].avgLum)}, BL=${Math.round(a.quadrants[2].avgLum)}, BR=${Math.round(a.quadrants[3].avgLum)}. ${Math.max(...a.quadrants.map(q=>q.avgLum))-Math.min(...a.quadrants.map(q=>q.avgLum))>60?'La differenza marcata tra quadranti crea un percorso visivo naturale.':'La distribuzione uniforme potrebbe non guidare lo sguardo verso un punto focale.'}`);
        
        body += p('Contrasto ‚Äî ' + a.contrastScore + '%', 'Heading2');
        body += mixedP([{text:'Metodo: ',bold:true},{text:'Calcolo Root Mean Square della deviazione standard di luminanza'}]);
        body += mixedP([{text:'RMS Contrast: ',bold:true},{text:`${a.rmsContrast}% ‚Äî ${a.rmsContrast>=20?'contrasto forte e impattante':a.rmsContrast>=12?'contrasto nella media':'contrasto debole, rischio di piattezza visiva'}`}]);
        body += mixedP([{text:'WCAG Ratio stimato: ',bold:true},{text:`${a.wcagRatio}:1 ‚Äî ${a.wcagRatio>=7?'Supera WCAG AAA (7:1) ‚úì':a.wcagRatio>=4.5?'Supera WCAG AA (4.5:1) ‚úì':'Sotto WCAG AA (4.5:1) ‚Äî accessibilit√† insufficiente ‚úó'}`}]);
        
        body += p('Leggibilit√† ‚Äî ' + a.accessScore + '%', 'Heading2');
        body += mixedP([{text:'Match formato: ',bold:true},{text:`${a.bestRatioMatch}% con ${a.bestRatioLabel} (formato ottimale per ${platformName})`}]);
        body += mixedP([{text:'Safe zones: ',bold:true},{text:`${a.safeZoneCompliance}% degli elementi chiave dentro le zone sicure`}]);
        
        body += p('Struttura ‚Äî ' + a.structureScore + '%', 'Heading2');
        body += mixedP([{text:'Spazio negativo: ',bold:true},{text:`${a.negativeSpace}% ‚Äî ${a.negativeSpace>=25?'buon respiro visivo':a.negativeSpace>=15?'accettabile ma migliorabile':'troppo affollato'}`}]);
        body += mixedP([{text:'Armonia colori: ',bold:true},{text:a.harmonyType}]);
        body += mixedP([{text:'Densit√† bordi: ',bold:true},{text:`${a.edgeDensity}% ‚Äî ${a.edgeDensity<=8?'composizione pulita':'complessit√† elevata'}`}]);
        
        body += p('Semplicit√† ‚Äî ' + a.frictionScore + '%', 'Heading2');
        body += mixedP([{text:'Entropia Shannon: ',bold:true},{text:`${a.entropy}/8 ‚Äî ${a.entropy<=5?'contenuto ben focalizzato':a.entropy<=6.5?'complessit√† media':'sovraccarico informativo'}`}]);
        body += p('L\'entropia misura la "quantit√† di informazione" presente. Valori bassi (2-4) indicano immagini semplici e focalizzate. Valori alti (6+) indicano complessit√† che rallenta la comprensione.');
        
        // Metrics comparison table
        body += p('4. Tabella Riepilogativa', 'Heading1');
        let table = '<w:tbl><w:tblPr><w:tblStyle w:val="TableGrid"/><w:tblW w:w="5000" w:type="pct"/><w:tblBorders><w:top w:val="single" w:sz="4" w:color="D1D5DB"/><w:left w:val="single" w:sz="4" w:color="D1D5DB"/><w:bottom w:val="single" w:sz="4" w:color="D1D5DB"/><w:right w:val="single" w:sz="4" w:color="D1D5DB"/><w:insideH w:val="single" w:sz="4" w:color="D1D5DB"/><w:insideV w:val="single" w:sz="4" w:color="D1D5DB"/></w:tblBorders></w:tblPr>';
        table += tableRow(['Metrica','Valore','Benchmark','Status'], true);
        table += tableRow(['Flusso Visivo',`${a.flowScore}%`,'‚â• 70%',a.flowScore>=70?'‚úì Buono':'‚ö† Migliorabile']);
        table += tableRow(['Contrasto RMS',`${a.rmsContrast}%`,'15-30%',a.rmsContrast>=15&&a.rmsContrast<=35?'‚úì Buono':'‚ö† Fuori range']);
        table += tableRow(['WCAG Ratio',`${a.wcagRatio}:1`,'‚â• 4.5:1',a.wcagRatio>=4.5?'‚úì AA Ok':'‚úó Sotto soglia']);
        table += tableRow(['Entropia',`${a.entropy}/8`,'‚â§ 5.5',a.entropy<=5.5?'‚úì Ok':'‚ö† Troppo alta']);
        table += tableRow(['Spazio Negativo',`${a.negativeSpace}%`,'25-40%',a.negativeSpace>=20&&a.negativeSpace<=45?'‚úì Ok':'‚ö† Fuori range']);
        table += tableRow(['Densit√† Bordi',`${a.edgeDensity}%`,'‚â§ 8%',a.edgeDensity<=8?'‚úì Ok':'‚ö† Elevata']);
        table += tableRow(['Match Formato',`${a.bestRatioMatch}%`,'‚â• 85%',a.bestRatioMatch>=85?'‚úì Ok':'‚ö† Mismatch']);
        table += tableRow(['Safe Zones',`${a.safeZoneCompliance}%`,'‚â• 85%',a.safeZoneCompliance>=85?'‚úì Ok':'‚ö† Fuori zona']);
        table += tableRow(['PUNTEGGIO TOTALE',`${a.overallScore}/100`,'‚â• 70',a.overallScore>=70?'‚úì Buono':'‚ö† Da migliorare']);
        table += '</w:tbl>';
        body += table;
        
        // Recommendations
        body += p('5. Raccomandazioni Strategiche', 'Heading1');
        for (let i = 0; i < recs.length; i++) {
            const r = recs[i];
            const prioLabel = r.priority==='high'?'ALTA':r.priority==='medium'?'MEDIA':'BASSA';
            const prioColor = r.priority==='high'?'DC2626':r.priority==='medium'?'D97706':'059669';
            body += p(`${i+1}. ${r.title} [Priorit√† ${prioLabel}]`, 'Heading3');
            body += p(r.body);
            body += mixedP([{text:'Impatto stimato: ',bold:true},{text:r.impact, color:prioColor}]);
        }
        
        // Platform-specific
        body += p(`6. Ottimizzazioni per ${platformName}`, 'Heading1');
        const platTips = {
            instagram: [
                'Formato ottimale: 4:5 (1080√ó1350px) per feed, 9:16 per stories/reels',
                'Safe zones: mantieni CTA entro 10% dai bordi ‚Äî UI Instagram copre bordo inferiore',
                'Carosello 3-5 slide performa +21% engagement vs immagine singola',
                'Primi 3 secondi critici per reels: hook visivo immediato',
                'Hashtag: 5-10 pertinenti, mix di popolarit√† alta e nicchia'
            ],
            tiktok: [
                'Formato: 9:16 (1080√ó1920px) verticale obbligatorio',
                'Safe zones: evita top 15% (logo) e bottom 25% (pulsanti)',
                'Testo grande 60-80pt per leggibilit√† mobile',
                'Movimento/animazione +45% completion rate',
                'Primi 1-2 secondi: hook visivo o testuale per bloccare lo scroll'
            ],
            linkedin: [
                'Formato: 1.91:1 (1200√ó628px) per link preview, 1:1 per immagini',
                'Contenuti con dati/statistiche +63% engagement',
                'Evita clickbait: su LinkedIn performa il value proposition chiaro',
                'Documenti PDF/carousel nativi ottengono 3x reach',
                'Tono professionale ma umano ‚Äî storytelling con dati'
            ],
            facebook: [
                'Formato: 1.91:1 (1200√ó628px) o 1:1 (1080√ó1080px)',
                'Video nativi 10x reach vs link esterni',
                'Sottotitoli sempre: 85% visualizzazioni senza audio',
                'Immagini con poco testo: regola del 20% testo per ads',
                'Engagement baiting penalizzato: focus su contenuti genuini'
            ],
            web: [
                'Ottimizza Core Web Vitals: LCP <2.5s, CLS <0.1',
                'Mobile-first: 60%+ del traffico √® mobile',
                'Above-the-fold: CTA e messaggio chiave nei primi 600px',
                'Immagini compresse: WebP/AVIF per performance',
                'Alt text descrittivo per SEO e accessibilit√†'
            ]
        };
        for (const tip of platTips[state.platform]) {
            body += p(`‚Ä¢ ${tip}`);
        }
        
        // Methodology
        body += p('7. Metodologia', 'Heading1');
        body += p('Tutte le metriche sono calcolate in tempo reale nel browser dell\'utente tramite Canvas API, senza invio di dati a server esterni:');
        body += p('‚Ä¢ Center-bias: modello gaussiano pesato sulla distanza dal centro ottico, combinato con edge-saliency (gradient magnitude)');
        body += p('‚Ä¢ RMS Contrast: deviazione standard della luminanza percepita (Rec. 709: 0.2126R + 0.7152G + 0.0722B)');
        body += p('‚Ä¢ Entropia Shannon: calcolata sulla distribuzione dell\'istogramma di luminanza a 256 livelli');
        body += p('‚Ä¢ Spazio negativo: rilevamento blocchi 8√ó8 a bassa varianza (œÉ¬≤ < 200)');
        body += p('‚Ä¢ Safe zones: basate sulle linee guida ufficiali delle piattaforme per content creators');
        body += p('‚Ä¢ Palette colori: clustering per quantizzazione (bucket 32-step) con merge di colori simili (ŒîE < 80)');
        body += p('‚Ä¢ Heatmap: combinazione pesata di edge-saliency (50%), center-bias gaussiano (35%) e saturazione (15%), con gaussian blur œÉ=12');
        
        // Strategic Analysis
        const sd = state.strategicData || generateStrategicData(a);
        body += p('8. Analisi Strategica del Post', 'Heading1');
        
        // Strategy completeness
        const ssDoc = calculateStrategyScore();
        body += mixedP([{text:'Completezza dati: ',bold:true},{text:`${ssDoc.score}% (${ssDoc.filled}/${ssDoc.total} campi compilati)`, color: ssDoc.score >= 70 ? '059669' : ssDoc.score >= 40 ? 'D97706' : 'DC2626'}]);
        body += p('');
        
        body += p('8.1 Report Tecnico ‚Äî Analisi per Categorie', 'Heading2');
        
        // Build categorized fields for DOCX (same logic as UI)
        const ndDoc = 'Non determinabile';
        const docRows = [
            // ‚îÄ‚îÄ CAMPI DA COMPILARE (priorit√†) ‚îÄ‚îÄ
            {label:'Obiettivo', value:sd.obiettivo, field:true, critical:true, tipOk:'Obiettivo chiaro: guida tutta la strategia.', tipMiss:'Fondamentale: senza obiettivo il post non ha direzione.'},
            {label:'Target', value:sd.targetAnalisi, field:true, critical:true, tipOk:'Target definito: puoi personalizzare tono e messaggio.', tipMiss:'Chi vuoi raggiungere? Definisci et√†, interessi, ruolo.'},
            {label:'Argomento', value:sd.argomento, field:true, critical:true, tipOk:'Argomento definito.', tipMiss:'Di cosa parla il post? Compila "Scopo del post".'},
            {label:'Didascalia / Copy', value:sd.copyOriginale, field:true, critical:true, tipOk:'Copy presente: CTA e hook attivati.', tipMiss:'Inserisci il testo del post per analisi CTA e hook.'},
            {label:'Settore', value:sd.settore, field:true, critical:true, tipOk:'Settore specificato: aiuta tono e hashtag.', tipMiss:'Indica il settore per suggerimenti pi√π mirati.'},
            {label:'Promessa di valore', value:sd.promessa, field:false, critical:true, tipOk:'Promessa chiara.', tipWarn:'Dedotta automaticamente ‚Äî verifica.', tipMiss:'Nessuna promessa rilevata. Cosa ci guadagna chi legge?'},
            {label:'Prodotto / Servizio', value:sd.prodotto, field:true, critical:true, tipOk:'Prodotto identificato.', tipMiss:'Specifica cosa promuovi nel campo "Sottotipo".'},
            {label:'Contesto business', value:sd.contestoBusiness, field:true, critical:true, tipOk:'Contesto specificato.', tipMiss:'Aggiungi contesto per suggerimenti pi√π personalizzati.'},
            {label:'Brand / Titolo', value:sd.brand, field:true, critical:true, tipOk:'Brand identificato.', tipMiss:'Inserisci il titolo/nome brand.'},
            {label:'Tipo di hook', value:sd.hookType, field:false, critical:true, tipOk:'Hook rilevato.', tipMiss:'Inserisci la didascalia per analizzare l\'apertura.'},
            {label:'Allineamento pubblico', value:sd.alignment, field:false, critical:true, tipOk:'Contenuto e target coerenti.', tipWarn:'Verifica che il messaggio parli al tuo target.', tipMiss:'Servono target + didascalia per verificare.'},
            // ‚îÄ‚îÄ CAMPI AUTO-DEDOTTI ‚îÄ‚îÄ
            {label:'Messaggio commerciale', value:sd.messaggio, field:false, tipOk:'Messaggio coerente con obiettivo.', tipWarn:'Dedotto dall\'obiettivo ‚Äî verifica.'},
            {label:'Tema contenuto', value:sd.tema, field:false, tipOk:'Tema coerente.'},
            {label:'Fase funnel', value:sd.funnel, field:false, tipOk:'Fase identificata.', tipWarn:'Dedotta automaticamente dal testo e obiettivo.'},
            {label:'Tono comunicativo', value:sd.tono, field:false, tipOk:'Tono rilevato dall\'analisi visiva.', tipWarn:'Basato su luminosit√† e contrasto dell\'immagine.'},
            {label:'Tipo media', value:sd.tipoMedia, field:true, tipOk:'Formato definito.', tipMiss:'Seleziona il tipo di media.'},
            {label:'CTA rilevata', value:sd.ctaDetected !== ndDoc ? sd.ctaDetected + ' (' + sd.ctaType + ')' : ndDoc, field:false, tipOk:'CTA trovata.', tipMiss:'Nessuna CTA nel testo. Aggiungi un invito all\'azione.'},
        ];
        
        // Assign statuses
        for (const r of docRows) {
            if (r.value === ndDoc) { r.status = 'red'; r.tip = r.tipMiss || ''; }
            else if (!r.field && r.tipWarn) { r.status = 'orange'; r.tip = r.tipWarn; }
            else { r.status = 'green'; r.tip = r.tipOk || ''; }
            if (r.label === 'Allineamento pubblico' && r.value.includes('Verifica')) { r.status = 'orange'; r.tip = r.tipWarn || ''; }
        }
        
        const docMissing = docRows.filter(r => r.status === 'red');
        const docWarnings = docRows.filter(r => r.status === 'orange');
        const docPassed = docRows.filter(r => r.status === 'green');
        
        // Summary line
        body += mixedP([
            {text:`‚úì ${docPassed.length} superati  `,bold:true,color:'059669'},
            {text:`‚ö† ${docWarnings.length} avvisi  `,bold:true,color:'D97706'},
            {text:`‚úó ${docMissing.length} mancanti`,bold:true,color:'DC2626'}
        ]);
        body += p('');
        
        // RED: Missing fields first
        if (docMissing.length > 0) {
            body += mixedP([{text:`‚úó DA COMPILARE ‚Äî ${docMissing.length} campi mancanti`,bold:true,color:'DC2626'}]);
            for (const r of docMissing) {
                body += mixedP([{text:`  ‚úó ${r.label}: `,bold:true},{text:'Da compilare',color:'DC2626'}]);
                if (r.tip) body += p(`     ‚Üí ${r.tip}`, null, {color:'999999',size:18});
            }
            body += p('');
        }
        
        // ORANGE: Warnings
        if (docWarnings.length > 0) {
            body += mixedP([{text:`‚ö† AVVISI ‚Äî ${docWarnings.length} campi da verificare`,bold:true,color:'D97706'}]);
            for (const r of docWarnings) {
                body += mixedP([{text:`  ‚ö† ${r.label}: `,bold:true},{text:r.value,color:'D97706'}]);
                if (r.tip) body += p(`     ‚Üí ${r.tip}`, null, {color:'999999',size:18});
            }
            body += p('');
        }
        
        // GREEN: Passed
        if (docPassed.length > 0) {
            body += mixedP([{text:`‚úì SUPERATI ‚Äî ${docPassed.length} campi OK`,bold:true,color:'059669'}]);
            for (const r of docPassed) {
                body += mixedP([{text:`  ‚úì ${r.label}: `,bold:true},{text:r.value,color:'059669'}]);
                if (r.tip) body += p(`     ${r.tip}`, null, {color:'999999',size:18});
            }
            body += p('');
        }
        
        body += p('8.2 Risposte Operative', 'Heading2');
        body += p(`1. Post organico o sponsorizzato? ‚Üí ${sd.organicOrSponsored}`, null, {bold:true});
        body += p(sd.organicReason);
        body += p(`2. Obiettivo unico ‚Üí ${sd.uniqueObj}`, null, {bold:true});
        body += p(sd.uniqueObjReason);
        body += p(`3. Quanto diretto posso essere? ‚Üí ${sd.directness}`, null, {bold:true});
        body += p(sd.directnessReason);
        
        body += p('8.3 Sintesi per il Cliente', 'Heading2');
        body += p(`Questo post ${sd.argomento !== 'Non determinabile' ? 'parla di ' + sd.argomento : 'ha un argomento da verificare'}${sd.settore !== 'Non determinabile' ? ' nel settore ' + sd.settore : ''}. L'obiettivo principale √® ${sd.obiettivo}. Il post si trova nella fase ${sd.funnel.includes('TOFU') ? 'iniziale (farsi conoscere)' : sd.funnel.includes('MOFU') ? 'intermedia (creare interesse)' : sd.funnel.includes('BOFU') ? 'finale (spingere all\'azione)' : 'non determinata'} del percorso cliente.`);
        body += p(`Il tono comunicativo rilevato √® "${sd.tono.toLowerCase()}" e il livello di pressione consigliato √® "${sd.directness.toLowerCase()}".`);
        if (sd.targetAnalisi !== 'Non determinabile') body += p(`Il target √®: ${sd.targetAnalisi}. ${sd.alignment !== 'Non determinabile' ? sd.alignment : ''}`);
        if (sd.ctaDetected !== 'Non determinabile') body += p(`CTA rilevata: "${sd.ctaDetected}" (tipo: ${sd.ctaType}).`);
        if (sd.hookType !== 'Non determinabile') body += p(`Tipo di hook usato: ${sd.hookType}.`);
        if (sd.promessa !== 'Non determinabile') body += p(`La promessa di valore implicita √®: ${sd.promessa}.`);
        
        // Color Psychology
        const docPsych = state.colorPsychology || getColorPsychology(a.palette);
        if (docPsych && docPsych.length > 0) {
            body += p('8.4 Psicologia dei Colori', 'Heading2');
            body += p('I colori dominanti comunicano i seguenti messaggi al pubblico:');
            const seenDoc = new Set();
            for (const cp of docPsych) {
                if (seenDoc.has(cp.name)) continue;
                seenDoc.add(cp.name);
                body += mixedP([{text:`${cp.emoji} ${cp.name} (${cp.hex}): `,bold:true},{text:`${cp.emotion} ‚Äî Ideale per: ${cp.use}`}]);
            }
        }
        
        // Media Type Recommendation
        const docMediaRec = getMediaRecommendation(state.platform, state.goal, a);
        body += p('9. Tipo Media Consigliato', 'Heading1');
        body += p(`Consigliato: ${docMediaRec.primary.label}`, null, {bold:true});
        body += p(docMediaRec.primary.reason);
        if (docMediaRec.alt) {
            body += p(`Alternativa: ${docMediaRec.alt.label}`, null, {bold:true});
            body += p(docMediaRec.alt.reason);
        }
        if (docMediaRec.ambiguityRisk) {
            body += p(`‚ö† ${docMediaRec.ambiguityRisk}`);
        }
        
        // Action Plan
        body += p('10. Piano d\'Azione', 'Heading1');
        
        const docPostTime = getPostingTime(state.platform, state.goal);
        const docSettore = getFieldVal('fieldSettore');
        const docHashtags = getHashtagStrategy(state.platform, state.goal, docSettore);
        
        body += p('10.1 Quando Pubblicare', 'Heading2');
        body += mixedP([{text:'Fasce orarie ottimali: ',bold:true},{text:docPostTime.best.join(', ')}]);
        body += mixedP([{text:'Giorni migliori: ',bold:true},{text:docPostTime.days.join(', ')}]);
        body += p(`Tip: ${docPostTime.tip || 'Pubblica quando il tuo pubblico √® pi√π attivo. Verifica gli insight della piattaforma per dati personalizzati.'}`);
        
        body += p('10.2 Checklist Pre-Pubblicazione', 'Heading2');
        body += p(`${a.bestRatioMatch >= 85 ? '‚úì' : '‚úó'} Formato immagine corretto per ${platformName} (${a.bestRatioMatch}% match)`);
        body += p(`${a.wcagRatio >= 4.5 ? '‚úì' : '‚úó'} Contrasto testo leggibile (WCAG ${a.wcagRatio}:1)`);
        body += p(`${a.safeZoneCompliance >= 85 ? '‚úì' : '‚úó'} Contenuti dentro le safe zones (${a.safeZoneCompliance}%)`);
        body += p(`${a.entropy <= 5.5 ? '‚úì' : '‚úó'} Complessit√† gestibile (entropia ${a.entropy}/8)`);
        body += p(`${a.negativeSpace >= 20 ? '‚úì' : '‚úó'} Spazio negativo sufficiente (${a.negativeSpace}%)`);
        
        body += p('10.3 Checklist Post-Pubblicazione', 'Heading2');
        body += p('‚óã Rispondi ai commenti entro 30 min (boost algoritmico)');
        body += p('‚óã Condividi nelle stories/altri canali entro 1h');
        body += p(`‚óã ${sd.organicOrSponsored.includes('Sponsorizzato') ? 'Attiva sponsorizzazione dopo 1-2h di organico' : 'Monitora reach organico per 24h'}`);
        body += p('‚óã Controlla metriche dopo 24h (CTR, saves, shares)');
        body += p('‚óã Se engagement basso ‚Üí testa variante A/B dell\'immagine');
        body += p('‚óã Documenta i risultati per il prossimo contenuto');
        
        if (docHashtags.length > 0) {
            body += p('10.4 Strategia Hashtag', 'Heading2');
            body += p(`${state.platform === 'instagram' ? 'Usa 5-10 hashtag: mix alta popolarit√† + nicchia' : state.platform === 'linkedin' ? 'Max 3-5 hashtag professionali' : state.platform === 'tiktok' ? 'Max 3-4 hashtag + trending' : 'Max 3-5 hashtag rilevanti'}`);
            for (const group of docHashtags) {
                body += mixedP([{text:group.cat + ': ',bold:true},{text:group.tags.join(' ')}]);
            }
        }
        
        // AI Prompts
        body += p('11. Prompt AI per il Post Completo', 'Heading1');
        
        body += p('11.1 Prompt Immagine', 'Heading2');
        body += p('Copia e incolla in ChatGPT/DALL-E, Midjourney o qualsiasi AI di generazione immagini:');
        const docImgPrompt = generateImagePrompt(a, state.platform, state.goal, state.target, 'graphic', 'it');
        for (const line of docImgPrompt.split('\n')) {
            if (line.trim()) body += `<w:p><w:pPr><w:shd w:val="clear" w:color="auto" w:fill="F0FDFA"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/><w:color w:val="0F766E"/></w:rPr><w:t xml:space="preserve">${esc(line)}</w:t></w:r></w:p>`;
        }
        body += p('');
        body += p('Versione inglese (per Midjourney/DALL-E):', null, {bold:true});
        const docImgPromptEn = generateImagePrompt(a, state.platform, state.goal, state.target, 'graphic', 'en');
        for (const line of docImgPromptEn.split('\n')) {
            if (line.trim()) body += `<w:p><w:pPr><w:shd w:val="clear" w:color="auto" w:fill="EFF6FF"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/><w:color w:val="1E40AF"/></w:rPr><w:t xml:space="preserve">${esc(line)}</w:t></w:r></w:p>`;
        }
        
        body += p('');
        body += p('11.2 Prompt Testo / Caption', 'Heading2');
        body += p('Copia e incolla in ChatGPT, Claude o qualsiasi AI testuale per generare la caption del post:');
        const docTxtPrompt = generateContentPrompt(a, state.platform, state.goal, state.target, 'professional', 'it');
        for (const line of docTxtPrompt.split('\n')) {
            if (line.trim()) body += `<w:p><w:pPr><w:shd w:val="clear" w:color="auto" w:fill="FFF7ED"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/><w:color w:val="9A3412"/></w:rPr><w:t xml:space="preserve">${esc(line)}</w:t></w:r></w:p>`;
        }
        body += p('');
        body += p('Versione inglese:', null, {bold:true});
        const docTxtPromptEn = generateContentPrompt(a, state.platform, state.goal, state.target, 'professional', 'en');
        for (const line of docTxtPromptEn.split('\n')) {
            if (line.trim()) body += `<w:p><w:pPr><w:shd w:val="clear" w:color="auto" w:fill="EFF6FF"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/><w:color w:val="1E40AF"/></w:rPr><w:t xml:space="preserve">${esc(line)}</w:t></w:r></w:p>`;
        }
        
        // Next steps
        body += p('12. Prossimi Passi', 'Heading1');
        body += p(`1. Implementa le raccomandazioni ad alta priorit√† (${recs.filter(r=>r.priority==='high').length} identificate)`);
        body += p('2. Conduci A/B test: minimo 1.000 impression per variante');
        body += p('3. Monitora CTR, engagement rate e tempo di visualizzazione');
        body += p('4. Rianalizza il post ottimizzato con questo strumento');
        body += p('5. Itera e applica gli apprendimenti ai prossimi contenuti');
        
        // Footer
        body += `<w:p><w:pPr><w:pBdr><w:top w:val="single" w:sz="6" w:color="E5E7EB"/></w:pBdr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:sz w:val="18"/><w:color w:val="999999"/></w:rPr><w:t>Report generato da SocialStrategist AI ‚Äî ${esc(date)} ‚Äî Analisi 100% client-side</w:t></w:r></w:p>`;
        
        // document.xml
        const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
            xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
            xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
            xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>
    ${body}
    <w:sectPr>
      <w:pgSz w:w="11906" w:h="16838"/>
      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>
    </w:sectPr>
  </w:body>
</w:document>`;
        
        zip.folder('word').file('document.xml', docXml);
        
        // Generate and download
        const blob = await zip.generateAsync({type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Report-Post-${platformName}-${date.replace(/ /g,'-')}.docx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        btn.innerHTML = '<i class="fas fa-check"></i> Report scaricato!';
        btn.style.background = 'linear-gradient(135deg, #10b981, #14b8a6)';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-download"></i> Scarica Report .docx';
            btn.style.background = '';
            btn.disabled = false;
        }, 3000);
        
    } catch(err) {
        console.error('DOCX generation error:', err);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Errore ‚Äî riprova';
        btn.disabled = false;
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-download"></i> Scarica Report .docx';
        }, 3000);
    }
}

// ==================== AI PROMPT GENERATOR ====================
let promptLang = 'it';
let promptStyle = 'photo';
let promptTone = 'professional';

// Style button handlers (image)
document.querySelectorAll('#promptStyleBtns .swa-prompt-style-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#promptStyleBtns .swa-prompt-style-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        promptStyle = btn.dataset.style;
        if (state.analysis) renderAllPrompts();
    });
});

// Tone button handlers (content)
document.querySelectorAll('#promptToneBtns .swa-prompt-style-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#promptToneBtns .swa-prompt-style-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        promptTone = btn.dataset.tone;
        if (state.analysis) renderAllPrompts();
    });
});

// Data textarea + structured fields live update
let dataDebounce = null;
const fieldIds = ['contentDataInput','fieldScopo','fieldObiettivo','fieldTipoMedia','fieldSottotipo','fieldSettore','fieldPubblico','fieldTitolo1','fieldTitolo2','fieldTitolo3','fieldDidascalia','fieldContesto'];
document.addEventListener('input', function(e) {
    if (e.target && fieldIds.includes(e.target.id)) {
        clearTimeout(dataDebounce);
        dataDebounce = setTimeout(() => { 
            if (state.analysis) { renderAllPrompts(); renderStrategicAnalysis(state.analysis); renderStrategyScore(); }
        }, 300);
    }
});
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'fieldTipoMedia') {
        if (state.analysis) { renderAllPrompts(); renderStrategicAnalysis(state.analysis); renderStrategyScore(); }
    }
});

function switchPromptTab(tab) {
    document.querySelectorAll('.swa-prompt-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.querySelectorAll('.swa-prompt-tab-content').forEach(c => c.classList.remove('active'));
    const map = {image:'tabImage', content:'tabContent', combined:'tabCombined'};
    $(map[tab]).classList.add('active');
}

function setPromptLang(lang) {
    promptLang = lang;
    document.querySelectorAll('.swa-prompt-lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
    if (state.analysis) renderAllPrompts();
}

function renderAllPrompts() {
    const a = state.analysis;
    if (!a) return;
    $('promptTextImage').textContent = generateImagePrompt(a, state.platform, state.goal, state.target, promptStyle, promptLang);
    $('promptTextContent').textContent = generateContentPrompt(a, state.platform, state.goal, state.target, promptTone, promptLang);
    $('promptTextCombined').textContent = generateCombinedPrompt(a, state.platform, state.goal, state.target, promptStyle, promptTone, promptLang);
}

// Alias for DOCX generation compatibility
function generatePromptText(a, platform, goal, target, style, lang) {
    return generateImagePrompt(a, platform, goal, target, style, lang);
}

// ==================== IMAGE PROMPT ====================
function generateImagePrompt(a, platform, goal, target, style, lang) {
    const recs = a.recommendations || [];
    const fixes = recs.slice(0, 4).map(r => recToImageFix(r, lang, platform));
    const topColors = a.palette.slice(0, 4).map(c => rgbToHex(c.r, c.g, c.b));
    const paletteDesc = topColors.join(', ');
    const platDims = platformFormats(platform, lang);
    const harmony = harmonyTranslate(a.harmonyType, lang);
    
    const styleDesc = {
        photo: {en:'Professional photography style, photorealistic, high resolution, studio lighting, sharp details', it:'Stile fotografico professionale, fotorealistico, alta risoluzione, illuminazione da studio, dettagli nitidi'},
        graphic: {en:'Modern graphic design, flat design with subtle gradients, bold typography, vector-style elements', it:'Design grafico moderno, flat design con gradienti sottili, tipografia bold, elementi stile vettoriale'},
        illustration: {en:'Digital illustration style, artistic, hand-drawn feel with digital polish, expressive colors', it:'Stile illustrazione digitale, artistico, tratto a mano con finitura digitale, colori espressivi'},
        minimal: {en:'Minimalist design, lots of white space, essential elements only, elegant simplicity, clean lines', it:'Design minimalista, molto spazio bianco, solo elementi essenziali, semplicit√† elegante, linee pulite'}
    };
    
    const goalImg = {
        sales: {en:'Drive direct sales/conversions. Include a prominent, high-contrast CTA button or text. Create urgency.', it:'Stimolare vendite/conversioni dirette. Includi una CTA prominente e ad alto contrasto. Crea senso di urgenza.'},
        awareness: {en:'Build brand awareness and memorability. Focus on brand identity, distinctive visual style, and emotional impact.', it:'Costruire brand awareness e memorabilit√†. Focus su identit√† di marca, stile visivo distintivo e impatto emotivo.'},
        engagement: {en:'Maximize engagement. Include curiosity-triggering elements, questions, or relatable content.', it:'Massimizzare engagement. Includi elementi che stimolano curiosit√†, domande o contenuti in cui identificarsi.'},
        leads: {en:'Generate leads/contacts. Include a clear value proposition and CTA for sign-up/download.', it:'Generare lead/contatti. Includi una proposta di valore chiara e CTA verso iscrizione/download.'},
        traffic: {en:'Drive website traffic. Include a clear visual hook and text suggesting "learn more".', it:'Generare traffico al sito. Includi un hook visivo chiaro e testo "scopri di pi√π".'}
    };
    
    const targetLine = target ? (lang==='en' ? `Target audience: ${target}.` : `Target di riferimento: ${target}.`) : '';
    
    const compNotes = [];
    if (a.negativeSpace < 25) compNotes.push(lang==='en' ? 'Use generous whitespace (at least 30-35% of canvas)' : 'Ampio spazio vuoto (almeno 30-35% del canvas)');
    if (a.entropy > 5.5) compNotes.push(lang==='en' ? 'Keep design simple: max 5 visual elements' : 'Design semplice: massimo 5 elementi visivi');
    if (a.centerBias < 50) compNotes.push(lang==='en' ? 'Place main subject/CTA at center or rule-of-thirds points' : 'Soggetto/CTA al centro o nei punti regola dei terzi');
    
    // Collect structured fields for context
    function val(id) { const el = $(id); return el ? el.value.trim() : ''; }
    const F = {
        scopo: val('fieldScopo'), settore: val('fieldSettore'), titolo1: val('fieldTitolo1'),
        titolo2: val('fieldTitolo2'), titolo3: val('fieldTitolo3'), contesto: val('fieldContesto'),
        didascalia: val('fieldDidascalia'), sottotipo: val('fieldSottotipo'),
        datiExtra: val('contentDataInput')
    };
    const allContext = [F.titolo1, F.titolo2, F.titolo3, F.didascalia, F.contesto, F.datiExtra].filter(Boolean).join('\n');
    const hasContext = allContext.length > 0;
    
    if (lang === 'it') {
        let p = `Analizza lo screenshot del post social concentrandoti PRIMA sul contenuto testuale e sul contesto, NON solo sull'estetica.\n\n`;
        
        // ‚îÄ‚îÄ IDENTIFICATION ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `IDENTIFICAZIONE OBBLIGATORIA\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Identifica chiaramente:\n`;
        p += `‚Äì il tipo di contenuto (evento, corso, promozione, informazione)\n`;
        p += `‚Äì il settore reale (es. cucina, alimentazione naturale, formazione, benessere)\n`;
        p += `‚Äì il brand o nome dell'attivit√† citata, che deve essere considerato CENTRALE\n\n`;
        
        // ‚îÄ‚îÄ CONTEXT FROM FIELDS ‚îÄ‚îÄ
        if (hasContext) {
            p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            p += `DATI REALI DEL POST\n`;
            p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            if (F.settore) p += `Settore: ${F.settore}\n`;
            if (F.sottotipo) p += `Tipo contenuto: ${F.sottotipo}\n`;
            if (F.titolo1) p += `Titolo: ${F.titolo1}\n`;
            if (F.titolo2) p += `Sottotitolo: ${F.titolo2}\n`;
            if (F.titolo3) p += `Supporto: ${F.titolo3}\n`;
            if (F.contesto) p += `Contesto: ${F.contesto}\n`;
            if (F.didascalia) p += `Didascalia: ${F.didascalia}\n`;
            if (F.datiExtra) p += `Info extra: ${F.datiExtra.substring(0, 400)}\n`;
            p += '\n';
        }
        
        // ‚îÄ‚îÄ GENERATION TASK ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `GENERA IL PROMPT IMMAGINE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Crea un'immagine ${platDims} per un post ${pName(platform,'it')}.\n\n`;
        p += `STILE: ${styleDesc[style].it}\n`;
        p += `OBIETTIVO: ${goalImg[goal].it}\n`;
        if (targetLine) p += targetLine + '\n';
        
        p += `\nGenera un prompt per un'immagine COERENTE con il tema del post, che aiuti l'utente a capire immediatamente di cosa si tratta.\n\n`;
        
        // ‚îÄ‚îÄ SECTOR-SPECIFIC VISUAL RULES ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `REGOLE VISIVE DI COERENZA SETTORE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Se il post riguarda un corso o evento di cucina o benessere ‚Üí l'immagine DEVE includere riferimenti visivi pertinenti (ingredienti, cucina, cibo reale, ambiente autentico) e uno stile naturale, educativo e accogliente.\n`;
        p += `‚Ä¢ Se riguarda formazione ‚Üí aula, materiali didattici, persone che apprendono, ambiente professionale.\n`;
        p += `‚Ä¢ Se riguarda un prodotto ‚Üí il prodotto stesso in primo piano, nel suo contesto d'uso reale.\n`;
        p += `‚Ä¢ Se riguarda un evento ‚Üí elementi che identifichino immediatamente il tipo di evento (location, attivit√†, atmosfera).\n\n`;
        
        // ‚îÄ‚îÄ PROHIBITIONS ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `DIVIETI\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ NON inventare slogan, claim o messaggi motivazionali non presenti o non deducibili dal post.\n`;
        p += `‚Ä¢ Evita AUTOMATICAMENTE estetiche non pertinenti: moda, beauty, lusso, simboli astratti o figure stilizzate ‚Äî a meno che non siano esplicitamente citate nel contenuto.\n`;
        p += `‚Ä¢ NON usare elementi decorativi generici che non comunicano il settore reale.\n\n`;
        
        // ‚îÄ‚îÄ PALETTE & COMPOSITION ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `PALETTE COLORI E COMPOSIZIONE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Colori di riferimento: ${paletteDesc}. Armonia: ${harmony}.\n`;
        for (const f of fixes) p += `- ${f}\n`;
        for (const n of compNotes) p += `- ${n}\n`;
        
        // ‚îÄ‚îÄ TECHNICAL SPECS ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `SPECIFICHE TECNICHE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `- Formato: ${platDims}\n`;
        p += `- Contrasto testo ‚â• 7:1\n`;
        p += `- Elementi chiave entro 80% centrale (safe zones)\n`;
        p += `- Alta risoluzione, dettagli nitidi, nessun artefatto\n\n`;
        
        // ‚îÄ‚îÄ COHERENCE TEST ‚îÄ‚îÄ
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `TEST DI COERENZA FINALE (OBBLIGATORIO)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Prima di finalizzare il prompt, verifica:\n`;
        p += `"Guardando SOLO l'immagine, si capisce subito di che evento o contenuto si tratta?"\n`;
        p += `Se la risposta √® NO ‚Üí correggi il prompt.\n\n`;
        p += `Il prompt finale deve descrivere un'immagine che potrebbe essere pubblicata sulla pagina social del brand SENZA creare ambiguit√† di settore.\n`;
        p += `L'immagine deve risultare professionale e catturare immediatamente l'attenzione nel feed ${pName(platform,'it')}.`;
        return p;
        
    } else {
        // ‚îÄ‚îÄ ENGLISH ‚îÄ‚îÄ
        let p = `Analyze the social post screenshot focusing FIRST on textual content and context, NOT just aesthetics.\n\n`;
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `MANDATORY IDENTIFICATION\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Clearly identify:\n`;
        p += `‚Äì the content type (event, course, promotion, information)\n`;
        p += `‚Äì the real sector (e.g. cooking, natural food, training, wellness)\n`;
        p += `‚Äì the brand or business name cited, which must be considered CENTRAL\n\n`;
        
        if (hasContext) {
            p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            p += `REAL POST DATA\n`;
            p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            if (F.settore) p += `Sector: ${F.settore}\n`;
            if (F.sottotipo) p += `Content type: ${F.sottotipo}\n`;
            if (F.titolo1) p += `Title: ${F.titolo1}\n`;
            if (F.titolo2) p += `Subtitle: ${F.titolo2}\n`;
            if (F.titolo3) p += `Support: ${F.titolo3}\n`;
            if (F.contesto) p += `Context: ${F.contesto}\n`;
            if (F.didascalia) p += `Caption: ${F.didascalia}\n`;
            if (F.datiExtra) p += `Extra info: ${F.datiExtra.substring(0, 400)}\n`;
            p += '\n';
        }
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `GENERATE IMAGE PROMPT\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Create a ${platDims} image for a ${pName(platform,'en')} post.\n\n`;
        p += `STYLE: ${styleDesc[style].en}\n`;
        p += `OBJECTIVE: ${goalImg[goal].en}\n`;
        if (targetLine) p += targetLine + '\n';
        
        p += `\nGenerate a prompt for an image COHERENT with the post theme, helping the user immediately understand what it's about.\n\n`;
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `SECTOR-SPECIFIC VISUAL RULES\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ If the post is about a cooking or wellness course/event ‚Üí image MUST include relevant visual references (ingredients, kitchen, real food, authentic environment) with a natural, educational, welcoming style.\n`;
        p += `‚Ä¢ If about training ‚Üí classroom, educational materials, people learning, professional environment.\n`;
        p += `‚Ä¢ If about a product ‚Üí the product itself in the foreground, in its real context of use.\n`;
        p += `‚Ä¢ If about an event ‚Üí elements that immediately identify the type of event (location, activity, atmosphere).\n\n`;
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `PROHIBITIONS\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Do NOT invent slogans, claims or motivational messages not present or deducible from the post.\n`;
        p += `‚Ä¢ AUTOMATICALLY avoid non-pertinent aesthetics: fashion, beauty, luxury, abstract symbols or stylized figures ‚Äî unless explicitly cited in the content.\n`;
        p += `‚Ä¢ Do NOT use generic decorative elements that don't communicate the real sector.\n\n`;
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `COLOR PALETTE & COMPOSITION\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Reference colors: ${paletteDesc}. Harmony: ${harmony}.\n`;
        for (const f of fixes) p += `- ${f}\n`;
        for (const n of compNotes) p += `- ${n}\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `TECHNICAL SPECS\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `- Aspect ratio: ${platDims}\n`;
        p += `- Text contrast ratio ‚â• 7:1\n`;
        p += `- All key elements within central 80% (safe zones)\n`;
        p += `- High resolution, crisp details, no artifacts\n\n`;
        
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `FINAL COHERENCE TEST (MANDATORY)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Before finalizing the prompt, verify:\n`;
        p += `"Looking at ONLY the image, can you immediately tell what event or content this is about?"\n`;
        p += `If the answer is NO ‚Üí fix the prompt.\n\n`;
        p += `The final prompt must describe an image that could be published on the brand's social page WITHOUT creating sector ambiguity.\n`;
        p += `The image must feel professional and instantly capture attention in a ${pName(platform,'en')} feed.`;
        return p;
    }
}

// ==================== CONTENT / TEXT PROMPT (MASTER MULTI-PIATTAFORMA + FRAMEWORK STRATEGICO) ====================
function generateContentPrompt(a, platform, goal, target, tone, lang) {
    // Collect structured fields
    const F = {
        scopo: val('fieldScopo'),
        obiettivo: val('fieldObiettivo'),
        tipoMedia: val('fieldTipoMedia'),
        sottotipo: val('fieldSottotipo'),
        settore: val('fieldSettore'),
        pubblico: val('fieldPubblico'),
        titolo1: val('fieldTitolo1'),
        titolo2: val('fieldTitolo2'),
        titolo3: val('fieldTitolo3'),
        didascalia: val('fieldDidascalia'),
        contesto: val('fieldContesto'),
        datiExtra: val('contentDataInput')
    };
    function val(id) { const el = $(id); return el ? el.value.trim() : ''; }
    
    const platLabel = {instagram:'Instagram', tiktok:'TikTok / Reels', linkedin:'LinkedIn', facebook:'Facebook', web:'Web / Landing Page'};
    const goalLabels = {
        it:{sales:'vendere / promuovere',awareness:'posizionare il brand',engagement:'generare interazione',leads:'generare lead / contatti',traffic:'generare traffico al sito'},
        en:{sales:'sell / promote',awareness:'brand positioning',engagement:'generate engagement',leads:'generate leads',traffic:'drive website traffic'}
    };
    const toneLabels = {
        it:{professional:'professionale e autorevole',friendly:'caldo e conversazionale',educational:'educativo e informativo',inspirational:'ispirazionale e motivante'},
        en:{professional:'professional and authoritative',friendly:'warm and conversational',educational:'educational and informative',inspirational:'inspirational and motivating'}
    };
    const mediaRec = getMediaRecommendation(platform, goal, a);
    const nd = lang==='it' ? 'non determinabile' : 'not determinable';
    
    if (lang === 'it') {
        let p = `PROMPT MASTER MULTI-PIATTAFORMA (SOCIAL + WEB)\n\n`;
        p += `RUOLO: Analizza i dati forniti e produci un testo in italiano pronto da pubblicare, coerente con i contenuti, ottimizzato per la piattaforma indicata.\n\n`;
        
        // ‚îÄ‚îÄ HEADER FIELDS ‚îÄ‚îÄ
        p += `PIATTAFORMA: ${platLabel[platform]}\n`;
        p += `SCOPO: ${F.scopo || nd}\n`;
        p += `OBIETTIVO: ${F.obiettivo || goalLabels.it[goal]}\n`;
        p += `TIPO MEDIA: ${F.tipoMedia || mediaRec.primary.label}\n`;
        p += `SOTTOTIPO: ${F.sottotipo || nd}\n`;
        p += `SETTORE: ${F.settore || nd}\n`;
        p += `PUBBLICO TARGET: ${F.pubblico || target || nd}\n`;
        p += `TONO DI VOCE: ${toneLabels.it[tone]}\n`;
        p += `TITOLO PRINCIPALE: ${F.titolo1 || nd}\n`;
        p += `TITOLO SECONDARIO: ${F.titolo2 || nd}\n`;
        p += `TITOLO DI SUPPORTO: ${F.titolo3 || nd}\n`;
        p += `CONTESTO: ${F.contesto || nd}\n`;
        if (F.didascalia) p += `DIDASCALIA ORIGINALE: ${F.didascalia}\n`;
        
        // ‚îÄ‚îÄ ANTI-HALLUCINATION ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `REGOLA BASE ANTI-ALLUCINAZIONE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Ogni classificazione deve essere basata su evidenza nel testo o contesto.\n`;
        p += `Se l'evidenza non √® presente ‚Üí dichiarare "${nd}".\n`;
        p += `Non completare mai campi inventando.\n`;
        
        // ‚îÄ‚îÄ ANALYSIS ORDER ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `ORDINE ANALISI OBBLIGATORIO\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Prima di scrivere, analizza in sequenza:\n`;
        p += `1. Testo esplicito nei dati\n`;
        p += `2. Parole chiave settore\n`;
        p += `3. Contesto dichiarato\n`;
        p += `4. Oggetto reale del contenuto\n`;
        p += `5. Brand nominato\n`;
        p += `6. Obiettivo deducibile\n`;
        p += `Non usare l'estetica come prima fonte.\n`;
        
        // ‚îÄ‚îÄ CONSTRAINTS ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `VINCOLI OBBLIGATORI (NON NEGOZIABILI)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Usa SOLO le informazioni presenti nei DATI e nei campi compilati.\n`;
        p += `‚Ä¢ Non inventare, non ampliare, non aggiungere promesse, valori o benefici non esplicitati.\n`;
        p += `‚Ä¢ Mantieni fedeli nomi, date, orari, luoghi, prezzi, contatti, link.\n`;
        p += `‚Ä¢ Se un'informazione non √® presente, non compensare con storytelling generico.\n`;
        p += `‚Ä¢ Il testo deve rimanere 100% focalizzato sull'obiettivo dichiarato.\n`;
        
        // ‚îÄ‚îÄ CREATIVE BAN ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `DIVIETO COMPLETAMENTO CREATIVO\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `NON inventare: slogan, CTA non presenti nei dati, brand intent, posizionamento, target specifici, promesse.\n`;
        p += `Solo deduzione ragionata o "${nd}".\n`;
        
        // ‚îÄ‚îÄ UNCERTAINTY ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `GESTIONE INCERTEZZA\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Se mancano dati:\n`;
        p += `‚Ä¢ settore ‚Üí "settore ${nd}"\n`;
        p += `‚Ä¢ pubblico ‚Üí "pubblico ${nd}"\n`;
        p += `‚Ä¢ intento ‚Üí "intento probabile: X"\n`;
        p += `Segnare sempre come stima.\n`;
        
        // ‚îÄ‚îÄ PLATFORM ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `ADATTAMENTO PIATTAFORMA\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        if (platform==='facebook'||platform==='linkedin') p += `‚Üí ${platLabel[platform]}: Testo strutturato, chiaro, informativo, con spaziature leggibili.\n`;
        else if (platform==='instagram') p += `‚Üí Instagram: Hook forte nelle prime 2 righe, tono pi√π emozionale ma informativo.\n`;
        else if (platform==='tiktok') { p += `‚Üí TikTok / Reels:\n  ‚Ä¢ 1 frase breve per testo on-screen\n  ‚Ä¢ 1 caption sintetica di supporto\n`; }
        else if (platform==='web') { p += `‚Üí Web / Landing Page:\n  ‚Ä¢ Titolo principale (headline)\n  ‚Ä¢ Paragrafo introduttivo chiaro e orientato all'azione\n`; }
        
        // ‚îÄ‚îÄ STRUCTURE ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `STRUTTURA OBBLIGATORIA DEL CONTENUTO\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `1. HOOK ‚Äî apertura immediata, rilevante e coerente con il messaggio reale\n`;
        p += `2. CORPO ‚Äî spiegazione ordinata del contenuto principale\n`;
        if (goal==='sales') p += `   ‚Ä¢ promozionale ‚Üí proposta chiara senza enfasi artificiale\n`;
        else if (goal==='awareness'||goal==='engagement') p += `   ‚Ä¢ informativo ‚Üí contesto + informazione chiave\n`;
        else p += `   ‚Ä¢ evento/offerta ‚Üí cosa / perch√© / cosa succede\n`;
        p += `3. BLOCCO INFORMATIVO (se presente nei dati):\n`;
        p += `   üìÖ QUANDO / üìç DOVE / üí∞ PREZZO / ‚ÑπÔ∏è INFO\n`;
        p += `4. CTA ‚Äî una sola call to action, coerente con la piattaforma (solo se deducibile dai dati)\n`;
        p += `5. HASHTAG ‚Äî solo se adatti alla piattaforma (max 1‚Äì3)\n`;
        
        // ‚îÄ‚îÄ EVIDENCE ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `CONTROLLO EVIDENZA ‚Üí CONCLUSIONE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Dato presente ‚Üí usare\n`;
        p += `‚Ä¢ Dato deducibile ‚Üí usare con cautela\n`;
        p += `‚Ä¢ Dato assente ‚Üí NON inserire\n`;
        
        // ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `LIMITI E FORMATO\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Linguaggio chiaro, leggibile da mobile\n`;
        p += `‚Ä¢ Lunghezza adattata alla piattaforma\n`;
        p += `‚Ä¢ Nessuna istruzione meta, solo testo finale pronto all'uso\n`;
        p += `‚Ä¢ Usa eventuali link presenti nei dati\n`;
        
        // ‚îÄ‚îÄ FALLBACK ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `FALLBACK SICUREZZA\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Se i dati sono insufficienti: produci solo ci√≤ che √® determinabile, segnala i campi mancanti, NON espandere creativamente.\n`;
        
        // ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `DATI DA USARE (VERBATIM)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        if (F.datiExtra) p += F.datiExtra + '\n';
        else p += `[Incolla dati aggiuntivi nel campo "Dati aggiuntivi" dell'app]\n`;
        
        return p;
        
    } else {
        // ‚îÄ‚îÄ ENGLISH ‚îÄ‚îÄ
        let p = `MULTI-PLATFORM MASTER PROMPT (SOCIAL + WEB)\n\n`;
        p += `ROLE: Analyze the provided data and produce a ready-to-publish text, optimized for the indicated platform.\n\n`;
        
        p += `PLATFORM: ${platLabel[platform]}\n`;
        p += `PURPOSE: ${F.scopo || nd}\n`;
        p += `OBJECTIVE: ${F.obiettivo || goalLabels.en[goal]}\n`;
        p += `MEDIA TYPE: ${F.tipoMedia || mediaRec.primary.label}\n`;
        p += `SUBTYPE: ${F.sottotipo || nd}\n`;
        p += `SECTOR: ${F.settore || nd}\n`;
        p += `TARGET AUDIENCE: ${F.pubblico || target || nd}\n`;
        p += `TONE OF VOICE: ${toneLabels.en[tone]}\n`;
        p += `MAIN TITLE: ${F.titolo1 || nd}\n`;
        p += `SECONDARY TITLE: ${F.titolo2 || nd}\n`;
        p += `SUPPORT TITLE: ${F.titolo3 || nd}\n`;
        p += `CONTEXT: ${F.contesto || nd}\n`;
        if (F.didascalia) p += `ORIGINAL CAPTION: ${F.didascalia}\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `ANTI-HALLUCINATION BASE RULE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Every classification must be based on evidence. If not present ‚Üí "${nd}". Never invent.\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `MANDATORY ANALYSIS ORDER\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Before writing: 1.Explicit text 2.Sector keywords 3.Context 4.Real object 5.Named brand 6.Deducible objective\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `MANDATORY CONSTRAINTS (NON-NEGOTIABLE)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `‚Ä¢ Use ONLY info in DATA and filled fields. No inventing. Keep names/dates/prices faithful. No generic storytelling.\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `CREATIVE COMPLETION BAN\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `Do NOT invent: slogans, CTAs not in data, brand intent, positioning, promises. Only reasoned deduction or "${nd}".\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `PLATFORM ADAPTATION\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        if (platform==='facebook'||platform==='linkedin') p += `‚Üí ${platLabel[platform]}: Structured, clear, informative.\n`;
        else if (platform==='instagram') p += `‚Üí Instagram: Strong hook in first 2 lines.\n`;
        else if (platform==='tiktok') p += `‚Üí TikTok: 1 short on-screen line + 1 brief caption.\n`;
        else if (platform==='web') p += `‚Üí Web: Headline + action-oriented intro paragraph.\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `MANDATORY STRUCTURE\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `1.HOOK 2.BODY 3.INFO BLOCK(üìÖWHEN/üìçWHERE/üí∞PRICE/‚ÑπÔ∏èINFO) 4.CTA(one, from data only) 5.HASHTAGS(max 1-3)\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `EVIDENCE CONTROL: Present‚Üíuse | Deducible‚Üícaution | Absent‚ÜíDO NOT insert\n`;
        p += `SAFETY FALLBACK: If insufficient‚Üíproduce only determinable, flag missing, do NOT expand creatively.\n`;
        
        p += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        p += `DATA TO USE (VERBATIM)\n`;
        p += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        if (F.datiExtra) p += F.datiExtra + '\n';
        else p += `[Paste additional data in the app field]\n`;
        
        return p;
    }
}

// ==================== COMBINED PROMPT ====================
function generateCombinedPrompt(a, platform, goal, target, style, tone, lang) {
    const imgPrompt = generateImagePrompt(a, platform, goal, target, style, lang);
    const txtPrompt = generateContentPrompt(a, platform, goal, target, tone, lang);
    
    if (lang === 'en') {
        return `I need to create a complete ${pName(platform,'en')} post (image + text). Please execute both tasks below.\n\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
            `PART 1: IMAGE GENERATION\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            imgPrompt + '\n\n' +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
            `PART 2: TEXT / CAPTION\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            txtPrompt + '\n\n' +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            `IMPORTANT: The image and text must be cohesive ‚Äî same message, same emotional tone, visual and verbal elements reinforce each other. Generate both the image AND the complete, ready-to-publish caption.`;
    } else {
        return `Devo creare un post ${pName(platform,'it')} completo (immagine + testo). Esegui entrambi i task seguenti.\n\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
            `PARTE 1: GENERAZIONE IMMAGINE\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            imgPrompt + '\n\n' +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
            `PARTE 2: TESTO / CAPTION\n` +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            txtPrompt + '\n\n' +
            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
            `IMPORTANTE: Immagine e testo devono essere coerenti ‚Äî stesso messaggio, stesso tono emotivo, elementi visivi e verbali si rafforzano a vicenda. Genera sia l'immagine CHE la caption completa, pronta per la pubblicazione.`;
    }
}

// ==================== HELPER FUNCTIONS ====================
function recToImageFix(r, lang, platform) {
    const map = {
        'Contrasto': {en:'high contrast between text/CTA and background (WCAG AAA 7:1+)', it:'alto contrasto tra testo/CTA e sfondo (WCAG AAA 7:1+)'},
        'Flusso': {en:'clear visual hierarchy guiding eye to main CTA', it:'gerarchia visiva chiara che guida l\'occhio alla CTA'},
        'Complessit√†': {en:'clean composition with max 5-6 visual elements', it:'composizione pulita con max 5-6 elementi visivi'},
        'Semplicit√†': {en:'clean composition with max 5-6 visual elements', it:'composizione pulita con max 5-6 elementi visivi'},
        'Spazio': {en:'generous negative space (30-40%)', it:'ampio spazio negativo (30-40%)'},
        'Proporzioni': {en:`optimized for ${platformFormats(platform,'en')}`, it:`ottimizzato per ${platformFormats(platform,'it')}`},
        'Formato': {en:`optimized for ${platformFormats(platform,'en')}`, it:`ottimizzato per ${platformFormats(platform,'it')}`},
        'Safe': {en:'all key elements within platform safe zones', it:'elementi chiave dentro le safe zones'},
        'Palette': {en:'harmonious color palette', it:'palette colori armoniosa'},
        'Armonia': {en:'harmonious color scheme', it:'schema cromatico armonioso'},
        'Luminosit√†': {en:'balanced brightness for mobile', it:'luminosit√† bilanciata per mobile'},
        'CTA': {en:'prominent CTA with contrasting color', it:'CTA prominente con colore contrastante'},
        'Curiosit√†': {en:'curiosity-triggering visual element', it:'elemento visivo che stimola curiosit√†'}
    };
    for (const [key, val] of Object.entries(map)) {
        if (r.title.includes(key)) return val[lang];
    }
    return lang==='en' ? 'optimized visual composition' : 'composizione visiva ottimizzata';
}

function harmonyTranslate(type, lang) {
    if (lang === 'en') {
        const map = {Monocromatica:'monochromatic',Analoga:'analogous',Complementare:'complementary',Triadica:'triadic',Mista:'mixed'};
        return map[type] || type;
    }
    return type;
}

function describeColor(c, lang) {
    const h = rgbToHsl(c.r, c.g, c.b)[0];
    const s = rgbToHsl(c.r, c.g, c.b)[1];
    const l = rgbToHsl(c.r, c.g, c.b)[2];
    if (s < 10) return l > 70 ? (lang==='en'?'light/white':'chiara/bianca') : l < 30 ? (lang==='en'?'dark/black':'scura/nera') : (lang==='en'?'neutral gray':'grigio neutro');
    const hueNames = {
        en: [{max:15,name:'red'},{max:45,name:'orange'},{max:65,name:'yellow'},{max:150,name:'green'},{max:210,name:'cyan'},{max:260,name:'blue'},{max:300,name:'purple'},{max:340,name:'pink'},{max:360,name:'red'}],
        it: [{max:15,name:'rossa'},{max:45,name:'arancione'},{max:65,name:'gialla'},{max:150,name:'verde'},{max:210,name:'ciano'},{max:260,name:'blu'},{max:300,name:'viola'},{max:340,name:'rosa'},{max:360,name:'rossa'}]
    };
    for (const entry of hueNames[lang]) {
        if (h <= entry.max) return entry.name;
    }
    return lang==='en' ? 'colorful' : 'colorata';
}

function platformFormats(platform, lang) {
    const f = {
        instagram:{en:'4:5 vertical (1080√ó1350px)',it:'4:5 verticale (1080√ó1350px)'},
        tiktok:{en:'9:16 vertical (1080√ó1920px)',it:'9:16 verticale (1080√ó1920px)'},
        linkedin:{en:'1.91:1 landscape (1200√ó628px)',it:'1.91:1 orizzontale (1200√ó628px)'},
        facebook:{en:'1:1 square (1080√ó1080px)',it:'1:1 quadrato (1080√ó1080px)'},
        web:{en:'16:9 widescreen (1920√ó1080px)',it:'16:9 widescreen (1920√ó1080px)'}
    };
    return f[platform][lang];
}

function pName(platform, lang) {
    const n = {instagram:{en:'Instagram',it:'Instagram'},tiktok:{en:'TikTok/Reels',it:'TikTok/Reels'},linkedin:{en:'LinkedIn',it:'LinkedIn'},facebook:{en:'Facebook',it:'Facebook'},web:{en:'Web/Landing Page',it:'Web/Landing Page'}};
    return n[platform][lang];
}
// Keep old name for DOCX compat
function platformName(p,l) { return pName(p,l); }

// ==================== COPY FUNCTIONS ====================
function copyPrompt(which) {
    const elMap = {image:'promptTextImage', content:'promptTextContent', combined:'promptTextCombined'};
    const text = $(elMap[which]).textContent;
    copyToClipboard(text, 'Prompt copiato!');
}

function copyPromptForChatGPT(which) {
    const elMap = {image:'promptTextImage', content:'promptTextContent'};
    const base = $(elMap[which]).textContent;
    let wrapper;
    if (which === 'image') {
        wrapper = promptLang === 'en'
            ? `Generate an image using DALL-E based on this detailed prompt:\n\n---\n${base}\n---\n\nFollow all composition, color, and technical requirements strictly.`
            : `Genera un'immagine con DALL-E basandoti su questo prompt dettagliato:\n\n---\n${base}\n---\n\nSegui rigorosamente tutti i requisiti di composizione, colore e tecnici.`;
    } else {
        wrapper = promptLang === 'en'
            ? `Write a social media post based on this detailed brief:\n\n---\n${base}\n---\n\nDeliver the COMPLETE, ready-to-publish text ‚Äî not a summary of the instructions.`
            : `Scrivi un post social basandoti su questo brief dettagliato:\n\n---\n${base}\n---\n\nConsegna il testo COMPLETO, pronto da pubblicare ‚Äî non un riassunto delle istruzioni.`;
    }
    copyToClipboard(wrapper, `Prompt ${which === 'image' ? 'immagine' : 'testo'} per ChatGPT copiato!`);
}

function copyPromptForMidjourney() {
    const a = state.analysis;
    const topColors = a.palette.slice(0, 3).map(c => rgbToHex(c.r,c.g,c.b)).join(', ');
    const styleMap = {photo:'professional photography, photorealistic, studio lighting',graphic:'modern graphic design, flat design, bold typography',illustration:'digital illustration, artistic, hand-drawn',minimal:'minimalist design, white space, clean lines, elegant'};
    const goalMap = {sales:'prominent CTA, urgency, conversion-focused',awareness:'brand awareness, memorable, emotional impact',engagement:'engaging, curiosity-triggering, shareable',leads:'lead generation, clear value proposition',traffic:'attention-grabbing, click-worthy'};
    const dims = {instagram:'--ar 4:5',tiktok:'--ar 9:16',linkedin:'--ar 191:100',facebook:'--ar 1:1',web:'--ar 16:9'};
    const targetShort = state.target ? `, targeting ${state.target}` : '';
    const mj = `${pName(state.platform,'en')} social media post, ${styleMap[promptStyle]}, ${goalMap[state.goal]}${targetShort}, color palette ${topColors}, high contrast, visual hierarchy, negative space, professional ${dims[state.platform]} --v 6 --q 2`;
    copyToClipboard(mj, 'Prompt Midjourney copiato!');
}

function copyToClipboard(text, successMsg) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showCopyFeedback(successMsg)).catch(() => fallbackCopy(text, successMsg));
    } else {
        fallbackCopy(text, successMsg);
    }
}

function fallbackCopy(text, successMsg) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;opacity:0;left:-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); showCopyFeedback(successMsg); }
    catch(e) { showCopyFeedback('Errore ‚Äî seleziona e copia manualmente'); }
    document.body.removeChild(ta);
}

function showCopyFeedback(msg) {
    const existing = document.querySelector('.swa-copy-toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'swa-copy-toast';
    toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;padding:12px 24px;border-radius:14px;font-weight:700;font-size:0.9rem;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.3);animation:swa-fadeIn 0.3s ease';
    toast.innerHTML = `<i class="fas fa-check-circle" style="margin-right:8px"></i>${msg}`;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// ==================== EXPOSE PUBLIC API ====================
window.SWA = { downloadDocx, copyPrompt, copyPromptForChatGPT, copyPromptForMidjourney, setPromptLang, switchPromptTab, switchStratTab };

})();
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "SocialStrategist AI",
  "description": "Analizza i tuoi post social con metriche reali e scarica un report DOCX professionale gratuito.",
  "url": "https://apps.robertozanoni.it/social-strategist-ai.html",
  "applicationCategory": "UtilitiesApplication",
  "author": {
    "@type": "Person",
    "name": "Roberto Zanoni",
    "url": "https://robertozanoni.it"
  }
}
</script>
</body>
</html>

